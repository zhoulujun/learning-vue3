<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.41">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="https://chengpeiquan.com/favicon.ico"><meta name="keywords" content="vue 3, vue 3.x, vue 3 入门, vue 3 教程, 学习 vue 3, vue 3 案例, vue 3 教学, vue 3 好用吗"><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#3eaf7c"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png"><link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c"><meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png"><meta name="msapplication-TileColor" content="#000000"><title>全局状态的管理 | Vue3 入门指南与实战案例</title><meta name="description" content="这是一个关于 Vue 3 + TypeScript 的起步学习教程，适合完全的Vue新手和Vue 2.0的老手，在官方文档的基础上融入自己的一些实践经验。">
    <link rel="modulepreload" href="/assets/app.0c7b3152.js"><link rel="modulepreload" href="/assets/pinia.html.642f88d2.js"><link rel="modulepreload" href="/assets/pinia.html.7109bbd7.js"><link rel="prefetch" href="/assets/index.html.2f003589.js"><link rel="prefetch" href="/assets/communication.html.be61d0ec.js"><link rel="prefetch" href="/assets/component.html.3d44d9c3.js"><link rel="prefetch" href="/assets/efficient.html.a26166bb.js"><link rel="prefetch" href="/assets/guide.html.adff52ae.js"><link rel="prefetch" href="/assets/links.html.b094a747.js"><link rel="prefetch" href="/assets/plugin.html.e84e0166.js"><link rel="prefetch" href="/assets/router.html.86285e99.js"><link rel="prefetch" href="/assets/update.html.e870f97c.js"><link rel="prefetch" href="/assets/404.html.9b42cd8b.js"><link rel="prefetch" href="/assets/index.html.5f058d06.js"><link rel="prefetch" href="/assets/communication.html.19f6b2f7.js"><link rel="prefetch" href="/assets/component.html.f5307f9d.js"><link rel="prefetch" href="/assets/efficient.html.ad1f20a6.js"><link rel="prefetch" href="/assets/guide.html.90f201ac.js"><link rel="prefetch" href="/assets/links.html.62996d14.js"><link rel="prefetch" href="/assets/plugin.html.eb66815b.js"><link rel="prefetch" href="/assets/router.html.60990ba2.js"><link rel="prefetch" href="/assets/update.html.100e2c95.js"><link rel="prefetch" href="/assets/404.html.4675e898.js"><link rel="prefetch" href="/assets/404.d3026537.js"><link rel="prefetch" href="/assets/Layout.527176c4.js"><link rel="prefetch" href="/assets/GitalkComment.3ff1abe3.js"><link rel="prefetch" href="/assets/GoogleAdsense.40b4bcba.js"><link rel="prefetch" href="/assets/ImgWrap.abf53801.js">
    <link rel="stylesheet" href="/assets/style.515263ec.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><img class="logo" src="https://vue3.chengpeiquan.com/assets/img/vue3.png" alt="Vue3 入门指南与实战案例"><span class="site-name can-hide">Vue3 入门指南与实战案例</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a class="external-link" href="https://chengpeiquan.com/" rel="noopener noreferrer" target="_blank" aria-label="博客首页"><!--[--><!--]--> 博客首页 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/chengpeiquan/cooking-cookbook" rel="noopener noreferrer" target="_blank" aria-label="菜谱教程"><!--[--><!--]--> 菜谱教程 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/chengpeiquan/learning-vue3" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a class="external-link" href="https://chengpeiquan.com/" rel="noopener noreferrer" target="_blank" aria-label="博客首页"><!--[--><!--]--> 博客首页 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/chengpeiquan/cooking-cookbook" rel="noopener noreferrer" target="_blank" aria-label="菜谱教程"><!--[--><!--]--> 菜谱教程 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/chengpeiquan/learning-vue3" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/" class="sidebar-item sidebar-heading" aria-label="前言"><!--[--><!--]--> 前言 <!--[--><!--]--></a><!----></li><li><a href="/guide.html" class="sidebar-item sidebar-heading" aria-label="起步准备"><!--[--><!--]--> 起步准备 <!--[--><!--]--></a><!----></li><li><a href="/update.html" class="sidebar-item sidebar-heading" aria-label="升级与配置"><!--[--><!--]--> 升级与配置 <!--[--><!--]--></a><!----></li><li><a href="/component.html" class="sidebar-item sidebar-heading" aria-label="单组件的编写"><!--[--><!--]--> 单组件的编写 <!--[--><!--]--></a><!----></li><li><a href="/router.html" class="sidebar-item sidebar-heading" aria-label="路由的使用"><!--[--><!--]--> 路由的使用 <!--[--><!--]--></a><!----></li><li><a href="/plugin.html" class="sidebar-item sidebar-heading" aria-label="插件的使用"><!--[--><!--]--> 插件的使用 <!--[--><!--]--></a><!----></li><li><a href="/communication.html" class="sidebar-item sidebar-heading" aria-label="组件之间的通信"><!--[--><!--]--> 组件之间的通信 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/pinia.html" class="router-link-active router-link-exact-active router-link-active sidebar-item sidebar-heading active" aria-label="全局状态的管理"><!--[--><!--]--> 全局状态的管理 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/pinia.html#关于-pinia-new" class="router-link-active router-link-exact-active sidebar-item" aria-label="关于 Pinia{new}"><!--[--><!--]--> 关于 Pinia{new} <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/pinia.html#安装和启用-new" class="router-link-active router-link-exact-active sidebar-item" aria-label="安装和启用{new}"><!--[--><!--]--> 安装和启用{new} <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/pinia.html#状态树的结构-new" class="router-link-active router-link-exact-active sidebar-item" aria-label="状态树的结构{new}"><!--[--><!--]--> 状态树的结构{new} <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/pinia.html#创建-store-new" class="router-link-active router-link-exact-active sidebar-item" aria-label="创建 Store{new}"><!--[--><!--]--> 创建 Store{new} <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/pinia.html#形式-1-接收两个参数" class="router-link-active router-link-exact-active sidebar-item" aria-label="形式 1 ：接收两个参数"><!--[--><!--]--> 形式 1 ：接收两个参数 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/pinia.html#形式-2-接收一个参数" class="router-link-active router-link-exact-active sidebar-item" aria-label="形式 2 ：接收一个参数"><!--[--><!--]--> 形式 2 ：接收一个参数 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/pinia.html#管理-state-new" class="router-link-active router-link-exact-active sidebar-item" aria-label="管理 state{new}"><!--[--><!--]--> 管理 state{new} <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/pinia.html#给-store-添加-state" class="router-link-active router-link-exact-active sidebar-item" aria-label="给 Store 添加 state"><!--[--><!--]--> 给 Store 添加 state <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/pinia.html#手动指定数据类型" class="router-link-active router-link-exact-active sidebar-item" aria-label="手动指定数据类型"><!--[--><!--]--> 手动指定数据类型 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/pinia.html#获取和更新-state" class="router-link-active router-link-exact-active sidebar-item" aria-label="获取和更新 state"><!--[--><!--]--> 获取和更新 state <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/pinia.html#使用-store-实例" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用 store 实例"><!--[--><!--]--> 使用 store 实例 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/pinia.html#使用-computed-api" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用 computed API"><!--[--><!--]--> 使用 computed API <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/pinia.html#使用-storetorefs-api" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用 storeToRefs API"><!--[--><!--]--> 使用 storeToRefs API <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/pinia.html#使用-torefs-api" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用 toRefs API"><!--[--><!--]--> 使用 toRefs API <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/pinia.html#使用-toref-api" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用 toRef API"><!--[--><!--]--> 使用 toRef API <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/pinia.html#使用-actions-方法" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用 actions 方法"><!--[--><!--]--> 使用 actions 方法 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/pinia.html#批量更新-state" class="router-link-active router-link-exact-active sidebar-item" aria-label="批量更新 state"><!--[--><!--]--> 批量更新 state <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/pinia.html#传入一个对象" class="router-link-active router-link-exact-active sidebar-item" aria-label="传入一个对象"><!--[--><!--]--> 传入一个对象 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/pinia.html#传入一个函数" class="router-link-active router-link-exact-active sidebar-item" aria-label="传入一个函数"><!--[--><!--]--> 传入一个函数 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/pinia.html#全量更新-state" class="router-link-active router-link-exact-active sidebar-item" aria-label="全量更新 state"><!--[--><!--]--> 全量更新 state <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/pinia.html#重置-state" class="router-link-active router-link-exact-active sidebar-item" aria-label="重置 state"><!--[--><!--]--> 重置 state <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/pinia.html#订阅-state" class="router-link-active router-link-exact-active sidebar-item" aria-label="订阅 state"><!--[--><!--]--> 订阅 state <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/pinia.html#订阅-api-的-ts-类型" class="router-link-active router-link-exact-active sidebar-item" aria-label="订阅 API 的 TS 类型"><!--[--><!--]--> 订阅 API 的 TS 类型 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/pinia.html#添加订阅" class="router-link-active router-link-exact-active sidebar-item" aria-label="添加订阅"><!--[--><!--]--> 添加订阅 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/pinia.html#移除订阅" class="router-link-active router-link-exact-active sidebar-item" aria-label="移除订阅"><!--[--><!--]--> 移除订阅 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/pinia.html#管理-getters-new" class="router-link-active router-link-exact-active sidebar-item" aria-label="管理 getters{new}"><!--[--><!--]--> 管理 getters{new} <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/pinia.html#给-store-添加-getter" class="router-link-active router-link-exact-active sidebar-item" aria-label="给 Store 添加 getter"><!--[--><!--]--> 给 Store 添加 getter <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/pinia.html#添加普通的-getter" class="router-link-active router-link-exact-active sidebar-item" aria-label="添加普通的 getter"><!--[--><!--]--> 添加普通的 getter <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/pinia.html#添加引用-getter-的-getter" class="router-link-active router-link-exact-active sidebar-item" aria-label="添加引用 getter 的 getter"><!--[--><!--]--> 添加引用 getter 的 getter <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/pinia.html#给-getter-传递参数" class="router-link-active router-link-exact-active sidebar-item" aria-label="给 getter 传递参数"><!--[--><!--]--> 给 getter 传递参数 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/pinia.html#获取和更新-getter" class="router-link-active router-link-exact-active sidebar-item" aria-label="获取和更新 getter"><!--[--><!--]--> 获取和更新 getter <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/pinia.html#管理-actions-new" class="router-link-active router-link-exact-active sidebar-item" aria-label="管理 actions{new}"><!--[--><!--]--> 管理 actions{new} <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/pinia.html#给-store-添加-action" class="router-link-active router-link-exact-active sidebar-item" aria-label="给 Store 添加 action"><!--[--><!--]--> 给 Store 添加 action <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/pinia.html#调用-action" class="router-link-active router-link-exact-active sidebar-item" aria-label="调用 action"><!--[--><!--]--> 调用 action <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/pinia.html#添加多个-store-new" class="router-link-active router-link-exact-active sidebar-item" aria-label="添加多个 Store{new}"><!--[--><!--]--> 添加多个 Store{new} <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/pinia.html#目录结构建议" class="router-link-active router-link-exact-active sidebar-item" aria-label="目录结构建议"><!--[--><!--]--> 目录结构建议 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/pinia.html#在-vue-组件-ts-文件里使用" class="router-link-active router-link-exact-active sidebar-item" aria-label="在 Vue 组件 / TS 文件里使用"><!--[--><!--]--> 在 Vue 组件 / TS 文件里使用 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/pinia.html#store-之间互相引用" class="router-link-active router-link-exact-active sidebar-item" aria-label="Store 之间互相引用"><!--[--><!--]--> Store 之间互相引用 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/pinia.html#专属插件的使用-new" class="router-link-active router-link-exact-active sidebar-item" aria-label="专属插件的使用{new}"><!--[--><!--]--> 专属插件的使用{new} <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/pinia.html#如何查找插件" class="router-link-active router-link-exact-active sidebar-item" aria-label="如何查找插件"><!--[--><!--]--> 如何查找插件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/pinia.html#如何使用插件" class="router-link-active router-link-exact-active sidebar-item" aria-label="如何使用插件"><!--[--><!--]--> 如何使用插件 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/pinia.html#使用前" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用前"><!--[--><!--]--> 使用前 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/pinia.html#使用后" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用后"><!--[--><!--]--> 使用后 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/pinia.html#本章结语" class="router-link-active router-link-exact-active sidebar-item" aria-label="本章结语"><!--[--><!--]--> 本章结语 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/efficient.html" class="sidebar-item sidebar-heading" aria-label="高效开发"><!--[--><!--]--> 高效开发 <!--[--><!--]--></a><!----></li><li><a href="/links.html" class="sidebar-item sidebar-heading" aria-label="拓展阅读"><!--[--><!--]--> 拓展阅读 <!--[--><!--]--></a><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="全局状态的管理" tabindex="-1"><a class="header-anchor" href="#全局状态的管理" aria-hidden="true">#</a> 全局状态的管理</h1><p>本来这部分打算放在 <a href="/communication.html#vuex-new" class="">组件之间的通信</a> 里，里面也简单介绍了一下 Vuex ，但 Pinia 作为被官方推荐在 Vue 3 项目里作为全局状态管理的新工具，写着写着我觉得还是单独开一章来写会更方便阅读和理解。</p><p>官方推出的全局状态管理工具目前有 <a href="https://vuex.vuejs.org/zh/" target="_blank" rel="noopener noreferrer">Vuex<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 和 <a href="https://pinia.vuejs.org/" target="_blank" rel="noopener noreferrer">Pinia<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ，两者的作用和用法都比较相似，但 Pinia 的设计更贴近 Vue 3 组合式 API 的用法。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>本章内的大部分内容都会和 Vuex 作对比，方便从 Vuex 项目向 Pinia 的迁移。</p></div><h2 id="关于-pinia-new" tabindex="-1"><a class="header-anchor" href="#关于-pinia-new" aria-hidden="true">#</a> 关于 Pinia{new}</h2><p>由于 Vuex 4.x 版本只是个过渡版，Vuex 4 对 TypeScript 和 Composition API 都不是很友好，虽然官方团队在 GitHub 已有讨论 <a href="https://github.com/vuejs/rfcs/discussions/270" target="_blank" rel="noopener noreferrer">Vuex 5<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 的开发提案，但从 2022-02-07 在 Vue 3 被设置为默认版本开始， Pinia 已正式被官方推荐作为全局状态管理的工具。</p><p>Pinia 支持 Vue 3 和 Vue 2 ，对 TypeScript 也有很完好的支持，延续本指南的宗旨，我们在这里只介绍基于 Vue 3 和 TypeScript 的用法。</p><p>点击访问：<a href="https://pinia.vuejs.org/" target="_blank" rel="noopener noreferrer">Pinia 官网<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h2 id="安装和启用-new" tabindex="-1"><a class="header-anchor" href="#安装和启用-new" aria-hidden="true">#</a> 安装和启用{new}</h2><p>Pinia 目前还没有被广泛的默认集成在各种脚手架里，所以如果你原来创建的项目没有 Pinia ，则需要手动安装它。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 需要 cd 到你的项目目录下</span>
<span class="token function">npm</span> <span class="token function">install</span> pinia
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>查看你的 package.json ，看看里面的 <code>dependencies</code> 是否成功加入了 Pinia 和它的版本号（下方是示例代码，以实际安装的最新版本号为准）：</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;pinia&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.0.11&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然后打开 <code>src/main.ts</code> 文件，添加下面那两行有注释的新代码：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createPinia <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;pinia&#39;</span> <span class="token comment">// 导入 Pinia</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">&#39;@/App.vue&#39;</span>

<span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">createPinia</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 启用 Pinia</span>
  <span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>到这里， Pinia 就集成到你的项目里了。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>也可以通过 <a href="/update.html#create-preset" class="">Create Preset</a> 创建新项目（选择 <code>vue</code> 技术栈进入，选择 <a href="https://github.com/awesome-starter/vue3-ts-vite-starter" target="_blank" rel="noopener noreferrer">vue3-ts-vite<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 模板），可以得到一个集成常用配置的项目启动模板，该模板现在使用 Pinia 作为全局状态管理工具。</p></div><h2 id="状态树的结构-new" tabindex="-1"><a class="header-anchor" href="#状态树的结构-new" aria-hidden="true">#</a> 状态树的结构{new}</h2><p>在开始写代码之前，我们先来看一个对比，直观的了解 Pinia 的状态树构成，才能在后面的环节更好的理解每个功能的用途。</p><p>鉴于可能有部分同学之前没有用过 Vuex ，所以我加入了 Vue 组件一起对比（ Options API 写法）。</p><table><thead><tr><th style="text-align:center;">作用</th><th style="text-align:center;">Vue Component</th><th style="text-align:center;">Vuex</th><th style="text-align:center;">Pinia</th></tr></thead><tbody><tr><td style="text-align:center;">数据管理</td><td style="text-align:center;">data</td><td style="text-align:center;">state</td><td style="text-align:center;">state</td></tr><tr><td style="text-align:center;">数据计算</td><td style="text-align:center;">computed</td><td style="text-align:center;">getters</td><td style="text-align:center;">getters</td></tr><tr><td style="text-align:center;">行为方法</td><td style="text-align:center;">methods</td><td style="text-align:center;">mutations / actions</td><td style="text-align:center;">actions</td></tr></tbody></table><p>可以看到 Pinia 的结构和用途都和 Vuex 与 Component 非常相似，并且 Pinia 相对于 Vuex ，在行为方法部分去掉了 mutations （同步操作）和 actions （异步操作）的区分，更接近组件的结构，入门成本会更低一些。</p><p>下面我们来创建一个简单的 Store ，开始用 Pinia 来进行状态管理。</p><h2 id="创建-store-new" tabindex="-1"><a class="header-anchor" href="#创建-store-new" aria-hidden="true">#</a> 创建 Store{new}</h2><p>和 Vuex 一样， Pinia 的核心也是称之为 Store 。</p><p>参照 Pinia 官网推荐的项目管理方案，我们也是先在 <code>src</code> 文件夹下创建一个 <code>stores</code> 文件夹，并在里面添加一个 <code>index.ts</code> 文件，然后我们就可以来添加一个最基础的 Store 。</p><p>Store 是通过 <code>defineStore</code> 方法来创建的，它有两种入参形式：</p><h3 id="形式-1-接收两个参数" tabindex="-1"><a class="header-anchor" href="#形式-1-接收两个参数" aria-hidden="true">#</a> 形式 1 ：接收两个参数</h3><p>接收两个参数，第一个参数是 Store 的唯一 ID ，第二个参数是 Store 的选项：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// src/stores/index.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;pinia&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> useStore <span class="token operator">=</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token string">&#39;main&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// Store 选项...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="形式-2-接收一个参数" tabindex="-1"><a class="header-anchor" href="#形式-2-接收一个参数" aria-hidden="true">#</a> 形式 2 ：接收一个参数</h3><p>接收一个参数，直接传入 Store 的选项，但是需要把唯一 ID 作为选项的一部分一起传入：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// src/stores/index.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;pinia&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> useStore <span class="token operator">=</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token string">&#39;main&#39;</span><span class="token punctuation">,</span>
  <span class="token comment">// Store 选项...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>不论是哪种创建形式，都必须为 Store 指定一个唯一 ID 。</p></div><p>另外可以看到我把导出的函数名命名为 <code>useStore</code> ，以 <code>use</code> 开头是 Vue 3 对可组合函数的一个命名规范。</p><p>并且使用的是 <code>export const</code> 而不是 <code>export default</code> （详见：<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/export" target="_blank" rel="noopener noreferrer">命名导出和默认导出<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>），这样在使用的时候可以和其他的 Vue 组合函数保持一致，都是通过 <code>import { xxx } from &#39;xxx&#39;</code> 来导入。</p><p>如果你有多个 Store ，可以分模块管理，并根据实际的功能用途进行命名（ e.g. <code>useMessageStore</code> 、 <code>useUserStore</code> 、 <code>useGameStore</code> … ）。</p><h2 id="管理-state-new" tabindex="-1"><a class="header-anchor" href="#管理-state-new" aria-hidden="true">#</a> 管理 state{new}</h2><p>在上一小节的 <a href="#%E7%8A%B6%E6%80%81%E6%A0%91%E7%9A%84%E7%BB%93%E6%9E%84-new">状态树的结构</a> 这里我们已经了解过， Pinia 是在 <code>state</code> 里面定义状态数据。</p><h3 id="给-store-添加-state" tabindex="-1"><a class="header-anchor" href="#给-store-添加-state" aria-hidden="true">#</a> 给 Store 添加 state</h3><p>它是通过一个箭头函数的形式来返回数据，并且能够正确的帮你推导 TypeScript 类型：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// src/stores/index.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;pinia&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> useStore <span class="token operator">=</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token string">&#39;main&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// 我们先定义一个最基本的 message 数据</span>
  <span class="token function-variable function">state</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    message<span class="token operator">:</span> <span class="token string">&#39;Hello World&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>需要注意一点的是，如果不显式 return ，箭头函数的返回值需要用圆括号 <code>()</code> 套起来，这个是箭头函数的要求（详见：<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Functions/Arrow_functions#%E8%BF%94%E5%9B%9E%E5%AF%B9%E8%B1%A1%E5%AD%97%E9%9D%A2%E9%87%8F" target="_blank" rel="noopener noreferrer">返回对象字面量<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>）。</p><p>所以相当于这样写：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// ...</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> useStore <span class="token operator">=</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token string">&#39;main&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">state</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      message<span class="token operator">:</span> <span class="token string">&#39;Hello World&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>我个人还是更喜欢加圆括号的简写方式。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>可能有同学会问： Vuex 可以用一个对象来定义 state 的数据， Pinia 可以吗？</p><p>答案是：不可以！ state 的类型必须是 <code>state?: (() =&gt; {}) | undefined</code> ，要么不配置（就是 undefined ），要么只能是个箭头函数。</p></div><h3 id="手动指定数据类型" tabindex="-1"><a class="header-anchor" href="#手动指定数据类型" aria-hidden="true">#</a> 手动指定数据类型</h3><p>虽然 Pinia 会帮你推导 TypeScript 的数据类型，但有时候可能不太够用，比如下面这段代码，请留意代码注释的说明：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// ...</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> useStore <span class="token operator">=</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token string">&#39;main&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">state</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      message<span class="token operator">:</span> <span class="token string">&#39;Hello World&#39;</span><span class="token punctuation">,</span>
      <span class="token comment">// 添加了一个随机消息数组</span>
      randomMessages<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>你的预期应该是一个字符串数组 <code>string[]</code> ，但是这个时候 Pinia 会帮你推导成 <code>never[]</code> ，那么类型就对不上了。</p><p>这种情况下你就需要手动指定 randomMessages 的类型，可以通过 <code>as</code> 来指定：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// ...</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> useStore <span class="token operator">=</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token string">&#39;main&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">state</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      message<span class="token operator">:</span> <span class="token string">&#39;Hello World&#39;</span><span class="token punctuation">,</span>
      <span class="token comment">// 通过 as 关键字指定 TS 类型</span>
      randomMessages<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>或者使用尖括号 <code>&lt;&gt;</code> 来指定：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// ...</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> useStore <span class="token operator">=</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token string">&#39;main&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">state</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      message<span class="token operator">:</span> <span class="token string">&#39;Hello World&#39;</span><span class="token punctuation">,</span>
      <span class="token comment">// 通过尖括号指定 TS 类型</span>
      randomMessages<span class="token operator">:</span> <span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这两种方式是等价的。</p><h3 id="获取和更新-state" tabindex="-1"><a class="header-anchor" href="#获取和更新-state" aria-hidden="true">#</a> 获取和更新 state</h3><p>获取 state 有多种方法，略微有区别（详见下方各自的说明），但相同的是，他们都是响应性的。</p><div class="custom-container warning"><p class="custom-container-title">WARNING</p><p>不能直接通过 ES6 解构的方式（ e.g. <code>const { message } = store</code> ），那样会破坏数据的响应性。</p></div><h4 id="使用-store-实例" tabindex="-1"><a class="header-anchor" href="#使用-store-实例" aria-hidden="true">#</a> 使用 store 实例</h4><p>用法上和 Vuex 很相似，但有一点区别是，数据直接是挂在 <code>store</code> 上的，而不是 <code>store.state</code> 上面！</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>e.g. Vuex 是 <code>store.state.message</code> ， Pinia 是 <code>store.message</code> 。</p></div><p>所以，你可以直接通过 <code>store.message</code> 直接调用 state 里的数据。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/stores&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 像 useRouter 那样定义一个变量拿到实例</span>
    <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">useStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 直接通过实例来获取数据</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>message<span class="token punctuation">)</span>

    <span class="token comment">// 这种方式你需要把整个 store 给到 template 去渲染数据</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      store<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>但一些比较复杂的数据这样写会很长，所以有时候更推荐用下面介绍的 <a href="#%E4%BD%BF%E7%94%A8-computed-api">computed API</a> 和 <a href="#%E4%BD%BF%E7%94%A8-storetorefs-api">storeToRefs API</a> 等方式来获取。</p><p>在数据更新方面，在 Pinia 可以直接通过 Store 实例更新 state （这一点与 Vuex 有明显的不同，<a href="https://vuex.vuejs.org/zh/guide/mutations.html" target="_blank" rel="noopener noreferrer">更改 Vuex 的 store 中的状态的唯一方法是提交 mutation<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>），所以如果你要更新 <code>message</code> ，只需要像下面这样，就可以更新 <code>message</code> 的值了！</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code>store<span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token string">&#39;New Message.&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="使用-computed-api" tabindex="-1"><a class="header-anchor" href="#使用-computed-api" aria-hidden="true">#</a> 使用 computed API</h4><p>现在 state 里已经有我们定义好的数据了，下面这段代码是在 Vue 组件里导入我们的 Store ，并通过计算数据 <code>computed</code> 拿到里面的 <code>message</code> 数据传给 template 使用。</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> computed<span class="token punctuation">,</span> defineComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/stores&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 像 useRouter 那样定义一个变量拿到实例</span>
    <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">useStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 通过计算拿到里面的数据</span>
    <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> store<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;message&#39;</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

    <span class="token comment">// 传给 template 使用</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      message<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>和 <a href="#%E4%BD%BF%E7%94%A8-store-%E5%AE%9E%E4%BE%8B">使用 store 实例</a> 以及 <a href="#%E4%BD%BF%E7%94%A8-storetorefs-api">使用 storeToRefs API</a> 不同，这个方式默认情况下无法直接更新 state 的值。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>这里的定义的 <code>message</code> 变量是一个只有 getter ，没有 setter 的 <a href="/component.html#%E7%B1%BB%E5%9E%8B%E5%AE%9A%E4%B9%89" class="">ComputedRef</a> 数据，所以它是只读的。</p></div><p>如果你要更新数据怎么办？</p><ol><li><p>可以通过提前定义好的 Store Actions 方法进行更新。</p></li><li><p>在定义 computed 变量的时候，配置好 <a href="/component.html#setter-%E7%9A%84%E4%BD%BF%E7%94%A8" class="">setter</a> 的行为：</p></li></ol><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 其他代码和上一个例子一样，这里省略...</span>

<span class="token comment">// 修改：定义 computed 变量的时候配置 getter 和 setter</span>
<span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// getter 还是返回数据的值</span>
  <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> store<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
  <span class="token comment">// 配置 setter 来定义赋值后的行为</span>
  <span class="token function">set</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    store<span class="token punctuation">.</span>message <span class="token operator">=</span> newVal
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 此时不再抛出 Write operation failed: computed value is readonly 的警告</span>
message<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">&#39;New Message.&#39;</span>

<span class="token comment">// store 上的数据已成功变成了 New Message.</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h4 id="使用-storetorefs-api" tabindex="-1"><a class="header-anchor" href="#使用-storetorefs-api" aria-hidden="true">#</a> 使用 storeToRefs API</h4><p>Pinia 还提供了一个 <code>storeToRefs</code> API 用于把 state 的数据转换为 <code>ref</code> 变量。</p><p>这是一个专门为 Pinia Stores 设计的 API ，类似于 <a href="/component.html#%E5%93%8D%E5%BA%94%E5%BC%8F-api-%E4%B9%8B-toref-%E4%B8%8E-torefs-new" class="">toRefs</a> ，区别在于，它会忽略掉 Store 上面的方法和非响应性的数据，只返回 state 上的响应性数据。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/stores&#39;</span>

<span class="token comment">// 记得导入这个 API</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> storeToRefs <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;pinia&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">useStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 通过 storeToRefs 来拿到响应性的 message</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> message <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">storeToRefs</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;message&#39;</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      message<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>通过这个方式拿到的 <code>message</code> 变量是一个 <a href="/component.html#%E5%93%8D%E5%BA%94%E5%BC%8F-api-%E4%B9%8B-ref-new" class="">Ref</a> 类型的数据，所以你可以像普通的 ref 变量一样进行读取和赋值。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 直接赋值即可</span>
message<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">&#39;New Message.&#39;</span>

<span class="token comment">// store 上的数据已成功变成了 New Message.</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="使用-torefs-api" tabindex="-1"><a class="header-anchor" href="#使用-torefs-api" aria-hidden="true">#</a> 使用 toRefs API</h4><p>如 <a href="#%E4%BD%BF%E7%94%A8-storetorefs-api">使用 storeToRefs API</a> 部分所说，该 API 本身的设计就是类似于 <a href="/component.html#%E5%93%8D%E5%BA%94%E5%BC%8F-api-%E4%B9%8B-toref-%E4%B8%8E-torefs-new" class="">toRefs</a> ，所以你也可以直接用 toRefs 把 state 上的数据转成 ref 变量。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 注意 toRefs 是 vue 的 API ，不是 Pinia</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> toRefs <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/stores&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">useStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 跟 storeToRefs 操作都一样，只不过用 Vue 的这个 API 来处理</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> message <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">toRefs</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;message&#39;</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      message<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>详见 <a href="/component.html#%E4%BD%BF%E7%94%A8-torefs" class="">使用 toRefs</a> 一节的说明，可以像普通的 ref 变量一样进行读取和赋值。</p><p>另外，像上面这样，对 store 执行 toRefs 会把 store 上面的 getters 、 actions 也一起提取，如果你只需要提取 state 上的数据，可以这样做：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 只传入 store.$state</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> message <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">toRefs</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>$state<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="使用-toref-api" tabindex="-1"><a class="header-anchor" href="#使用-toref-api" aria-hidden="true">#</a> 使用 toRef API</h4><p>toRef 是 toRefs 的兄弟 API ，一个是只转换一个字段，一个是转换所有字段，所以它也可以用来转换 state 数据变成 ref 变量。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 注意 toRef 是 vue 的 API ，不是 Pinia</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> toRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/stores&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">useStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 遵循 toRef 的用法即可</span>
    <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token function">toRef</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> <span class="token string">&#39;message&#39;</span><span class="token punctuation">)</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;message&#39;</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      message<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>详见 <a href="/component.html#%E4%BD%BF%E7%94%A8-toref" class="">使用 toRef</a> 一节的说明，可以像普通的 ref 变量一样进行读取和赋值。</p><h4 id="使用-actions-方法" tabindex="-1"><a class="header-anchor" href="#使用-actions-方法" aria-hidden="true">#</a> 使用 actions 方法</h4><p>在 Vuex ，如果想通过方法来操作 state 的更新，必须通过 mutation 来提交；而异步操作需要更多一个步骤，必须先通过 action 来触发 mutation ，非常繁琐！</p><p>Pinia 所有操作都集合为 action ，无需区分同步和异步，按照平时的函数定义即可更新 state ，具体操作详见 <a href="#%E7%AE%A1%E7%90%86-actions-new">管理 actions</a> 一节。</p><h3 id="批量更新-state" tabindex="-1"><a class="header-anchor" href="#批量更新-state" aria-hidden="true">#</a> 批量更新 state</h3><p>在 <a href="#%E8%8E%B7%E5%8F%96%E5%92%8C%E6%9B%B4%E6%96%B0-state">获取和更新 state</a> 部分说的都是如何修改单个 state 数据，那么有时候要同时修改很多个，会显得比较繁琐。</p><p>如果你写过 React 或者微信小程序，应该非常熟悉这些用法：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 下面不是 Vue 的代码，不要在你的项目里使用</span>

<span class="token comment">// React</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  foo<span class="token operator">:</span> <span class="token string">&#39;New Foo Value&#39;</span><span class="token punctuation">,</span>
  bar<span class="token operator">:</span> <span class="token string">&#39;New bar Value&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 微信小程序</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  foo<span class="token operator">:</span> <span class="token string">&#39;New Foo Value&#39;</span><span class="token punctuation">,</span>
  bar<span class="token operator">:</span> <span class="token string">&#39;New bar Value&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>Pinia 也提供了一个 <code>$patch</code> API 用于同时修改多个数据，它接收一个参数：</p><table><thead><tr><th style="text-align:center;">参数</th><th style="text-align:center;">类型</th><th style="text-align:center;">语法</th></tr></thead><tbody><tr><td style="text-align:center;">partialState</td><td style="text-align:center;">对象 / 函数</td><td style="text-align:center;">store.$patch(partialState)</td></tr></tbody></table><h4 id="传入一个对象" tabindex="-1"><a class="header-anchor" href="#传入一个对象" aria-hidden="true">#</a> 传入一个对象</h4><p>当参数类型为对象时，<code>key</code> 是要修改的 state 数据名称， <code>value</code> 是新的值（支持嵌套传值），用法如下：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 继续用我们前面的数据，这里会打印出修改前的值</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>$state<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 输出 {&quot;message&quot;:&quot;Hello World&quot;,&quot;randomMessages&quot;:[]}</span>

<span class="token doc-comment comment">/**
 * 注意这里，传入了一个对象
 */</span>
store<span class="token punctuation">.</span><span class="token function">$patch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  message<span class="token operator">:</span> <span class="token string">&#39;New Message&#39;</span><span class="token punctuation">,</span>
  randomMessages<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;msg1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;msg2&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;msg3&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 这里会打印出修改后的值</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>$state<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 输出 {&quot;message&quot;:&quot;New Message&quot;,&quot;randomMessages&quot;:[&quot;msg1&quot;,&quot;msg2&quot;,&quot;msg3&quot;]}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>对于简单的数据，直接修改成新值是非常好用的。</p><p>但有时候并不单单只是修改，而是要对数据进行拼接、补充、合并等操作，相对而言开销就会很大，这种情况下，更适合 <a href="#%E4%BC%A0%E5%85%A5%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0">传入一个函数</a> 来处理。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>使用这个方式时， <code>key</code> 只允许是实例上已有的数据，不可以提交未定义的数据进去。</p><p>强制提交的话，在 TypeScript 会抛出错误， JavaScript 虽然不会报错，但实际上， Store 实例上面依然不会有这个新增的非法数据。</p></div><h4 id="传入一个函数" tabindex="-1"><a class="header-anchor" href="#传入一个函数" aria-hidden="true">#</a> 传入一个函数</h4><p>当参数类型为函数时，该函数会有一个入参 <code>state</code> ，是当前实例的 state ，等价于 store.$state ，用法如下：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 这里会打印出修改前的值</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>$state<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 输出 {&quot;message&quot;:&quot;Hello World&quot;,&quot;randomMessages&quot;:[]}</span>

<span class="token doc-comment comment">/**
 * 注意这里，这次是传入了一个函数
 */</span>
store<span class="token punctuation">.</span><span class="token function">$patch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  state<span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token string">&#39;New Message&#39;</span>

  <span class="token comment">// 数组改成用追加的方式，而不是重新赋值</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    state<span class="token punctuation">.</span>randomMessages<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">msg</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 这里会打印出修改后的值</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>$state<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 输出 {&quot;message&quot;:&quot;New Message&quot;,&quot;randomMessages&quot;:[&quot;msg1&quot;,&quot;msg2&quot;,&quot;msg3&quot;]}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>和 <a href="#%E4%BC%A0%E5%85%A5%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1">传入一个对象</a> 比，不一定说就是哪种方式更好，通常要结合业务场景合理使用。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>使用这个方式时，和 <a href="#%E4%BC%A0%E5%85%A5%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1">传入一个对象</a> 一样只能修改已定义的数据，并且另外需要注意，传进去的函数只能是同步函数，不可以是异步函数！</p><p>如果还不清楚什么是同步和异步，可以阅读 <a href="https://developer.mozilla.org/zh-CN/docs/Learn/JavaScript/Asynchronous/Introducing" target="_blank" rel="noopener noreferrer">同步和异步 JavaScript - MDN<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 一文。</p></div><h3 id="全量更新-state" tabindex="-1"><a class="header-anchor" href="#全量更新-state" aria-hidden="true">#</a> 全量更新 state</h3><p>在 <a href="#%E6%89%B9%E9%87%8F%E6%9B%B4%E6%96%B0-state">批量更新 state</a> 我们了解到可以用 <code>store.$patch</code> 方法对数据进行批量更新操作，不过如其命名，这种方式本质上是一种 “补丁更新” 。</p><p>虽然你可以对所有数据都执行一次 “补丁更新” 来达到 “全量更新” 的目的，但 Pinia 也提供了一个更好的办法。</p><p>从前面多次提到 state 数据可以通过 <code>store.$state</code> 来拿到，而这个属性本身是可以直接赋值的。</p><p>还是继续用上面的例子， state 上现在有 <code>message</code> 和 <code>randomMessages</code> 这两个数据，那么要全量更新为新的值，就这么操作：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code>store<span class="token punctuation">.</span>$state <span class="token operator">=</span> <span class="token punctuation">{</span>
  message<span class="token operator">:</span> <span class="token string">&#39;New Message&#39;</span><span class="token punctuation">,</span>
  randomMessages<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;msg1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;msg2&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;msg3&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>同样的，必须遵循 state 原有的数据和对应的类型。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>该操作不会使 state 失去响应性。</p></div><h3 id="重置-state" tabindex="-1"><a class="header-anchor" href="#重置-state" aria-hidden="true">#</a> 重置 state</h3><p>Pinia 提供了一个 <code>$reset</code> API 挂在每个实例上面，用于重置整颗 state 树为初始数据：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 这个 store 是我们上面定义好的实例</span>
store<span class="token punctuation">.</span><span class="token function">$reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>具体例子：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 修改数据</span>
store<span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token string">&#39;New Message&#39;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>message<span class="token punctuation">)</span>  <span class="token comment">// 输出 New Message</span>

<span class="token comment">// 3s 后重置状态</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span><span class="token function">$reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>message<span class="token punctuation">)</span>  <span class="token comment">// 输出最开始的 Hello World</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="订阅-state" tabindex="-1"><a class="header-anchor" href="#订阅-state" aria-hidden="true">#</a> 订阅 state</h3><p>和 Vuex 一样， Pinia 也提供了一个用于订阅 state 的 <code>$subscribe</code> API 。</p><h4 id="订阅-api-的-ts-类型" tabindex="-1"><a class="header-anchor" href="#订阅-api-的-ts-类型" aria-hidden="true">#</a> 订阅 API 的 TS 类型</h4><p>在了解这个 API 的使用之前，先看一下它的 TS 类型定义：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// $subscribe 部分的 TS 类型</span>
<span class="token comment">// ...</span>
<span class="token function">$subscribe</span><span class="token punctuation">(</span>
  callback<span class="token operator">:</span> SubscriptionCallback<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  options<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">{</span> detached<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">}</span> <span class="token operator">&amp;</span> WatchOptions
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>可以看到，它可以接受两个参数：</p><ol><li>第一个入参是 callback 函数，必传</li><li>第二个入参是一些选项，可选</li></ol><p>它还会返回一个函数，执行它可以用于移除当前订阅（源码有注释，这里我先省略，放在下面讲），下面来看看具体用法。</p><h4 id="添加订阅" tabindex="-1"><a class="header-anchor" href="#添加订阅" aria-hidden="true">#</a> 添加订阅</h4><p><code>$subscribe</code> API 的功能类似于 <a href="/component.html#watch" class="">watch</a> ，但它只会在 state 被更新的时候才触发一次，并且在组件被卸载时删除（参考：<a href="/component.html#%E7%BB%84%E4%BB%B6%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F-new" class="">组件的生命周期</a>）。</p><p>从 <a href="#%E8%AE%A2%E9%98%85-api-%E7%9A%84-ts-%E7%B1%BB%E5%9E%8B">订阅 API 的 TS 类型</a> 可以看到，它可以接受两个参数，第一个参数是必传的 callback 函数，一般情况下默认用这个方式即可，使用例子：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 你可以在 state 出现变化时，更新本地持久化存储的数据</span>
store<span class="token punctuation">.</span><span class="token function">$subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mutation<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">&#39;store&#39;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这个 callback 里面有 2 个入参：</p><table><thead><tr><th style="text-align:center;">入参</th><th style="text-align:center;">作用</th></tr></thead><tbody><tr><td style="text-align:center;">mutation</td><td style="text-align:center;">本次事件的一些信息</td></tr><tr><td style="text-align:center;">state</td><td style="text-align:center;">当前实例的 state</td></tr></tbody></table><p>其中 mutation 包含了以下数据：</p><table><thead><tr><th style="text-align:center;">字段</th><th style="text-align:left;">值</th></tr></thead><tbody><tr><td style="text-align:center;">storeId</td><td style="text-align:left;">发布本次订阅通知的 Pinia 实例的唯一 ID（由 <a href="#%E5%88%9B%E5%BB%BA-store-new">创建 Store</a> 时指定）</td></tr><tr><td style="text-align:center;">type</td><td style="text-align:left;">有 3 个值：返回 <code>direct</code> 代表 <a href="#%E8%8E%B7%E5%8F%96%E5%92%8C%E6%9B%B4%E6%96%B0-state">直接更改</a> 数据；返回 <code>patch object</code> 代表是通过 <a href="#%E4%BC%A0%E5%85%A5%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1">传入一个对象</a> 更改；返回 <code>patch function</code> 则代表是通过 <a href="#%E4%BC%A0%E5%85%A5%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0">传入一个函数</a> 更改</td></tr><tr><td style="text-align:center;">events</td><td style="text-align:left;">触发本次订阅通知的事件列表</td></tr><tr><td style="text-align:center;">payload</td><td style="text-align:left;">通过 <a href="#%E4%BC%A0%E5%85%A5%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0">传入一个函数</a> 更改时，传递进来的荷载信息，只有 <code>type</code> 为 <code>patch object</code> 时才有</td></tr></tbody></table><p>如果你不希望组件被卸载时删除订阅，可以传递第二个参数 options 用以保留订阅状态，传入一个对象。</p><p>可以简单指定为 <code>{ detached: true }</code> ：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code>store<span class="token punctuation">.</span><span class="token function">$subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mutation<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> detached<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>也可以搭配 watch API 的选项一起用。</p><h4 id="移除订阅" tabindex="-1"><a class="header-anchor" href="#移除订阅" aria-hidden="true">#</a> 移除订阅</h4><p>在 <a href="#%E6%B7%BB%E5%8A%A0%E8%AE%A2%E9%98%85">添加订阅</a> 部分已了解过，默认情况下，组件被卸载时订阅也会被一并移除，但如果你之前启用了 <code>detached</code> 选项，就需要手动取消了。</p><p>前面在 <a href="#%E8%AE%A2%E9%98%85-api-%E7%9A%84-ts-%E7%B1%BB%E5%9E%8B">订阅 API 的 TS 类型</a> 里提到，在启用 <code>$subscribe</code> API 之后，会有一个函数作为返回值，这个函数可以用来取消该订阅。</p><p>用法非常简单，做一下简单了解即可：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 定义一个退订变量，它是一个函数</span>
<span class="token keyword">const</span> unsubscribe <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">$subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mutation<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> detached<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 在合适的时期调用它，可以取消这个订阅</span>
<span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>跟 watch API 的机制非常相似， 它也是返回 <a href="/component.html#%E5%8F%96%E6%B6%88%E7%9B%91%E5%90%AC" class="">一个取消监听的函数</a> 用于移除指定的 watch 。</p><h2 id="管理-getters-new" tabindex="-1"><a class="header-anchor" href="#管理-getters-new" aria-hidden="true">#</a> 管理 getters{new}</h2><p>在 <a href="#%E7%8A%B6%E6%80%81%E6%A0%91%E7%9A%84%E7%BB%93%E6%9E%84">状态树的结构</a> 了解过， Pinia 的 <code>getters</code> 是用来计算数据的。</p><h3 id="给-store-添加-getter" tabindex="-1"><a class="header-anchor" href="#给-store-添加-getter" aria-hidden="true">#</a> 给 Store 添加 getter</h3><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>如果对 Vue 的计算数据不是很熟悉或者没接触过的话，可以先阅读 <a href="/component.html#%E6%95%B0%E6%8D%AE%E7%9A%84%E8%AE%A1%E7%AE%97-new" class="">数据的计算</a> 这一节，以便有个初步印象，不会云里雾里。</p></div><h4 id="添加普通的-getter" tabindex="-1"><a class="header-anchor" href="#添加普通的-getter" aria-hidden="true">#</a> 添加普通的 getter</h4><p>我们继续用刚才的 <code>message</code> ，来定义一个 Getter ，用于返回一句拼接好的句子。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// src/stores/index.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;pinia&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> useStore <span class="token operator">=</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token string">&#39;main&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">state</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    message<span class="token operator">:</span> <span class="token string">&#39;Hello World&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// 定义一个 fullMessage 的计算数据</span>
  getters<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">fullMessage</span><span class="token operator">:</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The message is &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>和 <a href="/component.html#%E5%9B%9E%E9%A1%BE-vue-2-3" class="">Options API 的 Computed</a> 写法一样，也是通过函数来返回计算后的值，但在 Pinia ，只能使用箭头函数，通过入参的 <code>state</code> 来拿到当前实例的数据。</p><h4 id="添加引用-getter-的-getter" tabindex="-1"><a class="header-anchor" href="#添加引用-getter-的-getter" aria-hidden="true">#</a> 添加引用 getter 的 getter</h4><p>有时候你可能要引用另外一个 getter 的值来返回数据，这个时候不能用箭头函数了，需要定义成普通函数而不是箭头函数，并在函数内部通过 <code>this</code> 来调用当前 Store 上的数据和方法。</p><p>我们继续在上面的例子里，添加多一个 <code>emojiMessage</code> 的 getter ，在返回 <code>fullMessage</code> 的结果的同时，拼接多一串 emoji 。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> useStore <span class="token operator">=</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token string">&#39;main&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">state</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    message<span class="token operator">:</span> <span class="token string">&#39;Hello World&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  getters<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">fullMessage</span><span class="token operator">:</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The message is &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token comment">// 这个 getter 返回了另外一个 getter 的结果</span>
    <span class="token function">emojiMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">🎉🎉🎉 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>fullMessage<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>如果你只写 JavaScript ，可能对这一条所说的限制觉得很奇怪，事实上用 JS 写箭头函数来引用确实不会报错，但如果你用的是 TypeScript ，不按照这个写法，在 VSCode 提示和执行 TSC 检查的时候都会给你抛出一条错误：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>src/stores/index.ts:9:42 - error TS2339: 
Property <span class="token string">&#39;fullMessage&#39;</span> does not exist on <span class="token builtin class-name">type</span> <span class="token string">&#39;{ message: string; } &amp; {}&#39;</span><span class="token builtin class-name">.</span>

<span class="token number">9</span>     emojiMessage: <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable"><span class="token variable">`</span>🎉🎉🎉 $<span class="token punctuation">{</span>state.fullMessage<span class="token punctuation">}</span><span class="token variable">`</span></span>,
                                           ~~~~~~~~~~~


Found <span class="token number">1</span> error <span class="token keyword">in</span> src/stores/index.ts:9
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>另外关于普通函数的 TS 返回类型，官方建议显式的进行标注，就像这个例子里的 <code>emojiMessage(): string</code> 里的 <code>: string</code> 。</p><h4 id="给-getter-传递参数" tabindex="-1"><a class="header-anchor" href="#给-getter-传递参数" aria-hidden="true">#</a> 给 getter 传递参数</h4><p>getter 本身是不支持参数的，但和 Vuex 一样，支持返回一个具备入参的函数，用来满足需求。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;pinia&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> useStore <span class="token operator">=</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token string">&#39;main&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">state</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    message<span class="token operator">:</span> <span class="token string">&#39;Hello World&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  getters<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 定义一个接收入参的函数作为返回值</span>
    <span class="token function-variable function">signedMessage</span><span class="token operator">:</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> say: &quot;The message is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>调用的时候是这样：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> signedMessage <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">signedMessage</span><span class="token punctuation">(</span><span class="token string">&#39;Petter&#39;</span><span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;signedMessage&#39;</span><span class="token punctuation">,</span> signedMessage<span class="token punctuation">)</span>
<span class="token comment">// Petter say: &quot;The message is Hello World&quot;.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这种情况下，这个 getter 只是调用的函数的作用，不再有缓存，如果你通过变量定义了这个数据，那么这个变量也只是普通变量，不具备响应性。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 通过变量定义一个值</span>
<span class="token keyword">const</span> signedMessage <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">signedMessage</span><span class="token punctuation">(</span><span class="token string">&#39;Petter&#39;</span><span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;signedMessage&#39;</span><span class="token punctuation">,</span> signedMessage<span class="token punctuation">)</span>
<span class="token comment">// Petter say: &quot;The message is Hello World&quot;.</span>

<span class="token comment">// 2s 后改变 message</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token string">&#39;New Message&#39;</span>

  <span class="token comment">// signedMessage 不会变</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;signedMessage&#39;</span><span class="token punctuation">,</span> signedMessage<span class="token punctuation">)</span>
  <span class="token comment">// Petter say: &quot;The message is Hello World&quot;.</span>

  <span class="token comment">// 必须这样再次执行才能拿到更新后的值</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;signedMessage&#39;</span><span class="token punctuation">,</span> store<span class="token punctuation">.</span><span class="token function">signedMessage</span><span class="token punctuation">(</span><span class="token string">&#39;Petter&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// Petter say: &quot;The message is New Message&quot;.</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="获取和更新-getter" tabindex="-1"><a class="header-anchor" href="#获取和更新-getter" aria-hidden="true">#</a> 获取和更新 getter</h3><p>getter 和 state 都属于数据管理，读取和赋值的方法是一样的，请参考上方 <a href="#%E8%8E%B7%E5%8F%96%E5%92%8C%E6%9B%B4%E6%96%B0-state-new">获取和更新 state</a> 一节的内容。</p><h2 id="管理-actions-new" tabindex="-1"><a class="header-anchor" href="#管理-actions-new" aria-hidden="true">#</a> 管理 actions{new}</h2><p>在 <a href="#%E7%8A%B6%E6%80%81%E6%A0%91%E7%9A%84%E7%BB%93%E6%9E%84">状态树的结构</a> 提到了， Pinia 只需要用 <code>actions</code> 就可以解决各种数据操作，无需像 Vuex 一样区分为 <code>mutations / actions</code> 两大类。</p><h3 id="给-store-添加-action" tabindex="-1"><a class="header-anchor" href="#给-store-添加-action" aria-hidden="true">#</a> 给 Store 添加 action</h3><p>你可以为当前 Store 封装一些可以开箱即用的方法，支持同步和异步。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// src/stores/index.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;pinia&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> useStore <span class="token operator">=</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token string">&#39;main&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">state</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    message<span class="token operator">:</span> <span class="token string">&#39;Hello World&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  actions<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 异步更新 message</span>
    <span class="token keyword">async</span> <span class="token function">updateMessage</span><span class="token punctuation">(</span>newMessage<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 这里的 this 是当前的 Store 实例</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> newMessage
          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&#39;Async done.&#39;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 同步更新 message</span>
    <span class="token function">updateMessageSync</span><span class="token punctuation">(</span>newMessage<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这里的 this 是当前的 Store 实例</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> newMessage
      <span class="token keyword">return</span> <span class="token string">&#39;Sync done.&#39;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>可以看到，在 action 里，如果要访问当前实例的 state 或者 getter ，只需要通过 <code>this</code> 即可操作，方法的入参完全不再受 Vuex 那样有固定形式的困扰。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>在 action 里， <code>this</code> 是当前的 Store 实例，所以如果你的 action 方法里有其他函数也要调用实例，请记得写成 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Functions/Arrow_functions" target="_blank" rel="noopener noreferrer">箭头函数<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 来提升 this 。</p></div><h3 id="调用-action" tabindex="-1"><a class="header-anchor" href="#调用-action" aria-hidden="true">#</a> 调用 action</h3><p>像普通的函数一样使用即可，不需要和 Vuex 一样执行 commit 或者 dispatch，在 Pinia ，不需要，不需要。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">useStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> message <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">storeToRefs</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span>

    <span class="token comment">// 立即执行</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">updateMessageSync</span><span class="token punctuation">(</span><span class="token string">&#39;New message by sync.&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// 3s 后执行</span>
    store<span class="token punctuation">.</span><span class="token function">updateMessage</span><span class="token punctuation">(</span><span class="token string">&#39;New message by async.&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      message<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="添加多个-store-new" tabindex="-1"><a class="header-anchor" href="#添加多个-store-new" aria-hidden="true">#</a> 添加多个 Store{new}</h2><p>到这里，对单个 Store 的配置和调用相信都已经清楚了，实际项目中会涉及到很多数据操作，还可以用多个 Store 来维护不同需求模块的数据状态。</p><p>这一点和 Vuex 的 <a href="https://vuex.vuejs.org/zh/guide/modules.html" target="_blank" rel="noopener noreferrer">Module<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 比较相似，目的都是为了避免状态树过于臃肿，但用起来会更为简单。</p><h3 id="目录结构建议" tabindex="-1"><a class="header-anchor" href="#目录结构建议" aria-hidden="true">#</a> 目录结构建议</h3><p>建议统一存放在 <code>src/stores</code> 下面管理，根据业务需要进行命名，比如 <code>user</code> 就用来管理登录用户相关的状态数据。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>src
└─stores
  │ <span class="token comment"># 入口文件</span>
  ├─index.ts
  │ <span class="token comment"># 多个 store</span>
  ├─user.ts
  ├─game.ts
  └─news.ts
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>里面暴露的方法就统一以 <code>use</code> 开头加上文件名，并以 <code>Store</code> 结尾，作为小驼峰写法，比如 <code>user</code> 这个 Store 文件里面导出的函数名就是：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// src/stores/user.ts</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> useUserStore <span class="token operator">=</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token string">&#39;user&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然后以 <code>index.ts</code> 里作为统一的入口文件， <code>index.ts</code> 里的代码写为：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&#39;./user&#39;</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&#39;./game&#39;</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&#39;./news&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这样在使用的时候，只需要从 <code>@/stores</code> 里导入即可，无需写完整的路径，例如，只需要这样：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> useUserStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/stores&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>而无需这样：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> useUserStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/stores/user&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="在-vue-组件-ts-文件里使用" tabindex="-1"><a class="header-anchor" href="#在-vue-组件-ts-文件里使用" aria-hidden="true">#</a> 在 Vue 组件 / TS 文件里使用</h3><p>这里我以一个比较简单的业务场景举例，希望能够方便的理解如何同时使用多个 Store 。</p><p>假设目前有一个 <code>userStore</code> 是管理当前登录用户信息， <code>gameStore</code> 是管理游戏的信息，而 “个人中心” 这个页面需要展示 “用户信息” ，以及 “该用户绑定的游戏信息”，那么就可以这样：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> onMounted<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> storeToRefs <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;pinia&#39;</span>
<span class="token comment">// 这里导入你要用到的 Store</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useUserStore<span class="token punctuation">,</span> useGameStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/stores&#39;</span>
<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> GameItem <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/types&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 先从 userStore 获取用户信息（已经登录过，所以可以直接拿到）</span>
    <span class="token keyword">const</span> userStore <span class="token operator">=</span> <span class="token function">useUserStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> userId<span class="token punctuation">,</span> userName <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">storeToRefs</span><span class="token punctuation">(</span>userStore<span class="token punctuation">)</span>

    <span class="token comment">// 使用 gameStore 里的方法，传入用户 ID 去查询用户的游戏列表</span>
    <span class="token keyword">const</span> gameStore <span class="token operator">=</span> <span class="token function">useGameStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> gameList <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span>GameItem<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      gameList<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">await</span> gameStore<span class="token punctuation">.</span><span class="token function">queryGameList</span><span class="token punctuation">(</span>userId<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      userId<span class="token punctuation">,</span>
      userName<span class="token punctuation">,</span>
      gameList<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>再次提醒，切记每个 Store 的 ID 必须不同，如果 ID 重复，在同一个 Vue 组件 / TS 文件里定义 Store 实例变量的时候，会以先定义的为有效值，后续定义的会和前面一样。</p><p>如果先定义了 userStore :</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 假设两个 Store 的 ID 一样</span>
<span class="token keyword">const</span> userStore <span class="token operator">=</span> <span class="token function">useUserStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 是想要的 Store</span>
<span class="token keyword">const</span> gameStore <span class="token operator">=</span> <span class="token function">useGameStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 得到的依然是 userStore 的那个 Store</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果先定义了 gameStore :</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 假设两个 Store 的 ID 一样</span>
<span class="token keyword">const</span> gameStore <span class="token operator">=</span> <span class="token function">useGameStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 是想要的 Store</span>
<span class="token keyword">const</span> userStore <span class="token operator">=</span> <span class="token function">useUserStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 得到的依然是 gameStore 的那个 Store</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="store-之间互相引用" tabindex="-1"><a class="header-anchor" href="#store-之间互相引用" aria-hidden="true">#</a> Store 之间互相引用</h3><p>如果在定义一个 Store 的时候，要引用另外一个 Store 的数据，也是很简单，我们回到那个 message 的例子，我们添加一个 getter ，它会返回一句问候语欢迎用户：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// src/stores/message.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;pinia&#39;</span>

<span class="token comment">// 导入用户信息的 Store 并启用它</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useUserStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./user&#39;</span>
<span class="token keyword">const</span> userStore <span class="token operator">=</span> <span class="token function">useUserStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> useMessageStore <span class="token operator">=</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token string">&#39;message&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">state</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    message<span class="token operator">:</span> <span class="token string">&#39;Hello World&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  getters<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里我们就可以直接引用 userStore 上面的数据了</span>
    <span class="token function-variable function">greeting</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Welcome, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>userStore<span class="token punctuation">.</span>userName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>假设现在 <code>userName</code> 是 Petter ，那么你会得到一句对 Petter 的问候：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> messageStore <span class="token operator">=</span> <span class="token function">useMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>messageStore<span class="token punctuation">.</span>greeting<span class="token punctuation">)</span>  <span class="token comment">// Welcome, Petter!</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="专属插件的使用-new" tabindex="-1"><a class="header-anchor" href="#专属插件的使用-new" aria-hidden="true">#</a> 专属插件的使用{new}</h2><p>Pinia 拥有非常灵活的可扩展性，有专属插件可以开箱即用满足更多的需求场景。</p><h3 id="如何查找插件" tabindex="-1"><a class="header-anchor" href="#如何查找插件" aria-hidden="true">#</a> 如何查找插件</h3><p>插件有统一的命名格式 <code>pinia-plugin-*</code> ，所以你可以在 npmjs 上搜索这个关键词来查询目前有哪些插件已发布。</p><p>点击查询： <a href="https://www.npmjs.com/search?q=pinia-plugin" target="_blank" rel="noopener noreferrer">pinia-plugin - npmjs<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="如何使用插件" tabindex="-1"><a class="header-anchor" href="#如何使用插件" aria-hidden="true">#</a> 如何使用插件</h3><p>这里以 <a href="https://www.npmjs.com/package/pinia-plugin-persistedstate" target="_blank" rel="noopener noreferrer">pinia-plugin-persistedstate<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 为例，这是一个让数据持久化存储的 Pinia 插件。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>数据持久化存储，指页面关闭后再打开，浏览器依然可以记录之前保存的本地数据，例如：浏览器原生的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/localStorage" target="_blank" rel="noopener noreferrer">localStorage<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 和 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/IndexedDB_API" target="_blank" rel="noopener noreferrer">IndexedDB<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ，或者是一些兼容多种原生方案并统一用法的第三方方案，例如： <a href="https://github.com/localForage/localForage" target="_blank" rel="noopener noreferrer">localForage<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 。</p></div><p>插件也是独立的 npm 包，需要先安装，再激活，然后才能使用。</p><p>激活方法会涉及到 Pinia 的初始化过程调整，这里不局限于某一个插件，通用的插件用法如下（请留意代码注释）：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// src/main.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">&#39;@/App.vue&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createPinia <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;pinia&#39;</span> <span class="token comment">// 导入 Pinia</span>
<span class="token keyword">import</span> piniaPluginPersistedstate <span class="token keyword">from</span> <span class="token string">&#39;pinia-plugin-persistedstate&#39;</span> <span class="token comment">// 导入 Pinia 插件</span>

<span class="token keyword">const</span> pinia <span class="token operator">=</span> <span class="token function">createPinia</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 初始化 Pinia</span>
pinia<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>piniaPluginPersistedstate<span class="token punctuation">)</span> <span class="token comment">// 激活 Pinia 插件</span>

<span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>pinia<span class="token punctuation">)</span> <span class="token comment">// 启用 Pinia ，这一次是包含了插件的 Pinia 实例</span>
  <span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="highlight-lines"><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><br><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><div class="highlight-line"> </div><br></div><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="使用前" tabindex="-1"><a class="header-anchor" href="#使用前" aria-hidden="true">#</a> 使用前</h4><p>Pinia 默认在页面刷新时会丢失当前变更的数据，没有在本地做持久化记录：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 其他代码省略</span>
<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">useMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 假设初始值是 Hello World</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 2s 后变成 Hello World!</span>
  store<span class="token punctuation">.</span>message <span class="token operator">=</span> store<span class="token punctuation">.</span>message <span class="token operator">+</span> <span class="token string">&#39;!&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>

<span class="token comment">// 页面刷新后又变回了 Hello World</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="使用后" tabindex="-1"><a class="header-anchor" href="#使用后" aria-hidden="true">#</a> 使用后</h4><p>按照 persistedstate 插件的文档说明，我们在其中一个 Store 启用它，只需要添加一个 <code>persist: true</code> 的选项即可开启：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// src/stores/message.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;pinia&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useUserStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./user&#39;</span>

<span class="token keyword">const</span> userStore <span class="token operator">=</span> <span class="token function">useUserStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> useMessageStore <span class="token operator">=</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token string">&#39;message&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">state</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    message<span class="token operator">:</span> <span class="token string">&#39;Hello World&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  getters<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">greeting</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Welcome, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>userStore<span class="token punctuation">.</span>userName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 这是按照插件的文档，在实例上启用了该插件，这个选项是插件特有的</span>
  persist<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>回到我们的页面，现在这个 Store 具备了持久化记忆的功能了，它会从 localStorage 读取原来的数据作为初始值，每一次变化后也会将其写入 localStorage 进行记忆存储。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 其他代码省略</span>
<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">useMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 假设初始值是 Hello World</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 2s 后变成 Hello World!</span>
  store<span class="token punctuation">.</span>message <span class="token operator">=</span> store<span class="token punctuation">.</span>message <span class="token operator">+</span> <span class="token string">&#39;!&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>

<span class="token comment">// 页面刷新后变成了 Hello World!!</span>
<span class="token comment">// 再次刷新后变成了 Hello World!!!</span>
<span class="token comment">// 再次刷新后变成了 Hello World!!!!</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>你可以在浏览器查看到 localStorage 的存储变化，以 Chrome 浏览器为例，按 F12 ，打开 Application 面板，选择 Local Storage ，可以看到以当前 Store ID 为 Key 的存储数据。</p><p>这是其中一个插件使用的例子，更多的用法请根据自己选择的插件的 README 说明操作。</p><h2 id="本章结语" tabindex="-1"><a class="header-anchor" href="#本章结语" aria-hidden="true">#</a> 本章结语</h2><p>看完 Pinia 这一章，我感觉应该都回不去 Vuex 了，真的方便了太多！！！新项目建议直接用 Pinia ，老项目如果有计划迁移，可以和 Vuex 同时使用一段时间，然后再逐步替换。</p><!----><!----><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/chengpeiquan/learning-vue3/edit/main/docs/pinia.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page"><!--[--><!--]--> Edit this page <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: chengpeiquan@chengpeiquan.com">chengpeiquan</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/communication.html" class="" aria-label="组件之间的通信"><!--[--><!--]--> 组件之间的通信 <!--[--><!--]--></a></span><span class="next"><a href="/efficient.html" class="" aria-label="高效开发"><!--[--><!--]--> 高效开发 <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.0c7b3152.js" defer></script>
  </body>
</html>
