<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.41">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="https://chengpeiquan.com/favicon.ico"><meta name="keywords" content="vue 3, vue 3.x, vue 3 入门, vue 3 教程, 学习 vue 3, vue 3 案例, vue 3 教学, vue 3 好用吗"><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#3eaf7c"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png"><link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c"><meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png"><meta name="msapplication-TileColor" content="#000000"><title>单组件的编写 | Vue3 入门指南与实战案例</title><meta name="description" content="这是一个关于 Vue 3 + TypeScript 的起步学习教程，适合完全的Vue新手和Vue 2.0的老手，在官方文档的基础上融入自己的一些实践经验。">
    <link rel="modulepreload" href="/assets/app.0c7b3152.js"><link rel="modulepreload" href="/assets/component.html.f5307f9d.js"><link rel="modulepreload" href="/assets/component.html.3d44d9c3.js"><link rel="prefetch" href="/assets/index.html.2f003589.js"><link rel="prefetch" href="/assets/communication.html.be61d0ec.js"><link rel="prefetch" href="/assets/efficient.html.a26166bb.js"><link rel="prefetch" href="/assets/guide.html.adff52ae.js"><link rel="prefetch" href="/assets/links.html.b094a747.js"><link rel="prefetch" href="/assets/pinia.html.7109bbd7.js"><link rel="prefetch" href="/assets/plugin.html.e84e0166.js"><link rel="prefetch" href="/assets/router.html.86285e99.js"><link rel="prefetch" href="/assets/update.html.e870f97c.js"><link rel="prefetch" href="/assets/404.html.9b42cd8b.js"><link rel="prefetch" href="/assets/index.html.5f058d06.js"><link rel="prefetch" href="/assets/communication.html.19f6b2f7.js"><link rel="prefetch" href="/assets/efficient.html.ad1f20a6.js"><link rel="prefetch" href="/assets/guide.html.90f201ac.js"><link rel="prefetch" href="/assets/links.html.62996d14.js"><link rel="prefetch" href="/assets/pinia.html.642f88d2.js"><link rel="prefetch" href="/assets/plugin.html.eb66815b.js"><link rel="prefetch" href="/assets/router.html.60990ba2.js"><link rel="prefetch" href="/assets/update.html.100e2c95.js"><link rel="prefetch" href="/assets/404.html.4675e898.js"><link rel="prefetch" href="/assets/404.d3026537.js"><link rel="prefetch" href="/assets/Layout.527176c4.js"><link rel="prefetch" href="/assets/GitalkComment.3ff1abe3.js"><link rel="prefetch" href="/assets/GoogleAdsense.40b4bcba.js"><link rel="prefetch" href="/assets/ImgWrap.abf53801.js">
    <link rel="stylesheet" href="/assets/style.515263ec.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><img class="logo" src="https://vue3.chengpeiquan.com/assets/img/vue3.png" alt="Vue3 入门指南与实战案例"><span class="site-name can-hide">Vue3 入门指南与实战案例</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a class="external-link" href="https://chengpeiquan.com/" rel="noopener noreferrer" target="_blank" aria-label="博客首页"><!--[--><!--]--> 博客首页 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/chengpeiquan/cooking-cookbook" rel="noopener noreferrer" target="_blank" aria-label="菜谱教程"><!--[--><!--]--> 菜谱教程 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/chengpeiquan/learning-vue3" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a class="external-link" href="https://chengpeiquan.com/" rel="noopener noreferrer" target="_blank" aria-label="博客首页"><!--[--><!--]--> 博客首页 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/chengpeiquan/cooking-cookbook" rel="noopener noreferrer" target="_blank" aria-label="菜谱教程"><!--[--><!--]--> 菜谱教程 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/chengpeiquan/learning-vue3" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/" class="sidebar-item sidebar-heading" aria-label="前言"><!--[--><!--]--> 前言 <!--[--><!--]--></a><!----></li><li><a href="/guide.html" class="sidebar-item sidebar-heading" aria-label="起步准备"><!--[--><!--]--> 起步准备 <!--[--><!--]--></a><!----></li><li><a href="/update.html" class="sidebar-item sidebar-heading" aria-label="升级与配置"><!--[--><!--]--> 升级与配置 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html" class="router-link-active router-link-exact-active router-link-active sidebar-item sidebar-heading active" aria-label="单组件的编写"><!--[--><!--]--> 单组件的编写 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/component.html#全新的-setup-函数-new" class="router-link-active router-link-exact-active sidebar-item" aria-label="全新的 setup 函数{new}"><!--[--><!--]--> 全新的 setup 函数{new} <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/component.html#了解-setup" class="router-link-active router-link-exact-active sidebar-item" aria-label="了解 setup"><!--[--><!--]--> 了解 setup <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#setup-的参数使用" class="router-link-active router-link-exact-active sidebar-item" aria-label="setup 的参数使用"><!--[--><!--]--> setup 的参数使用 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#了解-definecomponent" class="router-link-active router-link-exact-active sidebar-item" aria-label="了解 defineComponent"><!--[--><!--]--> 了解 defineComponent <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/component.html#组件的生命周期-new" class="router-link-active router-link-exact-active sidebar-item" aria-label="组件的生命周期{new}"><!--[--><!--]--> 组件的生命周期{new} <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/component.html#升级变化" class="router-link-active router-link-exact-active sidebar-item" aria-label="升级变化"><!--[--><!--]--> 升级变化 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#使用-3-x-的生命周期" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用 3.x 的生命周期"><!--[--><!--]--> 使用 3.x 的生命周期 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/component.html#组件的基本写法" class="router-link-active router-link-exact-active sidebar-item" aria-label="组件的基本写法"><!--[--><!--]--> 组件的基本写法 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/component.html#回顾-vue-2" class="router-link-active router-link-exact-active sidebar-item" aria-label="回顾 Vue 2"><!--[--><!--]--> 回顾 Vue 2 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#了解-vue-3-new" class="router-link-active router-link-exact-active sidebar-item" aria-label="了解 Vue 3{new}"><!--[--><!--]--> 了解 Vue 3{new} <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/component.html#响应式数据的变化-new" class="router-link-active router-link-exact-active sidebar-item" aria-label="响应式数据的变化 {new}"><!--[--><!--]--> 响应式数据的变化 {new} <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/component.html#设计上的变化" class="router-link-active router-link-exact-active sidebar-item" aria-label="设计上的变化"><!--[--><!--]--> 设计上的变化 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/component.html#回顾-vue-2-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="回顾 Vue 2"><!--[--><!--]--> 回顾 Vue 2 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#了解-vue-3" class="router-link-active router-link-exact-active sidebar-item" aria-label="了解 Vue 3"><!--[--><!--]--> 了解 Vue 3 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/component.html#用法上的变化" class="router-link-active router-link-exact-active sidebar-item" aria-label="用法上的变化"><!--[--><!--]--> 用法上的变化 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/component.html#响应式-api-之-ref-new" class="router-link-active router-link-exact-active sidebar-item" aria-label="响应式 API 之 ref{new}"><!--[--><!--]--> 响应式 API 之 ref{new} <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/component.html#类型声明" class="router-link-active router-link-exact-active sidebar-item" aria-label="类型声明"><!--[--><!--]--> 类型声明 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#变量的定义" class="router-link-active router-link-exact-active sidebar-item" aria-label="变量的定义"><!--[--><!--]--> 变量的定义 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/component.html#基本类型" class="router-link-active router-link-exact-active sidebar-item" aria-label="基本类型"><!--[--><!--]--> 基本类型 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#引用类型" class="router-link-active router-link-exact-active sidebar-item" aria-label="引用类型"><!--[--><!--]--> 引用类型 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/component.html#dom-元素与子组件" class="router-link-active router-link-exact-active sidebar-item" aria-label="DOM 元素与子组件"><!--[--><!--]--> DOM 元素与子组件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#变量的读取与赋值" class="router-link-active router-link-exact-active sidebar-item" aria-label="变量的读取与赋值"><!--[--><!--]--> 变量的读取与赋值 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/component.html#响应式-api-之-reactive-new" class="router-link-active router-link-exact-active sidebar-item" aria-label="响应式 API 之 reactive{new}"><!--[--><!--]--> 响应式 API 之 reactive{new} <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/component.html#类型声明与定义" class="router-link-active router-link-exact-active sidebar-item" aria-label="类型声明与定义"><!--[--><!--]--> 类型声明与定义 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#变量的读取与赋值-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="变量的读取与赋值"><!--[--><!--]--> 变量的读取与赋值 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#特别注意" class="router-link-active router-link-exact-active sidebar-item" aria-label="特别注意"><!--[--><!--]--> 特别注意 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/component.html#响应式-api-之-toref-与-torefs-new" class="router-link-active router-link-exact-active sidebar-item" aria-label="响应式 API 之 toRef 与 toRefs{new}"><!--[--><!--]--> 响应式 API 之 toRef 与 toRefs{new} <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/component.html#各自的作用" class="router-link-active router-link-exact-active sidebar-item" aria-label="各自的作用"><!--[--><!--]--> 各自的作用 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#使用-toref" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用 toRef"><!--[--><!--]--> 使用 toRef <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#使用-torefs" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用 toRefs"><!--[--><!--]--> 使用 toRefs <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#为什么要进行转换" class="router-link-active router-link-exact-active sidebar-item" aria-label="为什么要进行转换"><!--[--><!--]--> 为什么要进行转换 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#什么场景下比较适合使用它们" class="router-link-active router-link-exact-active sidebar-item" aria-label="什么场景下比较适合使用它们"><!--[--><!--]--> 什么场景下比较适合使用它们 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#在业务中的具体运用" class="router-link-active router-link-exact-active sidebar-item" aria-label="在业务中的具体运用"><!--[--><!--]--> 在业务中的具体运用 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#需要注意的问题" class="router-link-active router-link-exact-active sidebar-item" aria-label="需要注意的问题"><!--[--><!--]--> 需要注意的问题 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/component.html#函数的定义和使用-new" class="router-link-active router-link-exact-active sidebar-item" aria-label="函数的定义和使用{new}"><!--[--><!--]--> 函数的定义和使用{new} <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#数据的监听-new" class="router-link-active router-link-exact-active sidebar-item" aria-label="数据的监听{new}"><!--[--><!--]--> 数据的监听{new} <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/component.html#watch" class="router-link-active router-link-exact-active sidebar-item" aria-label="watch"><!--[--><!--]--> watch <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/component.html#回顾-vue-2-2" class="router-link-active router-link-exact-active sidebar-item" aria-label="回顾 Vue 2"><!--[--><!--]--> 回顾 Vue 2 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#了解-vue-3-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="了解 Vue 3"><!--[--><!--]--> 了解 Vue 3 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#api-的-ts-类型" class="router-link-active router-link-exact-active sidebar-item" aria-label="API 的 TS 类型"><!--[--><!--]--> API 的 TS 类型 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#要监听的数据源" class="router-link-active router-link-exact-active sidebar-item" aria-label="要监听的数据源"><!--[--><!--]--> 要监听的数据源 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#监听后的回调函数" class="router-link-active router-link-exact-active sidebar-item" aria-label="监听后的回调函数"><!--[--><!--]--> 监听后的回调函数 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#基础用法" class="router-link-active router-link-exact-active sidebar-item" aria-label="基础用法"><!--[--><!--]--> 基础用法 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#批量监听" class="router-link-active router-link-exact-active sidebar-item" aria-label="批量监听"><!--[--><!--]--> 批量监听 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#监听的选项" class="router-link-active router-link-exact-active sidebar-item" aria-label="监听的选项"><!--[--><!--]--> 监听的选项 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#监听选项之-deep" class="router-link-active router-link-exact-active sidebar-item" aria-label="监听选项之 deep"><!--[--><!--]--> 监听选项之 deep <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#监听选项之-immediate" class="router-link-active router-link-exact-active sidebar-item" aria-label="监听选项之 immediate"><!--[--><!--]--> 监听选项之 immediate <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#监听选项之-flush" class="router-link-active router-link-exact-active sidebar-item" aria-label="监听选项之 flush"><!--[--><!--]--> 监听选项之 flush <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#停止监听" class="router-link-active router-link-exact-active sidebar-item" aria-label="停止监听"><!--[--><!--]--> 停止监听 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#监听效果清理" class="router-link-active router-link-exact-active sidebar-item" aria-label="监听效果清理"><!--[--><!--]--> 监听效果清理 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/component.html#watcheffect" class="router-link-active router-link-exact-active sidebar-item" aria-label="watchEffect"><!--[--><!--]--> watchEffect <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/component.html#api-的-ts-类型-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="API 的 TS 类型"><!--[--><!--]--> API 的 TS 类型 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#用法示例" class="router-link-active router-link-exact-active sidebar-item" aria-label="用法示例"><!--[--><!--]--> 用法示例 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#和-watch-的区别" class="router-link-active router-link-exact-active sidebar-item" aria-label="和 watch 的区别"><!--[--><!--]--> 和 watch 的区别 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#可用的监听选项" class="router-link-active router-link-exact-active sidebar-item" aria-label="可用的监听选项"><!--[--><!--]--> 可用的监听选项 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/component.html#watchposteffect" class="router-link-active router-link-exact-active sidebar-item" aria-label="watchPostEffect"><!--[--><!--]--> watchPostEffect <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#watchsynceffect" class="router-link-active router-link-exact-active sidebar-item" aria-label="watchSyncEffect"><!--[--><!--]--> watchSyncEffect <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/component.html#数据的计算-new" class="router-link-active router-link-exact-active sidebar-item" aria-label="数据的计算{new}"><!--[--><!--]--> 数据的计算{new} <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/component.html#用法变化" class="router-link-active router-link-exact-active sidebar-item" aria-label="用法变化"><!--[--><!--]--> 用法变化 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/component.html#回顾-vue-2-3" class="router-link-active router-link-exact-active sidebar-item" aria-label="回顾 Vue 2"><!--[--><!--]--> 回顾 Vue 2 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#了解-vue-3-2" class="router-link-active router-link-exact-active sidebar-item" aria-label="了解 Vue 3"><!--[--><!--]--> 了解 Vue 3 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/component.html#类型定义" class="router-link-active router-link-exact-active sidebar-item" aria-label="类型定义"><!--[--><!--]--> 类型定义 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#优势对比和注意事项" class="router-link-active router-link-exact-active sidebar-item" aria-label="优势对比和注意事项"><!--[--><!--]--> 优势对比和注意事项 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/component.html#优势对比" class="router-link-active router-link-exact-active sidebar-item" aria-label="优势对比"><!--[--><!--]--> 优势对比 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#注意事项" class="router-link-active router-link-exact-active sidebar-item" aria-label="注意事项"><!--[--><!--]--> 注意事项 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/component.html#setter-的使用" class="router-link-active router-link-exact-active sidebar-item" aria-label="setter 的使用"><!--[--><!--]--> setter 的使用 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/component.html#基本格式" class="router-link-active router-link-exact-active sidebar-item" aria-label="基本格式"><!--[--><!--]--> 基本格式 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#使用示范" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用示范"><!--[--><!--]--> 使用示范 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/component.html#应用场景" class="router-link-active router-link-exact-active sidebar-item" aria-label="应用场景"><!--[--><!--]--> 应用场景 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/component.html#数据的拼接和计算" class="router-link-active router-link-exact-active sidebar-item" aria-label="数据的拼接和计算"><!--[--><!--]--> 数据的拼接和计算 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#复用组件的动态数据" class="router-link-active router-link-exact-active sidebar-item" aria-label="复用组件的动态数据"><!--[--><!--]--> 复用组件的动态数据 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#获取多级对象的值" class="router-link-active router-link-exact-active sidebar-item" aria-label="获取多级对象的值"><!--[--><!--]--> 获取多级对象的值 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#不同类型的数据转换" class="router-link-active router-link-exact-active sidebar-item" aria-label="不同类型的数据转换"><!--[--><!--]--> 不同类型的数据转换 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/component.html#指令" class="router-link-active router-link-exact-active sidebar-item" aria-label="指令"><!--[--><!--]--> 指令 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/component.html#内置指令" class="router-link-active router-link-exact-active sidebar-item" aria-label="内置指令"><!--[--><!--]--> 内置指令 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#自定义指令-new" class="router-link-active router-link-exact-active sidebar-item" aria-label="自定义指令{new}"><!--[--><!--]--> 自定义指令{new} <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/component.html#相关的-ts-类型" class="router-link-active router-link-exact-active sidebar-item" aria-label="相关的 TS 类型"><!--[--><!--]--> 相关的 TS 类型 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#钩子函数" class="router-link-active router-link-exact-active sidebar-item" aria-label="钩子函数"><!--[--><!--]--> 钩子函数 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#局部注册" class="router-link-active router-link-exact-active sidebar-item" aria-label="局部注册"><!--[--><!--]--> 局部注册 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#全局注册" class="router-link-active router-link-exact-active sidebar-item" aria-label="全局注册"><!--[--><!--]--> 全局注册 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#deep-选项" class="router-link-active router-link-exact-active sidebar-item" aria-label="deep 选项"><!--[--><!--]--> deep 选项 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/component.html#插槽" class="router-link-active router-link-exact-active sidebar-item" aria-label="插槽"><!--[--><!--]--> 插槽 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/component.html#默认插槽" class="router-link-active router-link-exact-active sidebar-item" aria-label="默认插槽"><!--[--><!--]--> 默认插槽 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#具名插槽" class="router-link-active router-link-exact-active sidebar-item" aria-label="具名插槽"><!--[--><!--]--> 具名插槽 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#默认内容" class="router-link-active router-link-exact-active sidebar-item" aria-label="默认内容"><!--[--><!--]--> 默认内容 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#注意事项-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="注意事项"><!--[--><!--]--> 注意事项 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/component.html#css-样式与预处理器" class="router-link-active router-link-exact-active sidebar-item" aria-label="CSS 样式与预处理器"><!--[--><!--]--> CSS 样式与预处理器 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/component.html#编写组件样式表" class="router-link-active router-link-exact-active sidebar-item" aria-label="编写组件样式表"><!--[--><!--]--> 编写组件样式表 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#动态绑定-css" class="router-link-active router-link-exact-active sidebar-item" aria-label="动态绑定 CSS"><!--[--><!--]--> 动态绑定 CSS <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/component.html#使用-class-动态修改样式名" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用 :class 动态修改样式名"><!--[--><!--]--> 使用 :class 动态修改样式名 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#使用-style-动态修改内联样式" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用 :style 动态修改内联样式"><!--[--><!--]--> 使用 :style 动态修改内联样式 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#使用-v-bind-动态修改-style-new" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用 v-bind 动态修改 style{new}"><!--[--><!--]--> 使用 v-bind 动态修改 style{new} <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/component.html#样式表的组件作用域" class="router-link-active router-link-exact-active sidebar-item" aria-label="样式表的组件作用域"><!--[--><!--]--> 样式表的组件作用域 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/component.html#style-scoped" class="router-link-active router-link-exact-active sidebar-item" aria-label="style scoped"><!--[--><!--]--> style scoped <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#style-module-new" class="router-link-active router-link-exact-active sidebar-item" aria-label="style module{new}"><!--[--><!--]--> style module{new} <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#usecssmodule-new" class="router-link-active router-link-exact-active sidebar-item" aria-label="useCssModule{new}"><!--[--><!--]--> useCssModule{new} <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/component.html#深度操作符-new" class="router-link-active router-link-exact-active sidebar-item" aria-label="深度操作符{new}"><!--[--><!--]--> 深度操作符{new} <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/component.html#使用-css-预处理器" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用 CSS 预处理器"><!--[--><!--]--> 使用 CSS 预处理器 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/component.html#本章结语" class="router-link-active router-link-exact-active sidebar-item" aria-label="本章结语"><!--[--><!--]--> 本章结语 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/router.html" class="sidebar-item sidebar-heading" aria-label="路由的使用"><!--[--><!--]--> 路由的使用 <!--[--><!--]--></a><!----></li><li><a href="/plugin.html" class="sidebar-item sidebar-heading" aria-label="插件的使用"><!--[--><!--]--> 插件的使用 <!--[--><!--]--></a><!----></li><li><a href="/communication.html" class="sidebar-item sidebar-heading" aria-label="组件之间的通信"><!--[--><!--]--> 组件之间的通信 <!--[--><!--]--></a><!----></li><li><a href="/pinia.html" class="sidebar-item sidebar-heading" aria-label="全局状态的管理"><!--[--><!--]--> 全局状态的管理 <!--[--><!--]--></a><!----></li><li><a href="/efficient.html" class="sidebar-item sidebar-heading" aria-label="高效开发"><!--[--><!--]--> 高效开发 <!--[--><!--]--></a><!----></li><li><a href="/links.html" class="sidebar-item sidebar-heading" aria-label="拓展阅读"><!--[--><!--]--> 拓展阅读 <!--[--><!--]--></a><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="单组件的编写" tabindex="-1"><a class="header-anchor" href="#单组件的编写" aria-hidden="true">#</a> 单组件的编写</h1><p>项目搭好了，第一个要了解的肯定是组件的变化，由于这部分篇幅会非常大，所以会分成很多个小节，一部分一部分按照开发顺序来逐步了解。</p><p>因为 Vue 3 对 TypeScript 的支持真的是太完善了，以及 TypeScript 的发展趋势越来越好，所以我们直接使用 TypeScript 来编写组件。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>对 TypeScript 不太熟悉的同学，建议先阅读一遍 “起步准备” 章节里的 <a href="/guide.html#%E4%BA%86%E8%A7%A3-typescript" class="">了解 TypeScript</a> 一节的内容，有了一定的了解之后，再一边写代码一边加深印象。</p></div><h2 id="全新的-setup-函数-new" tabindex="-1"><a class="header-anchor" href="#全新的-setup-函数-new" aria-hidden="true">#</a> 全新的 setup 函数{new}</h2><p>在开始编写组件之前，我们需要了解两个全新的前置知识点：<code>setup</code> 与 <code>defineComponent</code>。</p><h3 id="了解-setup" tabindex="-1"><a class="header-anchor" href="#了解-setup" aria-hidden="true">#</a> 了解 setup</h3><p>Vue 3 的 Composition API 系列里，推出了一个全新的 <code>setup</code> 函数，它是一个组件选项，在创建组件之前执行，一旦 props 被解析，并作为组合式 API 的入口点。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>说的通俗一点，就是使用 Vue 3 的生命周期的情况下，整个组件相关的业务代码，都可以丢到 <code>setup</code> 里编写。</p><p>因为在 <code>setup</code> 之后，其他的生命周期才会被启用（点击了解：<a href="#%E7%BB%84%E4%BB%B6%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F-new">组件的生命周期</a>）。</p></div><p>基本语法：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 业务代码写这里...</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token comment">// 需要给 template 用的数据、函数放这里 return 出去...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这里我还写了一个 <code>defineComponent</code>，也是本次的新东西，可以点击 <a href="#%E4%BA%86%E8%A7%A3-definecomponent">了解 defineComponent</a> 。</p><div class="custom-container warning"><p class="custom-container-title">WARNING</p><p>使用 <code>setup</code> 的情况下，请牢记一点：不能再用 <code>this</code> 来获取 Vue 实例，也就是无法通过 <code>this.xxx</code> 、 <code>this.fn()</code> 这样来获取实例上的数据，或者执行实例上的方法。</p><p>全新的 Vue 3 组件编写，请继续往下看，会一步一步做说明。</p></div><h3 id="setup-的参数使用" tabindex="-1"><a class="header-anchor" href="#setup-的参数使用" aria-hidden="true">#</a> setup 的参数使用</h3><p><code>setup</code> 函数包含了两个入参：</p><table><thead><tr><th style="text-align:left;">参数</th><th style="text-align:left;">类型</th><th style="text-align:left;">含义</th><th style="text-align:left;">是否必传</th></tr></thead><tbody><tr><td style="text-align:left;">props</td><td style="text-align:left;">object</td><td style="text-align:left;">由父组件传递下来的数据</td><td style="text-align:left;">否</td></tr><tr><td style="text-align:left;">context</td><td style="text-align:left;">object</td><td style="text-align:left;">组件的执行上下文</td><td style="text-align:left;">否</td></tr></tbody></table><p><strong>第一个参数 <code>props</code> ：</strong></p><p>它是响应式的（只要你不解构它，或者使用 <a href="#%E5%93%8D%E5%BA%94%E5%BC%8F-api-%E4%B9%8B-toref-%E4%B8%8E-torefs-new">toRef / toRefs</a> 进行响应式数据转换），当传入新的 prop 时，它将被更新。</p><p><strong>第二个参数 <code>context</code> ：</strong></p><p><code>context</code> 只是一个普通的对象，它暴露三个组件的 property：</p><table><thead><tr><th style="text-align:left;">属性</th><th style="text-align:left;">类型</th><th style="text-align:left;">作用</th></tr></thead><tbody><tr><td style="text-align:left;">attrs</td><td style="text-align:left;">非响应式对象</td><td style="text-align:left;">props 未定义的属性都将变成 attrs</td></tr><tr><td style="text-align:left;">slots</td><td style="text-align:left;">非响应式对象</td><td style="text-align:left;">插槽</td></tr><tr><td style="text-align:left;">emit</td><td style="text-align:left;">方法</td><td style="text-align:left;">触发事件</td></tr></tbody></table><p>因为 <code>context</code> 只是一个普通对象，所以你可以直接使用 ES6 解构。</p><p>平时使用可以通过直接传入 <code>{ emit }</code> ，即可用 <code>emit(&#39;xxx&#39;)</code> 来代替使用 <code>context.emit(&#39;xxx&#39;)</code>，另外两个功能也是如此。</p><p>但是 <code>attrs</code> 和 <code>slots</code> 请保持 <code>attrs.xxx</code>、<code>slots.xxx</code> 来使用他们数据，不要解构这两个属性，因为他们虽然不是响应式对象，但会随组件本身的更新而更新。</p><p>两个参数的具体使用，可以详细了解可查阅 <a href="/communication.html" class="">组件之间的通信</a> 一章。</p><h3 id="了解-definecomponent" tabindex="-1"><a class="header-anchor" href="#了解-definecomponent" aria-hidden="true">#</a> 了解 defineComponent</h3><p>这是 Vue 3 推出的一个全新 API ，<code>defineComponent</code> 可以用于 TypeScript 的类型推导，帮你简化掉很多编写过程中的类型定义。</p><p>比如，你原本需要这样才可以使用 <code>setup</code> 函数：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Slots <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token comment">// 声明 props 和 return 的数据类型</span>
<span class="token keyword">interface</span> <span class="token class-name">Data</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">unknown</span>
<span class="token punctuation">}</span>

<span class="token comment">// 声明 context 的类型</span>
<span class="token keyword">interface</span> <span class="token class-name">SetupContext</span> <span class="token punctuation">{</span>
  attrs<span class="token operator">:</span> Data
  slots<span class="token operator">:</span> Slots
  <span class="token function-variable function">emit</span><span class="token operator">:</span> <span class="token punctuation">(</span>event<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用的时候入参要加上声明， return 也要加上声明</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span>props<span class="token operator">:</span> Data<span class="token punctuation">,</span> context<span class="token operator">:</span> SetupContext<span class="token punctuation">)</span><span class="token operator">:</span> Data <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>是不是很繁琐？（肯定是啊！不用否定……</p><p>使用了 <code>defineComponent</code> 之后，你就可以省略这些类型定义：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>而且不只适用于 <code>setup</code>，只要是 Vue 本身的 API ，<code>defineComponent</code> 都可以自动帮你推导。</p><p>在编写组件的过程中，你只需要维护自己定义的数据类型就可以了，专注于业务。</p><h2 id="组件的生命周期-new" tabindex="-1"><a class="header-anchor" href="#组件的生命周期-new" aria-hidden="true">#</a> 组件的生命周期{new}</h2><p>在了解了两个前置知识点之后，也还不着急写组件，我们还需要先了解组件的生命周期，你才能够灵活的把控好每一处代码的执行结果达到你的预期。</p><h3 id="升级变化" tabindex="-1"><a class="header-anchor" href="#升级变化" aria-hidden="true">#</a> 升级变化</h3><p>从 Vue 2.x 升级到 3.x，在保留对 2.x 的生命周期支持的同时，3.x 也带来了一定的调整。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>Vue 2 的生命周期写法名称是 Options API ， Vue 3 新的生命周期写法名称是 Composition API 。</p><p>Vue 3 本身也支持 Options API 风格， Vue 2 也可以通过安装 <a href="https://www.npmjs.com/package/@vue/composition-api" target="_blank" rel="noopener noreferrer">@vue/composition-api<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 插件来使用 Composition API 。</p><p>但是从使用习惯上来说，我们后文也会用 2.x 的生命周期来代指 Options API 写法，用 3.x 的生命周期来代指 Composition API 写法。</p></div><p>生命周期的变化，可以直观的从下表了解：</p><table><thead><tr><th style="text-align:center;">2.x 生命周期</th><th style="text-align:center;">3.x 生命周期</th><th style="text-align:center;">执行时间说明</th></tr></thead><tbody><tr><td style="text-align:center;">beforeCreate</td><td style="text-align:center;">setup</td><td style="text-align:center;">组件创建前执行</td></tr><tr><td style="text-align:center;">created</td><td style="text-align:center;">setup</td><td style="text-align:center;">组件创建后执行</td></tr><tr><td style="text-align:center;">beforeMount</td><td style="text-align:center;">onBeforeMount</td><td style="text-align:center;">组件挂载到节点上之前执行</td></tr><tr><td style="text-align:center;">mounted</td><td style="text-align:center;">onMounted</td><td style="text-align:center;">组件挂载完成后执行</td></tr><tr><td style="text-align:center;">beforeUpdate</td><td style="text-align:center;">onBeforeUpdate</td><td style="text-align:center;">组件更新之前执行</td></tr><tr><td style="text-align:center;">updated</td><td style="text-align:center;">onUpdated</td><td style="text-align:center;">组件更新完成之后执行</td></tr><tr><td style="text-align:center;">beforeDestroy</td><td style="text-align:center;">onBeforeUnmount</td><td style="text-align:center;">组件卸载之前执行</td></tr><tr><td style="text-align:center;">destroyed</td><td style="text-align:center;">onUnmounted</td><td style="text-align:center;">组件卸载完成后执行</td></tr><tr><td style="text-align:center;">errorCaptured</td><td style="text-align:center;">onErrorCaptured</td><td style="text-align:center;">当捕获一个来自子孙组件的异常时激活钩子函数</td></tr></tbody></table><p>其中，在 3.x ，<code>setup</code> 的执行时机比 2.x 的 <code>beforeCreate</code> 和 <code>created</code> 还早，可以完全代替原来的这 2 个钩子函数。</p><p>另外，被包含在 <code>&lt;keep-alive&gt;</code> 中的组件，会多出两个生命周期钩子函数：</p><table><thead><tr><th style="text-align:center;">2.x 生命周期</th><th style="text-align:center;">3.x 生命周期</th><th style="text-align:center;">执行时间说明</th></tr></thead><tbody><tr><td style="text-align:center;">activated</td><td style="text-align:center;">onActivated</td><td style="text-align:center;">被激活时执行</td></tr><tr><td style="text-align:center;">deactivated</td><td style="text-align:center;">onDeactivated</td><td style="text-align:center;">切换组件后，原组件消失前执行</td></tr></tbody></table><div class="custom-container warning"><p class="custom-container-title">WARNING</p><p>虽然 Vue 3 依然支持 2.x 的生命周期，但是不建议混搭使用，前期你可以继续使用 2.x 的生命周期作为过度阶段慢慢适应，但还是<strong>建议尽快熟悉并完全使用 3.x 的生命周期来编写你的组件</strong>。</p></div><h3 id="使用-3-x-的生命周期" tabindex="-1"><a class="header-anchor" href="#使用-3-x-的生命周期" aria-hidden="true">#</a> 使用 3.x 的生命周期</h3><p>在 Vue 3 的 Composition API 写法里，<strong>每个生命周期函数都要先导入才可以使用</strong>，并且所有生命周期函数统一放在 <code>setup</code> 里运行。</p><p>如果你需要在达到 2.x 的 <code>beforeCreate</code> 和 <code>created</code> 目的的话，直接把函数执行在 <code>setup</code> 里即可。</p><p>比如：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> onBeforeMount<span class="token punctuation">,</span> onMounted <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token function">onBeforeMount</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>最终将按照生命周期的顺序输出：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 1</span>
<span class="token comment">// 4</span>
<span class="token comment">// 2</span>
<span class="token comment">// 3</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="组件的基本写法" tabindex="-1"><a class="header-anchor" href="#组件的基本写法" aria-hidden="true">#</a> 组件的基本写法</h2><p>如果你是从 Vue 2 就开始写 TypeScript 的话，应该知道在 Vue 2 的时候就已经有了 <code>Vue.extend</code> 和 <a href="https://class-component.vuejs.org/" target="_blank" rel="noopener noreferrer">Class Component<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 的基础写法；Vue 3 在保留 class 写法的同时，还推出了 <code>defineComponent</code> + Composition API 的新写法。</p><p>加上视图部分又有 Template 和 TSX 的写法、以及 3.x 对不同版本的生命周期兼容，累计下来，在 Vue 里写 TypeScript ，至少有 9 种不同的组合方式（我的认知内，未有更多的尝试），堪比孔乙己的回字（甚至吊打回字……</p><p>我们先来回顾一下这些写法组合分别是什么，了解一下 Vue 3 最好使用哪种写法：</p><h3 id="回顾-vue-2" tabindex="-1"><a class="header-anchor" href="#回顾-vue-2" aria-hidden="true">#</a> 回顾 Vue 2</h3><p>在 Vue 2 ，为了更好的 TS 推导，用的最多的还是 Class Component 的写法。</p><table><thead><tr><th style="text-align:center;">适用版本</th><th style="text-align:center;">基本写法</th><th style="text-align:center;">视图写法</th></tr></thead><tbody><tr><td style="text-align:center;">Vue 2</td><td style="text-align:center;">Vue.extend</td><td style="text-align:center;">Template</td></tr><tr><td style="text-align:center;">Vue 2</td><td style="text-align:center;">Class Component</td><td style="text-align:center;">Template</td></tr><tr><td style="text-align:center;">Vue 2</td><td style="text-align:center;">Class Component</td><td style="text-align:center;">TSX</td></tr></tbody></table><h3 id="了解-vue-3-new" tabindex="-1"><a class="header-anchor" href="#了解-vue-3-new" aria-hidden="true">#</a> 了解 Vue 3{new}</h3><p>目前 Vue 3 从官方对版本升级的态度来看， <code>defineComponent</code> 就是为了解决之前 Vue 2 对 TypeScript 类型推导不完善等问题而推出的， Vue 官方也是更希望大家习惯 <code>defineComponent</code> 的使用。</p><table><thead><tr><th style="text-align:center;">适用版本</th><th style="text-align:center;">基本写法</th><th style="text-align:center;">视图写法</th><th style="text-align:center;">生命周期版本</th><th style="text-align:center;">官方是否推荐</th></tr></thead><tbody><tr><td style="text-align:center;">Vue 3</td><td style="text-align:center;">Class Component</td><td style="text-align:center;">Template</td><td style="text-align:center;">2.x</td><td style="text-align:center;">×</td></tr><tr><td style="text-align:center;">Vue 3</td><td style="text-align:center;">defineComponent</td><td style="text-align:center;">Template</td><td style="text-align:center;">2.x</td><td style="text-align:center;">×</td></tr><tr><td style="text-align:center;">Vue 3</td><td style="text-align:center;">defineComponent</td><td style="text-align:center;">Template</td><td style="text-align:center;">3.x</td><td style="text-align:center;">√</td></tr><tr><td style="text-align:center;">Vue 3</td><td style="text-align:center;">Class Component</td><td style="text-align:center;">TSX</td><td style="text-align:center;">2.x</td><td style="text-align:center;">×</td></tr><tr><td style="text-align:center;">Vue 3</td><td style="text-align:center;">defineComponent</td><td style="text-align:center;">TSX</td><td style="text-align:center;">2.x</td><td style="text-align:center;">×</td></tr><tr><td style="text-align:center;">Vue 3</td><td style="text-align:center;">defineComponent</td><td style="text-align:center;">TSX</td><td style="text-align:center;">3.x</td><td style="text-align:center;">√</td></tr></tbody></table><p>我本来还想把每种写法都演示一遍，但写到这里，看到这么多种组合，我累了……</p><p>所以从接下来开始，都会以 Composition API + <code>defineComponent</code> + <code>&lt;template&gt;</code> 的写法，并且按照 3.x 的生命周期来作为示范案例。</p><p>接下来，使用 Composition API 来编写组件，先来实现一个最简单的 <code>Hello World!</code>。</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>msg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{ msg }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token string">&#39;Hello World!&#39;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      msg<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">scoped</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.msg</span> <span class="token punctuation">{</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>和 Vue 2 一样，都是 <code>&lt;template&gt;</code> + <code>&lt;script&gt;</code> + <code>&lt;style&gt;</code> 三段式组合，上手非常简单。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>需要注意的是，在 Vue 3 的 <code>defineComponent</code> 写法里，只要你的数据要在 <code>&lt;template&gt;</code> 中使用，就必须在 <code>setup</code> 里 <code>return</code> 出去。</p><p>当然，只在函数中调用到，而不需要渲染到模板里的，则无需 <code>return</code> 。</p></div><p>Template 部分和 Vue 2 可以说是完全一样（会有一些不同，比如 <code>&lt;router-link&gt;</code> 标签移除了 <code>tag</code> 属性等等，后面会在相应的小节进行说明）。</p><p>Style 则是根据你熟悉的预处理器或者原生 CSS 来写的，完全没有变化。</p><p>变化最大的就是 Script 部分了。</p><h2 id="响应式数据的变化-new" tabindex="-1"><a class="header-anchor" href="#响应式数据的变化-new" aria-hidden="true">#</a> 响应式数据的变化 {new}</h2><p>响应式数据是 MVVM 数据驱动编程的特色，相信大部分人当初入坑 MVVM 框架，都是因为响应式数据编程比传统的操作 DOM 要来得方便，而选择 Vue ，则是方便中的方便。</p><h3 id="设计上的变化" tabindex="-1"><a class="header-anchor" href="#设计上的变化" aria-hidden="true">#</a> 设计上的变化</h3><p>作为最重要的一个亮点， Vue 3 的响应式数据在设计上和 Vue 2 有着很大的不同。</p><h4 id="回顾-vue-2-1" tabindex="-1"><a class="header-anchor" href="#回顾-vue-2-1" aria-hidden="true">#</a> 回顾 Vue 2</h4><p>Vue 2 是使用了 <code>Object.defineProperty</code> 的 <code>getter/setter</code> 来实现数据的响应性，这个方法的具体用法可以参考 MDN 的文档： <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty" target="_blank" rel="noopener noreferrer">Object.defineProperty - MDN<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 。</p><p>这里我们用这个方法来实现一个简单的双向绑定 demo ，亲自试一下可以有更多的理解：</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>IE=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>DefineProperty Demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  
  <span class="token comment">&lt;!-- 输入框和按钮 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>input<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value javascript language-javascript">vm<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">&#39;Hello World&#39;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>设置为 Hello World<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 输入框和按钮 --&gt;</span>

  <span class="token comment">&lt;!-- 文本展示 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>output<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 文本展示 --&gt;</span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token comment">// 定义一个响应式数据</span>
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">&#39;text&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function">set</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#input&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value
        document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#output&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> value
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 处理输入行为</span>
    document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#input&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">oninput</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span>text <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>这个小 demo 实现了这两个功能：</p><ol><li>输入框的输入行为只修改 <code>vm.text</code> 的数据，但会同时更新 output 标签的文本内容</li><li>点击按钮修改 <code>vm.text</code> 的数据，也会触发输入框和 output 文本的更新</li></ol><p>当然 Vue 做了非常多的工作，而非只是简单的调用了 <code>Object.defineProperty</code> ，可以查阅 Vue 2 的官网文档了解更多关于 2.x 的响应式原理。</p><p>可以在 <a href="https://cn.vuejs.org/v2/guide/reactivity.html" target="_blank" rel="noopener noreferrer">深入 Vue 2 的响应式原理<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 了解更多这部分的内容。</p><h4 id="了解-vue-3" tabindex="-1"><a class="header-anchor" href="#了解-vue-3" aria-hidden="true">#</a> 了解 Vue 3</h4><p>Vue 3 是使用了 <code>Proxy</code> 的 <code>getter/setter</code> 来实现数据的响应性，这个方法的具体用法可以参考 MDN 的文档： <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy" target="_blank" rel="noopener noreferrer">Proxy - MDN<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 。</p><p>同样的，我们也来实现一个简单的双向绑定 demo ，这次用 <code>Proxy</code> 来实现：</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>IE=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Proxy Demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  
  <span class="token comment">&lt;!-- 输入框和按钮 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>input<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value javascript language-javascript">vm<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">&#39;Hello World&#39;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>设置为 Hello World<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 输入框和按钮 --&gt;</span>

  <span class="token comment">&lt;!-- 文本展示 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>output<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 文本展示 --&gt;</span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token comment">// 定义一个响应式数据</span>
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#input&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value
        document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#output&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> value
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 处理输入行为</span>
    document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#input&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">oninput</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span>text <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>实现的功能和 <code>Object.defineProperty</code> 的 demo 是完全一样的，而且也都是基于 <code>setter</code> 行为来完成我们的实现，那么为什么 Vue 3 要舍弃 <code>Object.defineProperty</code> ，换成 <code>Proxy</code> 呢？</p><p>主要原因在于 <code>Object.defineProperty</code> 有以下的不足：</p><ol><li>无法监听数组下标的变化，通过 <code>arr[i] = newValue</code> 这样的操作无法实时响应</li><li>无法监听数组长度的变化，例如通过 <code>arr.length = 10</code> 去修改数组长度，无法响应</li><li>只能监听对象的属性，对于整个对象需要遍历，特别是多级对象更是要通过嵌套来深度监听</li><li>使用 <code>Object.assign()</code> 等方法给对象添加新属性时，也不会触发更新</li><li>更多细节上的问题 …</li></ol><p>这也是为什么 Vue 2 要提供一个 <a href="https://cn.vuejs.org/v2/api/#Vue-set" target="_blank" rel="noopener noreferrer">Vue.set API<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 的原因，你可以在 <a href="https://v3.cn.vuejs.org/guide/change-detection.html" target="_blank" rel="noopener noreferrer">Vue 2 中更改检测的注意事项<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 了解更多说明。</p><p>而这些问题在 <code>Proxy</code> 都可以得到解决。</p><p>可以在 <a href="https://v3.cn.vuejs.org/guide/reactivity.html" target="_blank" rel="noopener noreferrer">深入 Vue 3 的响应式原理<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 了解更多这部分的内容。</p><h3 id="用法上的变化" tabindex="-1"><a class="header-anchor" href="#用法上的变化" aria-hidden="true">#</a> 用法上的变化</h3><p>本指南只使用 Composition API 来编写组件，这是使用 Vue 3 的最大优势。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>虽然官方文档做了一定的举例，但实际用起来还是会有一定的坑，比如可能你有些数据用着用着就失去了响应……</p><p>这些情况不是 bug ，_(:з)∠)_而是你用的姿势不对……</p><p>相对来说官方文档并不会那么细致的去提及各种场景的用法，包括在 TypeScript 中的类型定义，所以本章节主要通过踩坑心得的思路来复盘一下这些响应式数据的使用。</p></div><p>相对于 2.x 在 <code>data</code> 里定义后即可通过 <code>this.xxx</code> 来调用响应式数据，3.x 的生命周期里取消了 Vue 实例的 <code>this</code>，你要用到的比如 <code>ref</code> 、<code>reactive</code> 等响应式 API ，都必须通过导入才能使用，然后在 <code>setup</code> 里定义。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&#39;Hello World!&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      msg
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>由于新的 API 非常多，但有些使用场景却不多，所以当前暂时只对常用的几个 API 做使用和踩坑说明，更多的 API 可以在官网查阅。</p><p>先放上官方文档：<a href="https://v3.cn.vuejs.org/api/reactivity-api" target="_blank" rel="noopener noreferrer">响应性 API | Vue.js<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h2 id="响应式-api-之-ref-new" tabindex="-1"><a class="header-anchor" href="#响应式-api-之-ref-new" aria-hidden="true">#</a> 响应式 API 之 ref{new}</h2><p><code>ref</code> 是最常用的一个响应式 API，它可以用来定义所有类型的数据，包括 Node 节点。</p><p>没错，在 2.x 常用的 <code>this.$refs.xxx</code> 来取代 <code>document.querySelector(&#39;.xxx&#39;)</code> 获取 Node 节点的方式，也是用这个 API 来取代。</p><h3 id="类型声明" tabindex="-1"><a class="header-anchor" href="#类型声明" aria-hidden="true">#</a> 类型声明</h3><p>在开始使用 API 之前，要先了解一下在 TypeScript 中，<code>ref</code> 需要如何进行类型声明。</p><p>平时我们在定义变量的时候，都是这样给他们进行类型声明的：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 单类型</span>
<span class="token keyword">const</span> msg<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">&#39;Hello World!&#39;</span><span class="token punctuation">;</span>

<span class="token comment">// 多类型</span>
<span class="token keyword">const</span> phoneNumber<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token number">13800138000</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>但是在使用 <code>ref</code> 时，不能这样子声明，会报错，正确的声明方式应该是使用 <code>&lt;&gt;</code> 来包裹类型定义，紧跟在 <code>ref</code> API 之后：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 单类型</span>
<span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&#39;Hello World!&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 多类型</span>
<span class="token keyword">const</span> phoneNumber <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span> <span class="token operator">|</span> <span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">13800138000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="变量的定义" tabindex="-1"><a class="header-anchor" href="#变量的定义" aria-hidden="true">#</a> 变量的定义</h3><p>了解了如何进行类型声明之后，对变量的定义就没什么问题了，前面说了它可以用来定义所有类型的数据，包括 Node 节点，但不同类型的值之间还是有少许差异和注意事项，具体可以参考如下。</p><h4 id="基本类型" tabindex="-1"><a class="header-anchor" href="#基本类型" aria-hidden="true">#</a> 基本类型</h4><p>对字符串、布尔值等基本类型的定义方式，比较简单：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 字符串</span>
<span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&#39;Hello World!&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 数值</span>
<span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 布尔值</span>
<span class="token keyword">const</span> isVip <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="引用类型" tabindex="-1"><a class="header-anchor" href="#引用类型" aria-hidden="true">#</a> 引用类型</h4><p>对于对象、数组等引用类型也适用，比如要定义一个对象：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 声明对象的格式</span>
<span class="token keyword">interface</span> <span class="token class-name">Member</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个成员对象</span>
<span class="token keyword">const</span> userInfo <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span>Member<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">&#39;Tom&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>定义一个普通数组：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 数字数组</span>
<span class="token keyword">const</span> uids <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 字符串数组</span>
<span class="token keyword">const</span> names <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token string">&#39;Tom&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Petter&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Andy&#39;</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>定义一个对象数组：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 声明对象的格式</span>
<span class="token keyword">interface</span> <span class="token class-name">Member</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个成员组</span>
<span class="token keyword">const</span> memberList <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span>Member<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&#39;Tom&#39;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&#39;Petter&#39;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="dom-元素与子组件" tabindex="-1"><a class="header-anchor" href="#dom-元素与子组件" aria-hidden="true">#</a> DOM 元素与子组件</h3><p>除了可以定义数据，<code>ref</code> 也有我们熟悉的用途，就是用来挂载节点，也可以挂在子组件上。</p><p>对于 2.x 常用的 <code>this.$refs.xxx</code> 来获取 DOM 元素信息，该 API 的使用方式也是同样：</p><p>模板部分依然是熟悉的用法，把 ref 挂到你要引用的 DOM 上。</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 挂载DOM元素 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>msg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    留意该节点，有一个ref属性
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 挂载DOM元素 --&gt;</span>

  <span class="token comment">&lt;!-- 挂载子组件 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>child<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token comment">&lt;!-- 挂载子组件 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><code>script</code> 部分有三个最基本的注意事项：</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><ol><li><p>定义挂载节点后，也是必须通过 <code>xxx.value</code> 才能正确操作到挂载的 DOM 元素或组件（详见下方的<a href="#%E5%8F%98%E9%87%8F%E7%9A%84%E8%AF%BB%E5%8F%96%E4%B8%8E%E8%B5%8B%E5%80%BC">变量的读取与赋值</a>）；</p></li><li><p>请保证视图渲染完毕后再执行 DOM 或组件的相关操作（需要放到生命周期的 <code>onMounted</code> 或者 <code>nextTick</code> 函数里，这一点在 2.x 也是一样）；</p></li><li><p>该变量必须 <code>return</code> 出去才可以给到 <code>template</code> 使用（这一点是 3.x 生命周期的硬性要求，子组件的数据和方法如果要给父组件操作，也要 <code>return</code> 出来才可以）。</p></li></ol></div><p>配合上面的 <code>template</code> ，来看看 <code>script</code> 部分的具体例子：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> onMounted<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>
<span class="token keyword">import</span> Child <span class="token keyword">from</span> <span class="token string">&#39;@cp/Child.vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  components<span class="token operator">:</span> <span class="token punctuation">{</span>
    Child
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 定义挂载节点，声明的类型详见下方附表</span>
    <span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span>HTMLElement <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">typeof</span> Child <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 请保证视图渲染完毕后再执行节点操作 e.g. onMounted / nextTick</span>
    <span class="token function">onMounted</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 比如获取DOM的文本</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value<span class="token punctuation">.</span>innerText<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 或者操作子组件里的数据</span>
      child<span class="token punctuation">.</span>value<span class="token punctuation">.</span>isShowDialog <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 必须return出去才可以给到template使用</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      msg<span class="token punctuation">,</span>
      child
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>关于 DOM 和子组件的 TS 类型声明，可参考以下规则：</p><table><thead><tr><th style="text-align:left;">节点类型</th><th style="text-align:left;">声明类型</th><th style="text-align:left;">参考文档</th></tr></thead><tbody><tr><td style="text-align:left;">DOM 元素</td><td style="text-align:left;">使用 HTML 元素接口</td><td style="text-align:left;"><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document_Object_Model#html_%E5%85%83%E7%B4%A0%E6%8E%A5%E5%8F%A3" target="_blank" rel="noopener noreferrer">HTML 元素接口<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></td></tr><tr><td style="text-align:left;">子组件</td><td style="text-align:left;">使用 typeof 获取子组件的类型</td><td style="text-align:left;"><a href="https://zhuanlan.zhihu.com/p/311150643" target="_blank" rel="noopener noreferrer">typeof 操作符<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></td></tr></tbody></table><p>另外，关于这一小节，有一个可能会引起 TS 编译报错的情况是，新版本的脚手架创建出来的项目会默认启用 <code>--strictNullChecks</code> 选项，会导致案例中的代码无法正常运行（报错 <code>TS2531: Object is possibly &#39;null&#39;.</code> ）。</p><p>原因是：默认情况下 <code>null</code> 和 <code>undefined</code> 是所有类型的子类型，但开启了 <code>strictNullChecks</code> 选项之后，会使 <code>null</code> 和 <code>undefined</code> 只能赋值给 <code>void</code> 和它们各自，这虽然是个更为严谨的选项，但因此也会带来一些影响赶工期的额外操作。</p><p><strong>有以下几种解决方案可以参考：</strong></p><ol><li>在涉及到相关操作的时候，对节点变量增加一个判断：</li></ol><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span> child<span class="token punctuation">.</span>value <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 读取子组件的数据</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>value<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 执行子组件的方法</span>
  child<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token string">&#39;use if in onMounted&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="2"><li>通过 TS 的可选符 ? 来将目标设置为可选，避免出现错误（这个方式不能直接修改子组件数据的值）</li></ol><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 读取子组件的数据</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>value<span class="token operator">?.</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 执行子组件的方法</span>
child<span class="token punctuation">.</span>value<span class="token operator">?.</span><span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token string">&#39;use ? in onMounted&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="3"><li>在项目根目录下的 <code>tsconfig.json</code> 文件里，显式的关闭 <code>strictNullChecks</code> 选项，关闭后，由自己来决定是否需要对 <code>null</code> 进行判断：</li></ol><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;compilerOptions&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token property">&quot;strictNullChecks&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="4"><li>使用 any 类型来代替，但是写 TS 还是尽量不要使用 any ，满屏的 AnyScript 不如写回 JS 。</li></ol><h3 id="变量的读取与赋值" tabindex="-1"><a class="header-anchor" href="#变量的读取与赋值" aria-hidden="true">#</a> 变量的读取与赋值</h3><p>被 <code>ref</code> 包裹的变量会全部变成对象，不管你定义的是什么类型的值，都会转化为一个 ref 对象，其中 ref 对象具有指向内部值的单个 property <code>.value</code>。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>读取任何 ref 对象的值都必须通过 <code>xxx.value</code> 才可以正确获取到。</p></div><p>请牢记上面这句话，初拥 3.x 的同学很多 bug 都是由于这个问题引起的（包括我……</p><p>对于普通变量的值，读取的时候直接读变量名即可：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 读取一个字符串</span>
<span class="token keyword">const</span> msg<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">&#39;Hello World!&#39;</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;msg的值&#39;</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 读取一个数组</span>
<span class="token keyword">const</span> uids<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;第二个uid&#39;</span><span class="token punctuation">,</span> uids<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>对 ref 对象的值的读取，切记！必须通过 value ！</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 读取一个字符串</span>
<span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&#39;Hello World!&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;msg的值&#39;</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 读取一个数组</span>
<span class="token keyword">const</span> uids <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;第二个uid&#39;</span><span class="token punctuation">,</span> uids<span class="token punctuation">.</span>value<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>普通变量都必须使用 <code>let</code> 才可以修改值，由于 ref 对象是个引用类型，所以可以在 <code>const</code> 定义的时候，直接通过 <code>.value</code> 来修改。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 定义一个字符串变量</span>
<span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&#39;Hi!&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 1s后修改它的值</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  msg<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">&#39;Hello!&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>因此你在对接接口数据的时候，可以自由的使用 <code>forEach</code>、<code>map</code>、<code>filter</code> 等遍历函数来操作你的 ref 数组，或者直接重置它。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 提取接口的数据</span>
data<span class="token punctuation">.</span>value <span class="token operator">=</span> api<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>item<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>text <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 重置数组</span>
data<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>问我为什么突然要说这个？因为涉及到下一部分的知识，关于 <code>reactive</code> 的。</p><h2 id="响应式-api-之-reactive-new" tabindex="-1"><a class="header-anchor" href="#响应式-api-之-reactive-new" aria-hidden="true">#</a> 响应式 API 之 reactive{new}</h2><p><code>reactive</code> 是继 <code>ref</code> 之后最常用的一个响应式 API 了，相对于 <code>ref</code>，它的局限性在于只适合对象、数组。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>使用 <code>reactive</code> 的好处就是写法跟平时的对象、数组几乎一模一样，但它也带来了一些特殊注意点，请留意赋值部分的特殊说明。</p></div><h3 id="类型声明与定义" tabindex="-1"><a class="header-anchor" href="#类型声明与定义" aria-hidden="true">#</a> 类型声明与定义</h3><p><code>reactive</code> 的声明方式，以及定义方式，没有 <code>ref</code> 的变化那么大，就是和普通变量一样。</p><p>reactive 对象：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 声明对象的格式</span>
<span class="token keyword">interface</span> <span class="token class-name">Member</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个成员对象</span>
<span class="token keyword">const</span> userInfo<span class="token operator">:</span> Member <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">&#39;Tom&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>reactive 数组：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 普通数组</span>
<span class="token keyword">const</span> uids<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 对象数组</span>
<span class="token keyword">interface</span> <span class="token class-name">Member</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个成员对象数组</span>
<span class="token keyword">const</span> userList<span class="token operator">:</span> Member<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&#39;Tom&#39;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&#39;Petter&#39;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&#39;Andy&#39;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="变量的读取与赋值-1" tabindex="-1"><a class="header-anchor" href="#变量的读取与赋值-1" aria-hidden="true">#</a> 变量的读取与赋值</h3><p>reactive 对象在读取字段的值，或者修改值的时候，与普通对象是一样的。</p><p>reactive 对象：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 声明对象的格式</span>
<span class="token keyword">interface</span> <span class="token class-name">Member</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个成员对象</span>
<span class="token keyword">const</span> userInfo<span class="token operator">:</span> Member <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">&#39;Tom&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 读取用户名</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 修改用户名</span>
userInfo<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&#39;Petter&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>但是对于 reactive 数组，和普通数组会有一些区别。</p><p>先看看普通数组，重置，或者改变值，都是可以直接轻松的进行操作：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 定义一个普通数组</span>
<span class="token keyword">let</span> uids<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 从另外一个对象数组里提取数据过来</span>
uids <span class="token operator">=</span> api<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span> item <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>id <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 合并另外一个数组</span>
<span class="token keyword">let</span> newUids<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
uids <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>uids<span class="token punctuation">,</span> <span class="token operator">...</span>newUids<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 重置数组</span>
uids <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>在 2.x 的时候，你在操作数组时，完全可以和普通数组那样随意的处理数据的变化，依然能够保持响应性。</p><p>但在 3.x ，如果你使用 <code>reactive</code> 定义数组，则不能这么搞了，必须只使用那些不会改变引用地址的操作。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>按照原来的思维去使用 <code>reactive</code> 数组，会造成数据变了，但模板不会更新的 bug ，如果你遇到类似的情况，可以从这里去入手排查问题所在。</p></div><p>举个例子，比如你要从接口读取翻页数据的时候，通常要先重置数组，再异步添加数据：</p><p>如果你使用常规的重置，会导致这个变量失去响应性：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token doc-comment comment">/** 
 * 不推荐使用这种方式
 * 异步添加数据后，模板不会响应更新
 */</span>
<span class="token keyword">let</span> uids<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 丢失响应性的步骤</span>
uids <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 异步获取数据后，模板依然是空数组</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  uids<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>要让模板那边依然能够保持响应性，则必须在关键操作时，不破坏响应性 API 的存在。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token doc-comment comment">/** 
 * 不推荐使用这种方式
 * 异步添加数据后，模板不会响应更新
 */</span>
<span class="token keyword">let</span> uids<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 不会破坏响应性</span>
uids<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">// 异步获取数据后，模板可以正确的展示</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  uids<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="特别注意" tabindex="-1"><a class="header-anchor" href="#特别注意" aria-hidden="true">#</a> 特别注意</h3><p>不要对通过 <code>reactive</code> 定义的对象进行解构，解构后得到的变量会失去响应性。</p><p>比如这些情况，在 2s 后都得不到新的 name 信息：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> reactive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">interface</span> <span class="token class-name">Member</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 定义一个带有响应性的成员对象</span>
    <span class="token keyword">const</span> userInfo<span class="token operator">:</span> Member <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">&#39;Petter&#39;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2s后更新userInfo</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      userInfo<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&#39;Tom&#39;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 这个变量在2s后不会同步更新</span>
    <span class="token keyword">const</span> newUserInfo<span class="token operator">:</span> Member <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">...</span>userInfo<span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 这个变量在2s后不会再同步更新</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> userInfo<span class="token punctuation">;</span>

    <span class="token comment">// 这样return出去给模板用，在2s后也不会同步更新</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>userInfo
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h2 id="响应式-api-之-toref-与-torefs-new" tabindex="-1"><a class="header-anchor" href="#响应式-api-之-toref-与-torefs-new" aria-hidden="true">#</a> 响应式 API 之 toRef 与 toRefs{new}</h2><p>看到这里之前，应该对 <code>ref</code> 和 <code>reactive</code> 都有所了解了，为了方便开发者，Vue 3 还推出了 2 个与之相关的 API ，用于 <code>reactive</code> 向 <code>ref</code> 转换。</p><h3 id="各自的作用" tabindex="-1"><a class="header-anchor" href="#各自的作用" aria-hidden="true">#</a> 各自的作用</h3><p>两个 API 的拼写非常接近，顾名思义，一个是只转换一个字段，一个是转换所有字段。</p><table><thead><tr><th style="text-align:left;">API</th><th style="text-align:left;">作用</th></tr></thead><tbody><tr><td style="text-align:left;">toRef</td><td style="text-align:left;">创建一个新的ref变量，转换 reactive 对象的某个字段为ref变量</td></tr><tr><td style="text-align:left;">toRefs</td><td style="text-align:left;">创建一个新的对象，它的每个字段都是 reactive 对象各个字段的ref变量</td></tr></tbody></table><p>我们先定义好一个 <code>reactive</code> 变量：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">interface</span> <span class="token class-name">Member</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> userInfo<span class="token operator">:</span> Member <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">&#39;Petter&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>然后来看看这 2 个 API 应该怎么使用。</p><h3 id="使用-toref" tabindex="-1"><a class="header-anchor" href="#使用-toref" aria-hidden="true">#</a> 使用 toRef</h3><p><code>toRef</code> 接收 2 个参数，第一个是 <code>reactive</code> 对象, 第二个是要转换的 <code>key</code> 。</p><p>在这里我们只想转换 <code>userInfo</code> 里的 <code>name</code> ，只需要这样操作：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> name<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token function">toRef</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">,</span> <span class="token string">&#39;name&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>这样就成功创建了一个 <code>ref</code> 变量。</p><p>之后读取和赋值就使用 <code>name.value</code>，它会同时更新 <code>name</code> 和 <code>userInfo.name</code>。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>在 <code>toRef</code> 的过程中，如果使用了原对象上面不存在的 <code>key</code> ，那么定义出来的变量的 <code>value</code> 将会是 <code>undefined</code> 。</p><p>如果你对这个不存在的 <code>key</code> 的 <code>ref</code> 变量，进行了 <code>value</code> 赋值，那么原来的对象也会同步增加这个 <code>key</code>，其值也会同步更新。</p></div><h3 id="使用-torefs" tabindex="-1"><a class="header-anchor" href="#使用-torefs" aria-hidden="true">#</a> 使用 toRefs</h3><p><code>toRefs</code> 接收 1 个参数，是一个 <code>reactive</code> 对象。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> userInfoRefs<span class="token operator">:</span> Member <span class="token operator">=</span> <span class="token function">toRefs</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>这个新的 <code>userInfoRefs</code> ，本身是个普通对象，但是它的每个字段，都是与原来关联的 <code>ref</code> 变量。</p><h3 id="为什么要进行转换" tabindex="-1"><a class="header-anchor" href="#为什么要进行转换" aria-hidden="true">#</a> 为什么要进行转换</h3><p>关于为什么要出这么 2 个 API ，官方文档没有特别说明，不过经过自己的一些实际使用，以及在写上一节 <code>reactive</code> 的 <a href="#%E7%89%B9%E5%88%AB%E6%B3%A8%E6%84%8F">特别注意</a>，可能知道一些使用理由。</p><p><code>ref</code> 和 <code>reactive</code> 这两者的好处就不重复了，但是在使用的过程中，各自都有各自不方便的地方：</p><ol><li><p><code>ref</code> 虽然在 <code>template</code> 里使用起来方便，但比较烦的一点是在 <code>script</code> 里进行读取/赋值的时候，要一直记得加上 <code>.value</code> ，否则bug就来了</p></li><li><p><code>reactive</code> 虽然在使用的时候，因为你知道它本身是一个 <code>Object</code> 类型，所以你不会忘记 <code>foo.bar</code> 这样的格式去操作，但是在 <code>template</code> 渲染的时候，你又因此不得不每次都使用 <code>foo.bar</code> 的格式去渲染</p></li></ol><p>那么有没有办法，既可以在编写 <code>script</code> 的时候不容易出错，在写 <code>template</code> 的时候又比较简单呢？</p><p>于是， <code>toRef</code> 和 <code>toRefs</code> 因此诞生。</p><h3 id="什么场景下比较适合使用它们" tabindex="-1"><a class="header-anchor" href="#什么场景下比较适合使用它们" aria-hidden="true">#</a> 什么场景下比较适合使用它们</h3><p>从便利性和可维护性来说，最好只在功能单一、代码量少的组件里使用，比如一个表单组件，通常表单的数据都放在一个对象里。</p><p>当然你也可以更猛一点就是把所有的数据都定义到一个 <code>data</code> 里，然后你再去 <code>data</code> 里面取…但是没有必要为了转换而转换。</p><h3 id="在业务中的具体运用" tabindex="-1"><a class="header-anchor" href="#在业务中的具体运用" aria-hidden="true">#</a> 在业务中的具体运用</h3><p>这一部分我一直用 <code>userInfo</code> 来当案例，那就继续以一个用户信息表的小 demo 来做这个的演示吧。</p><p><strong>在 <code>script</code> 部分：</strong></p><ol><li><p>先用 <code>reactive</code> 定义一个源数据，所有的数据更新，都是修改这个对象对应的值，按照对象的写法去维护你的数据</p></li><li><p>再通过 <code>toRefs</code> 定义一个给 <code>template</code> 用的对象，它本身不具备响应性，但是它的字段全部是 <code>ref</code> 变量</p></li><li><p>在 <code>return</code> 的时候，对 <code>toRefs</code> 对象进行解构，这样导出去就是各个字段对应的 <code>ref</code> 变量，而不是一整个对象</p></li></ol><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> reactive<span class="token punctuation">,</span> toRefs <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">interface</span> <span class="token class-name">Member</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  age<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  gender<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 定义一个reactive对象</span>
    <span class="token keyword">const</span> userInfo <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">&#39;Petter&#39;</span><span class="token punctuation">,</span>
      age<span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
      gender<span class="token operator">:</span> <span class="token string">&#39;male&#39;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 定义一个新的对象，它本身不具备响应性，但是它的字段全部是ref变量</span>
    <span class="token keyword">const</span> userInfoRefs <span class="token operator">=</span> <span class="token function">toRefs</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2s后更新userInfo</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      userInfo<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
      userInfo<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&#39;Tom&#39;</span><span class="token punctuation">;</span>
      userInfo<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 在这里结构toRefs对象才能继续保持响应式</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>userInfoRefs
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p><strong>在 <code>template</code> 部分：</strong></p><p>由于 <code>return</code> 出来的都是 <code>ref</code> 变量，所以你在模板里直接使用 <code>userInfo</code> 各个字段的 <code>key</code> 即可。</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>user-info<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>key<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>ID:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>value<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{ id }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>key<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>name:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>value<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{ name }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>key<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>age:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>value<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{ age }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>key<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>gender:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>value<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{ gender }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="需要注意的问题" tabindex="-1"><a class="header-anchor" href="#需要注意的问题" aria-hidden="true">#</a> 需要注意的问题</h3><p>请注意是否有相同命名的变量存在，比如上面在 <code>return</code> 给 <code>template</code> 使用时，解构 <code>userInfoRefs</code> 的时候已经包含了一个 <code>name</code> 字段，此时如果还有一个单独的变量也叫 <code>name</code>。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>那么他们谁会生效，取决于谁排在后面。</p><p>因为 <code>return</code> 出去的其实是一个对象，在对象里，如果存在相同的 <code>key</code> ，则后面那个会覆盖前面的。</p></div><p>这种情况下，会以单独定义的 <code>name</code> 为渲染数据。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">return</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>userInfoRefs<span class="token punctuation">,</span>
  name
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这种情况下，则是以 <code>userInfoRefs</code> 里的 <code>name</code> 为渲染数据。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">return</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">,</span>
  <span class="token operator">...</span>userInfoRefs
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>所以当你决定使用 <code>toRef</code> 和 <code>toRefs</code> 的时候，请注意这个特殊情况！</p><h2 id="函数的定义和使用-new" tabindex="-1"><a class="header-anchor" href="#函数的定义和使用-new" aria-hidden="true">#</a> 函数的定义和使用{new}</h2><p>在了解了响应式数据如何使用之后，接下来就要开始了解函数了。</p><p>在 2.x，函数都是放在 <code>methods</code> 对象里定义，然后再在 <code>mounted</code> 等生命周期或者模板里通过 <code>click</code> 使用。</p><p>但在 3.x 的生命周期里，和数据的定义一样，都是通过 <code>setup</code> 来完成。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><ol><li><p>你可以在 <code>setup</code> 里定义任意类型的函数（普通函数、class 类、箭头函数、匿名函数等等）</p></li><li><p>需要自动执行的函数，执行时机需要遵循生命周期</p></li><li><p>需要暴露给模板去通过 <code>click</code>、<code>change</code> 等行为来触发的函数，需要把函数名在 <code>setup</code> 里进行 <code>return</code> 才可以在模板里使用</p></li></ol></div><p>简单写一下例子：</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{{ msg }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

  <span class="token comment">&lt;!-- 在这里点击执行return出来的方法 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>changeMsg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>修改MSG<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 在这里点击执行return出来的方法 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> onMounted<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> msg <span class="token operator">=</span> ref<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">&#39;Hello World!&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 这个要暴露给模板使用，必须return才可以使用</span>
    <span class="token keyword">function</span> <span class="token function">changeMsg</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      msg<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">&#39;Hi World!&#39;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 这个要在页面载入时执行，无需return出去</span>
    <span class="token keyword">const</span> <span class="token function-variable function">init</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;init&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 在这里执行init</span>
    <span class="token function">onMounted</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token comment">// 数据</span>
      msg<span class="token punctuation">,</span>

      <span class="token comment">// 方法</span>
      changeMsg
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><h2 id="数据的监听-new" tabindex="-1"><a class="header-anchor" href="#数据的监听-new" aria-hidden="true">#</a> 数据的监听{new}</h2><p>监听数据变化也是组件里的一项重要工作，比如监听路由变化、监听参数变化等等。</p><p>Vue 3 在保留原来的 <code>watch</code> 功能之外，还新增了一个 <code>watchEffect</code> 帮助我们更简单的进行监听。</p><h3 id="watch" tabindex="-1"><a class="header-anchor" href="#watch" aria-hidden="true">#</a> watch</h3><p>在 Vue 3 ，新版的 <code>watch</code> 和 Vue 2 的旧版写法对比，在使用方式上变化非常大！</p><h4 id="回顾-vue-2-2" tabindex="-1"><a class="header-anchor" href="#回顾-vue-2-2" aria-hidden="true">#</a> 回顾 Vue 2</h4><p>在 Vue 2 是这样用的，和 <code>data</code> 、 <code>methods</code> 都在同级配置：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 注意这里，放在 data 、 methods 同个级别</span>
  watch<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  methods<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>并且类型繁多，选项式 API 的类型如下：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code>watch<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">Function</span> <span class="token operator">|</span> Object <span class="token operator">|</span> <span class="token builtin">Array</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>联合类型过多，意味着用法复杂，下面是个很好的例子，虽然出自 <a href="https://v3.cn.vuejs.org/api/options-data.html#watch" target="_blank" rel="noopener noreferrer">官网<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 的用法介绍，但也反映出来对初学者不太友好，初次接触可能会觉得一头雾水：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      b<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      c<span class="token operator">:</span> <span class="token punctuation">{</span>
        d<span class="token operator">:</span> <span class="token number">4</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      e<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      f<span class="token operator">:</span> <span class="token number">6</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  watch<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 侦听顶级 property</span>
    <span class="token function">a</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">new: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>val<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, old: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>oldVal<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 字符串方法名</span>
    b<span class="token operator">:</span> <span class="token string">&#39;someMethod&#39;</span><span class="token punctuation">,</span>
    <span class="token comment">// 该回调会在任何被侦听的对象的 property 改变时被调用，不论其被嵌套多深</span>
    c<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">handler</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;c changed&#39;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      deep<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 侦听单个嵌套 property</span>
    <span class="token string-property property">&#39;c.d&#39;</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>val<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// do something</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 该回调将会在侦听开始之后被立即调用</span>
    e<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">handler</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;e changed&#39;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      immediate<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 你可以传入回调数组，它们会被逐一调用</span>
    f<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&#39;handle1&#39;</span><span class="token punctuation">,</span>
      <span class="token keyword">function</span> <span class="token function">handle2</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;handle2 triggered&#39;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">handle3</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;handle3 triggered&#39;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/* ... */</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  methods<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">someMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;b changed&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">handle1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;handle 1 triggered&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p>当然肯定也会有人觉得这样选择多是个好事，选择适合自己的就好，但我个人还是感觉，这种写法对于初学者来说不是那么友好，有些过于复杂化，如果一个用法可以适应各种各样的场景，岂不是更妙？</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>另外需要注意的是，不能使用箭头函数来定义 watcher 函数 (例如 <code>searchQuery: newValue =&gt; this.updateAutocomplete(newValue)</code> )。</p><p>因为箭头函数绑定了父级作用域的上下文，所以 <code>this</code> 将不会按照期望指向组件实例， <code>this.updateAutocomplete</code> 将是 <code>undefined</code> 。</p></div><p>Vue 2 也可以通过 <code>this.$watch()</code> 这个 API 的用法来实现对某个数据的监听，它接受三个参数： <code>source</code> 、 <code>callback</code> 和 <code>options</code> 。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 生命周期钩子</span>
  <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span><span class="token string">&#39;a&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>newVal<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>由于 <code>this.$watch</code> 的用法和 Vue 3 比较接近，所以这里不做过多的回顾，请直接看 <a href="#%E4%BA%86%E8%A7%A3-vue-3-1">了解 Vue 3</a> 部分。</p><h4 id="了解-vue-3-1" tabindex="-1"><a class="header-anchor" href="#了解-vue-3-1" aria-hidden="true">#</a> 了解 Vue 3</h4><p>在 Vue 3 的组合式 API 写法， <code>watch</code> 是一个可以接受 3 个参数的函数（保留了 Vue 2 的 <code>this.$watch</code> 这种用法），在使用层面上简单了好多。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> watch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token comment">// 一个用法走天下</span>
<span class="token function">watch</span><span class="token punctuation">(</span>
  source<span class="token punctuation">,</span> <span class="token comment">// 必传，要监听的数据源</span>
  callback<span class="token punctuation">,</span> <span class="token comment">// 必传，监听到变化后要执行的回调函数</span>
  <span class="token comment">// options // 可选，一些监听选项</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>下面的内容都基于 Vue 3 的组合式 API 用法展开讲解。</p><h4 id="api-的-ts-类型" tabindex="-1"><a class="header-anchor" href="#api-的-ts-类型" aria-hidden="true">#</a> API 的 TS 类型</h4><p>在了解用法之前，先对它的 TS 类型定义做一个简单的了解， watch 作为组合式 API ，根据使用方式有两种类型定义：</p><ol><li>基础用法的 TS 类型，详见 <a href="#%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95">基础用法</a> 部分</li></ol><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// watch 部分的 TS 类型</span>
<span class="token comment">// ...</span>
<span class="token keyword">export</span> <span class="token keyword">declare</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">watch</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> Immediate <span class="token keyword">extends</span> Readonly<span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  source<span class="token operator">:</span> WatchSource<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  cb<span class="token operator">:</span> WatchCallback<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> Immediate <span class="token keyword">extends</span> <span class="token class-name"><span class="token boolean">true</span></span> <span class="token operator">?</span> <span class="token constant">T</span> <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> <span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  options<span class="token operator">?</span><span class="token operator">:</span> WatchOptions<span class="token operator">&lt;</span>Immediate<span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token operator">:</span> WatchStopHandle
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol start="2"><li>批量监听的 TS 类型，详见 <a href="#%E6%89%B9%E9%87%8F%E7%9B%91%E5%90%AC">批量监听</a> 部分</li></ol><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// watch 部分的 TS 类型</span>
<span class="token comment">// ...</span>
<span class="token keyword">export</span> <span class="token keyword">declare</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">watch</span><span class="token generic class-name"><span class="token operator">&lt;</span>
  <span class="token constant">T</span> <span class="token keyword">extends</span> MultiWatchSources<span class="token punctuation">,</span>
  Immediate <span class="token keyword">extends</span> Readonly<span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  sources<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token constant">T</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  cb<span class="token operator">:</span> WatchCallback<span class="token operator">&lt;</span>MapSources<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> MapSources<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> Immediate<span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
  options<span class="token operator">?</span><span class="token operator">:</span> WatchOptions<span class="token operator">&lt;</span>Immediate<span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token operator">:</span> WatchStopHandle

<span class="token comment">// MultiWatchSources 是一个数组</span>
<span class="token keyword">declare</span> <span class="token keyword">type</span> <span class="token class-name">MultiWatchSources</span> <span class="token operator">=</span> <span class="token punctuation">(</span>WatchSource<span class="token operator">&lt;</span><span class="token builtin">unknown</span><span class="token operator">&gt;</span> <span class="token operator">|</span> object<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>但是不管是基础用法还是批量监听，可以看到这个 API 都是接受 3 个入参：</p><table><thead><tr><th style="text-align:center;">参数</th><th style="text-align:center;">是否可选</th><th style="text-align:left;">含义</th></tr></thead><tbody><tr><td style="text-align:center;">source</td><td style="text-align:center;">必传</td><td style="text-align:left;">数据源（详见：<a href="#%E8%A6%81%E7%9B%91%E5%90%AC%E7%9A%84%E6%95%B0%E6%8D%AE%E6%BA%90">要监听的数据源</a>）</td></tr><tr><td style="text-align:center;">callback</td><td style="text-align:center;">必传</td><td style="text-align:left;">监听到变化后要执行的回调函数（详见：<a href="#%E7%9B%91%E5%90%AC%E5%90%8E%E7%9A%84%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0">监听后的回调函数</a>）</td></tr><tr><td style="text-align:center;">options</td><td style="text-align:center;">可选</td><td style="text-align:left;">一些监听选项（详见：<a href="#%E7%9B%91%E5%90%AC%E7%9A%84%E9%80%89%E9%A1%B9">监听的选项</a>）</td></tr></tbody></table><p>并返回一个可以用来停止监听的函数（详见：<a href="#%E5%81%9C%E6%AD%A2%E7%9B%91%E5%90%AC">停止监听</a>）。</p><h4 id="要监听的数据源" tabindex="-1"><a class="header-anchor" href="#要监听的数据源" aria-hidden="true">#</a> 要监听的数据源</h4><p>在上面 <a href="#api-%E7%9A%84-ts-%E7%B1%BB%E5%9E%8B">API 的 TS 类型</a> 已经对 watch API 的组成有一定的了解了，这里先对数据源的类型和使用限制做下说明。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>如果不提前了解，在使用的过程中可能会遇到 “监听了但没有反应” 的情况出现。</p><p>另外，这部分内容会先围绕基础用法展开说明，批量监听会在 <a href="#%E6%89%B9%E9%87%8F%E7%9B%91%E5%90%AC">批量监听</a> 部分单独说明。</p></div><p>watch API 的第 1 个参数 <code>source</code> 是要监听的数据源，它的 TS 类型如下：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// watch 第 1 个入参的 TS 类型</span>
<span class="token comment">// ...</span>
<span class="token keyword">export</span> <span class="token keyword">declare</span> <span class="token keyword">type</span> <span class="token class-name">WatchSource<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> Ref<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">|</span> ComputedRef<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span><span class="token punctuation">)</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>可以看到能够用于监听的数据，是通过 <a href="#%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%E7%9A%84%E5%8F%98%E5%8C%96-new">响应式 API</a> 定义的变量（ <code>Ref&lt;T&gt;</code> ），或者是一个 <a href="#%E6%95%B0%E6%8D%AE%E7%9A%84%E8%AE%A1%E7%AE%97-new">计算数据</a> （ <code>ComputedRef&lt;T&gt;</code> ），或者是一个 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Functions/get" target="_blank" rel="noopener noreferrer">getter 函数<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> （ <code>() =&gt; T</code> ）。</p><p>所以要想定义的 watch 能够做出预期的行为，数据源必须具备响应性或者是一个 getter ，如果只是通过 <code>let</code> 定义一个普通变量，然后去改变这个变量的值，这样是无法监听的。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>如果要监听响应式对象里面的某个值（这种情况下对象本身是响应式，但它的 property 不是），需要写成 getter 函数，简单的说就是需要写成有返回值的函数，这个函数 return 你要监听的数据， e.g. <code>() =&gt; foo.bar</code> ，可以结合下方 <a href="#%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95">基础用法</a> 的例子一起理解。</p></div><h4 id="监听后的回调函数" tabindex="-1"><a class="header-anchor" href="#监听后的回调函数" aria-hidden="true">#</a> 监听后的回调函数</h4><p>在上面 <a href="#api-%E7%9A%84-ts-%E7%B1%BB%E5%9E%8B">API 的 TS 类型</a> 介绍了 watch API 的组成，和数据源一样，先了解一下回调函数的定义。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>和数据源部分一样，回调函数的内容也是会先围绕基础用法展开说明，批量监听会在 <a href="#%E6%89%B9%E9%87%8F%E7%9B%91%E5%90%AC">批量监听</a> 部分单独说明。</p></div><p>watch API 的第 2 个参数 <code>callback</code> 是监听到数据变化时要做出的行为，它的 TS 类型如下：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// watch 第 2 个入参的 TS 类型</span>
<span class="token comment">// ...</span>
<span class="token keyword">export</span> <span class="token keyword">declare</span> <span class="token keyword">type</span> <span class="token class-name">WatchCallback<span class="token operator">&lt;</span><span class="token constant">V</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token constant">OV</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  value<span class="token operator">:</span> <span class="token constant">V</span><span class="token punctuation">,</span>
  oldValue<span class="token operator">:</span> <span class="token constant">OV</span><span class="token punctuation">,</span>
  onCleanup<span class="token operator">:</span> OnCleanup
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>乍一看它有三个参数，但实际上这些参数不是你自己定义的，而是 watch API 传给你的，所以不管你用或者不用，它们都在那里：</p><table><thead><tr><th style="text-align:left;">参数</th><th style="text-align:left;">作用</th></tr></thead><tbody><tr><td style="text-align:left;">value</td><td style="text-align:left;">变化后的新值，类型和数据源保持一致</td></tr><tr><td style="text-align:left;">oldValue</td><td style="text-align:left;">变化前的旧值，类型和数据源保持一致</td></tr><tr><td style="text-align:left;">onCleanup</td><td style="text-align:left;">注册一个清理函数，详见 <a href="#%E7%9B%91%E5%90%AC%E6%95%88%E6%9E%9C%E6%B8%85%E7%90%86">监听效果清理</a> 部分</td></tr></tbody></table><p>注意：第一个参数是新值，第二个才是原来的旧值！</p><p>如同其他 JS 函数，在使用 watch 的回调函数时，可以对这三个参数任意命名，比如把 <code>value</code> 命名为你觉得更容易理解的 <code>newValue</code> 。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>如果监听的数据源是一个 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Data_structures#%E5%AF%B9%E8%B1%A1" target="_blank" rel="noopener noreferrer">引用类型<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 时（ e.g. <code>Object</code> 、 <code>Array</code> 、 <code>Date</code> … ）， <code>value</code> 和 <code>oldValue</code> 是完全相同的，因为指向同一个对象。</p></div><p>另外，默认情况下，<code>watch</code> 是惰性的，也就是只有当被监听的数据源发生变化时才执行回调。</p><h4 id="基础用法" tabindex="-1"><a class="header-anchor" href="#基础用法" aria-hidden="true">#</a> 基础用法</h4><p>来到这里，对 2 个必传的参数都有一定的了解了，我们先看看基础的用法，也就是日常最常编写的方案，我们只需要先关注前 2 个必传的参数。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 不要忘了导入要用的 API</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> reactive<span class="token punctuation">,</span> watch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 定义一个响应式数据</span>
    <span class="token keyword">const</span> userInfo <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">&#39;Petter&#39;</span><span class="token punctuation">,</span>
      age<span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 2s后改变数据</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      userInfo<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&#39;Tom&#39;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>

    <span class="token doc-comment comment">/**
     * 可以直接监听这个响应式对象
     * callback 的参数如果不用可以不写
     */</span>
    <span class="token function">watch</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;监听整个 userInfo &#39;</span><span class="token punctuation">,</span> userInfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token doc-comment comment">/**
     * 也可以监听对象里面的某个值
     * 此时数据源需要写成 getter 函数
     */</span>
    <span class="token function">watch</span><span class="token punctuation">(</span>
      <span class="token comment">// 数据源，getter 形式</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> userInfo<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
      <span class="token comment">// 回调函数 callback</span>
      <span class="token punctuation">(</span>newValue<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;只监听 name 的变化 &#39;</span><span class="token punctuation">,</span> userInfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;打印变化前后的值&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> oldValue<span class="token punctuation">,</span> newValue <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>一般的业务场景，基础用法足以面对。</p><p>如果你有多个数据源要监听，并且监听到变化后要执行的行为一样，那么可以使用 <a href="#%E6%89%B9%E9%87%8F%E7%9B%91%E5%90%AC">批量监听</a> 。</p><p>特殊的情况下，你可以搭配 <a href="#%E7%9B%91%E5%90%AC%E7%9A%84%E9%80%89%E9%A1%B9">监听的选项</a> 做一些特殊的用法，详见下面部分的内容。</p><h4 id="批量监听" tabindex="-1"><a class="header-anchor" href="#批量监听" aria-hidden="true">#</a> 批量监听</h4><p>如果你有多个数据源要监听，并且监听到变化后要执行的行为一样，第一反应可能是这样来写：</p><ol><li>抽离相同的处理行为为公共函数</li><li>然后定义多个监听操作，传入这个公共函数</li></ol><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> watch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment">// 2s后改变数据</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 来到这里才会触发 watch 的回调</span>
      message<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">&#39;Hello World!&#39;</span>
      index<span class="token punctuation">.</span>value<span class="token operator">++</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>

    <span class="token comment">// 抽离相同的处理行为为公共函数</span>
    <span class="token keyword">const</span> handleWatch <span class="token operator">=</span> <span class="token punctuation">(</span>
      newValue<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
      oldValue<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span>
    <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> newValue<span class="token punctuation">,</span> oldValue <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 然后定义多个监听操作，传入这个公共函数</span>
    <span class="token function">watch</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> handleWatch<span class="token punctuation">)</span>
    <span class="token function">watch</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> handleWatch<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br></div><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>这样写其实没什么问题，不过除了抽离公共代码的写法之外， watch API 还提供了一个批量监听的用法，和 <a href="#%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95">基础用法</a> 的区别在于，数据源和回调参数都变成了数组的形式。</p><p>数据源：以数组的形式传入，里面每一项都是一个响应式数据。</p><p>回调参数：原来的 <code>value</code> 和 <code>newValue</code> 也都变成了数组，每个数组里面的顺序和数据源数组排序一致。</p><p>可以看下面的这个例子更为直观：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> watch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 定义多个数据源</span>
    <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment">// 2s后改变数据</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      message<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">&#39;Hello World!&#39;</span>
      index<span class="token punctuation">.</span>value<span class="token operator">++</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>

    <span class="token function">watch</span><span class="token punctuation">(</span>
      <span class="token comment">// 数据源改成了数组</span>
      <span class="token punctuation">[</span>message<span class="token punctuation">,</span> index<span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token comment">// 回调的入参也变成了数组，每个数组里面的顺序和数据源数组排序一致</span>
      <span class="token punctuation">(</span><span class="token punctuation">[</span>newMessage<span class="token punctuation">,</span> newIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>oldMessage<span class="token punctuation">,</span> oldIndex<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;message 的变化&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> newMessage<span class="token punctuation">,</span> oldMessage <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;index 的变化&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> newIndex<span class="token punctuation">,</span> oldIndex <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><div class="highlight-line"> </div><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>什么情况下可能会用到批量监听呢？比如一个子组件有多个 props ，当有任意一个 prop 发生变化时，都需要执行初始化函数重置组件的状态，那么这个时候就可以用上这个功能啦！</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>在适当的业务场景，你也可以使用 <a href="#watchEffect">watchEffect</a> 来完成批量监听，但请留意 <a href="#%E5%92%8C-watch-%E7%9A%84%E5%8C%BA%E5%88%AB">功能区别</a> 部分的说明。</p></div><h4 id="监听的选项" tabindex="-1"><a class="header-anchor" href="#监听的选项" aria-hidden="true">#</a> 监听的选项</h4><p>在 <a href="#api-%E7%9A%84-ts-%E7%B1%BB%E5%9E%8B">API 的 TS 类型</a> 里提到， watch API 还接受第 3 个参数 <code>options</code> ，可选的一些监听选项。</p><p>它的 TS 类型如下：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// watch 第 3 个入参的 TS 类型</span>
<span class="token comment">// ...</span>
<span class="token keyword">export</span> <span class="token keyword">declare</span> <span class="token keyword">interface</span> <span class="token class-name">WatchOptions<span class="token operator">&lt;</span>Immediate <span class="token operator">=</span> <span class="token builtin">boolean</span><span class="token operator">&gt;</span></span>
  <span class="token keyword">extends</span> <span class="token class-name">WatchOptionsBase</span> <span class="token punctuation">{</span>
  immediate<span class="token operator">?</span><span class="token operator">:</span> Immediate
  deep<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>

<span class="token comment">// 继承的 base 类型</span>
<span class="token keyword">export</span> <span class="token keyword">declare</span> <span class="token keyword">interface</span> <span class="token class-name">WatchOptionsBase</span> <span class="token keyword">extends</span> <span class="token class-name">DebuggerOptions</span> <span class="token punctuation">{</span>
  flush<span class="token operator">?</span><span class="token operator">:</span> <span class="token string">&#39;pre&#39;</span> <span class="token operator">|</span> <span class="token string">&#39;post&#39;</span> <span class="token operator">|</span> <span class="token string">&#39;sync&#39;</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>

<span class="token comment">// 继承的 debugger 选项类型</span>
<span class="token keyword">export</span> <span class="token keyword">declare</span> <span class="token keyword">interface</span> <span class="token class-name">DebuggerOptions</span> <span class="token punctuation">{</span>
  onTrack<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>event<span class="token operator">:</span> DebuggerEvent<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
  onTrigger<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>event<span class="token operator">:</span> DebuggerEvent<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><code>options</code> 是一个对象的形式传入，有以下几个选项：</p><table><thead><tr><th style="text-align:center;">选项</th><th style="text-align:center;">类型</th><th style="text-align:center;">默认值</th><th style="text-align:center;">可选值</th><th style="text-align:left;">作用</th></tr></thead><tbody><tr><td style="text-align:center;">deep</td><td style="text-align:center;">boolean</td><td style="text-align:center;">false</td><td style="text-align:center;">true | false</td><td style="text-align:left;">是否进行深度监听</td></tr><tr><td style="text-align:center;">immediate</td><td style="text-align:center;">boolean</td><td style="text-align:center;">false</td><td style="text-align:center;">true | false</td><td style="text-align:left;">是否立即执行监听回调</td></tr><tr><td style="text-align:center;">flush</td><td style="text-align:center;">string</td><td style="text-align:center;">&#39;pre&#39;</td><td style="text-align:center;">&#39;pre&#39; | &#39;post&#39; | &#39;sync&#39;</td><td style="text-align:left;">控制监听回调的调用时机</td></tr><tr><td style="text-align:center;">onTrack</td><td style="text-align:center;">(e) =&gt; void</td><td style="text-align:center;"></td><td style="text-align:center;"></td><td style="text-align:left;">在数据源被追踪时调用</td></tr><tr><td style="text-align:center;">onTrigger</td><td style="text-align:center;">(e) =&gt; void</td><td style="text-align:center;"></td><td style="text-align:center;"></td><td style="text-align:left;">在监听回调被触发时调用</td></tr></tbody></table><p>其中 <code>onTrack</code> 和 <code>onTrigger</code> 的 <code>e</code> 是 debugger 事件，建议在回调内放置一个 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/debugger" target="_blank" rel="noopener noreferrer">debugger 语句<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 以调试依赖，这两个选项仅在开发模式下生效。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>deep 默认是 <code>false</code> ，但是在监听 reactive 对象或数组时，会默认为 <code>true</code> ，详见 <a href="#%E7%9B%91%E5%90%AC%E9%80%89%E9%A1%B9%E4%B9%8B-deep">监听选项之 deep</a>。</p></div><h4 id="监听选项之-deep" tabindex="-1"><a class="header-anchor" href="#监听选项之-deep" aria-hidden="true">#</a> 监听选项之 deep</h4><p><code>deep</code> 选项接受一个布尔值，可以设置为 <code>true</code> 开启深度监听，或者是 <code>false</code> 关闭深度监听，默认情况下这个选项是 <code>false</code> 关闭深度监听的，但也存在特例。</p><p>设置为 <code>false</code> 的情况下，如果直接监听一个响应式的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Data_structures#%E5%AF%B9%E8%B1%A1" target="_blank" rel="noopener noreferrer">引用类型<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 数据（e.g. <code>Object</code> 、 <code>Array</code> … ），虽然它的属性的值有变化，但对其本身来说是不变的，所以不会触发 watch 的 callback 。</p><p>下面是一个关闭了深度监听的例子：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> watch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 定义一个响应式数据，注意我是用的 ref 来定义</span>
    <span class="token keyword">const</span> nums <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment">// 2s后给这个数组添加项目</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      nums<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

      <span class="token comment">// 可以打印一下，确保数据确实变化了</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;修改后&#39;</span><span class="token punctuation">,</span> nums<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>

    <span class="token comment">// 但是这个 watch 不会按预期执行</span>
    <span class="token function">watch</span><span class="token punctuation">(</span>
      nums<span class="token punctuation">,</span>
      <span class="token comment">// 这里的 callback 不会被触发</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;触发监听&#39;</span><span class="token punctuation">,</span> nums<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// 因为关闭了 deep</span>
      <span class="token punctuation">{</span>
        deep<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br></div><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>类似这种情况，你需要把 <code>deep</code> 设置为 <code>true</code> 才可以触发监听。</p><p>可以看到我的例子特地用了 <a href="#%E5%93%8D%E5%BA%94%E5%BC%8F-api-%E4%B9%8B-ref-new">ref API</a> ，这是因为通过 <a href="#%E5%93%8D%E5%BA%94%E5%BC%8F-api-%E4%B9%8B-reactive-new">reactive API</a> 定义的对象无法将 <code>deep</code> 成功设置为 <code>false</code> （这一点在目前的官网文档未找到说明，最终是在 <a href="https://github.com/vuejs/core/blob/main/packages/runtime-core/src/apiWatch.ts#L212" target="_blank" rel="noopener noreferrer">watch API 的源码<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 上找到了答案）。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// ...</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">getter</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> source
  deep <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// 被强制开启了</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
</code></pre><div class="highlight-lines"><br><br><br><div class="highlight-line"> </div><br><br></div><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这个情况就是我说的 “特例” ，你可以通过 <code>isReactive</code> API 来判断是否需要手动开启深度监听。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 导入 isReactive API</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> isReactive<span class="token punctuation">,</span> reactive<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 监听这个数据时，会默认开启深度监听</span>
    <span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">&#39;Petter&#39;</span><span class="token punctuation">,</span>
      age<span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// true</span>

    <span class="token comment">// 监听这个数据时，不会默认开启深度监听</span>
    <span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">&#39;Petter&#39;</span><span class="token punctuation">,</span>
      age<span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h4 id="监听选项之-immediate" tabindex="-1"><a class="header-anchor" href="#监听选项之-immediate" aria-hidden="true">#</a> 监听选项之 immediate</h4><p>在 <a href="#%E7%9B%91%E5%90%AC%E5%90%8E%E7%9A%84%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0">监听后的回调函数</a> 部分有了解过， watch 默认是惰性的，也就是只有当被监听的数据源发生变化时才执行回调。</p><p>这句话是什么意思呢？来看一下这段代码，为了减少 <a href="#%E7%9B%91%E5%90%AC%E9%80%89%E9%A1%B9%E4%B9%8B-deep">deep</a> 选项的干扰，我们换一个类型，换成 <code>string</code> 数据来演示，请留意我的注释：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> watch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这个时候不会触发 watch 的回调</span>
    <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>

    <span class="token comment">// 2s后改变数据</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 来到这里才会触发 watch 的回调</span>
      message<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">&#39;Hello World!&#39;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>

    <span class="token function">watch</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;触发监听&#39;</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>可以看到，数据在初始化的时候并不会触发监听回调，如果有需要的话，通过 <code>immediate</code> 选项来让它直接触发。</p><p><code>immediate</code> 选项接受一个布尔值，默认是 <code>false</code> ，你可以设置为 <code>true</code> 让回调立即执行。</p><p>我们改成这样，请留意高亮的代码部分和新的注释：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> watch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这一次在这里可以会触发 watch 的回调了</span>
    <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>

    <span class="token comment">// 2s后改变数据</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这一次，这里是第二次触发 watch 的回调，不再是第一次</span>
      message<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">&#39;Hello World!&#39;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>

    <span class="token function">watch</span><span class="token punctuation">(</span>
      message<span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;触发监听&#39;</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// 设置 immediate 选项</span>
      <span class="token punctuation">{</span>
        immediate<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="highlight-lines"><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br></div><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>注意，在带有 immediate 选项时，不能在第一次回调时取消该数据源的监听，详见 <a href="#%E5%81%9C%E6%AD%A2%E7%9B%91%E5%90%AC">停止监听</a> 部分。</p><h4 id="监听选项之-flush" tabindex="-1"><a class="header-anchor" href="#监听选项之-flush" aria-hidden="true">#</a> 监听选项之 flush</h4><p><code>flush</code> 选项是用来控制 <a href="#%E7%9B%91%E5%90%AC%E5%90%8E%E7%9A%84%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0">监听回调</a> 的调用时机，接受指定的字符串，可选值如下，默认是 <code>&#39;pre&#39;</code> 。</p><table><thead><tr><th style="text-align:center;">可选值</th><th style="text-align:left;">回调的调用时机</th><th style="text-align:left;">使用场景</th></tr></thead><tbody><tr><td style="text-align:center;">&#39;pre&#39;</td><td style="text-align:left;">将在渲染前被调用</td><td style="text-align:left;">允许回调在模板运行前更新了其他值</td></tr><tr><td style="text-align:center;">&#39;sync&#39;</td><td style="text-align:left;">在渲染时被同步调用</td><td style="text-align:left;">目前来说没什么好处，可以了解但不建议用…</td></tr><tr><td style="text-align:center;">&#39;post&#39;</td><td style="text-align:left;">被推迟到渲染之后调用</td><td style="text-align:left;">如果要通过 ref 操作 <a href="#dom-%E5%85%83%E7%B4%A0%E4%B8%8E%E5%AD%90%E7%BB%84%E4%BB%B6">DOM 元素与子组件</a> ，需要使用这个值来启用该选项，以达到预期的执行效果</td></tr></tbody></table><p>对于 <code>&#39;pre&#39;</code> 和 <code>&#39;post&#39;</code> ，回调使用队列进行缓冲。回调只被添加到队列中一次。</p><p>即使观察值变化了多次，值的中间变化将被跳过，不会传递给回调，这样做不仅可以提高性能，还有助于保证数据的一致性。</p><p>更多关于 flush 的信息，请参阅 <a href="https://v3.cn.vuejs.org/guide/reactivity-computed-watchers.html#%E5%89%AF%E4%BD%9C%E7%94%A8%E5%88%B7%E6%96%B0%E6%97%B6%E6%9C%BA" target="_blank" rel="noopener noreferrer">副作用刷新时机<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 。</p><h4 id="停止监听" tabindex="-1"><a class="header-anchor" href="#停止监听" aria-hidden="true">#</a> 停止监听</h4><p>如果你在 <a href="#%E5%85%A8%E6%96%B0%E7%9A%84-setup-%E5%87%BD%E6%95%B0-new">setup</a> 或者 <a href="/efficient.html#script-setup-new" class="">script-setup</a> 里使用 watch 的话， <a href="#%E7%BB%84%E4%BB%B6%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F-new">组件被卸载</a> 的时候也会一起被停止，一般情况下不太需要关心如何停止监听。</p><p>不过有时候你可能想要手动取消， Vue 3 也提供了方法。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>随着组件被卸载一起停止的前提是，侦听器必须是 <a href="https://developer.mozilla.org/zh-CN/docs/Learn/JavaScript/Asynchronous/Introducing#%E5%90%8C%E6%AD%A5javascript" target="_blank" rel="noopener noreferrer">同步语句<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 创建的，这种情况下侦听器会绑定在当前组件上。</p><p>如果放在 <code>setTimeout</code> 等 <a href="https://developer.mozilla.org/zh-CN/docs/Learn/JavaScript/Asynchronous/Introducing#%E5%BC%82%E6%AD%A5javascript" target="_blank" rel="noopener noreferrer">异步函数<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 里面创建，则不会绑定到当前组件，因此组件卸载的时候不会一起停止该侦听器，这种时候你就需要手动停止监听。</p></div><p>在 <a href="#api-%E7%9A%84-ts-%E7%B1%BB%E5%9E%8B">API 的 TS 类型</a> 有提到，当你在定义一个 watch 行为的时候，它会返回一个用来停止监听的函数。</p><p>这个函数的 TS 类型如下：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">declare</span> <span class="token keyword">type</span> <span class="token class-name">WatchStopHandle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>用法很简单，做一下简单了解即可：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 定义一个取消观察的变量，它是一个函数</span>
<span class="token keyword">const</span> unwatch <span class="token operator">=</span> <span class="token function">watch</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 在合适的时期调用它，可以取消这个监听</span>
<span class="token function">unwatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>但是也有一点需要注意的是，如果你启用了 <a href="#%E7%9B%91%E5%90%AC%E9%80%89%E9%A1%B9%E4%B9%8B-immediate">immediate 选项</a> ，不能在第一次触发监听回调时执行它。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 注意：这是一段错误的代码，运行会报错</span>
<span class="token keyword">const</span> unwatch <span class="token operator">=</span> <span class="token function">watch</span><span class="token punctuation">(</span>
  message<span class="token punctuation">,</span>
  <span class="token comment">// 监听的回调</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 在这里调用会有问题 ❌</span>
    <span class="token function">unwatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 启用 immediate 选项</span>
  <span class="token punctuation">{</span>
    immediate<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>你会收获一段报错，告诉你 <code>unwatch</code> 这个变量在初始化前无法被访问：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>Uncaught ReferenceError: Cannot access <span class="token string">&#39;unwatch&#39;</span> before initialization
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>目前有两种方案可以让你实现这个操作：</p><p>方案一：使用 <code>var</code> 并判断变量类型，利用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/var#%E6%8F%8F%E8%BF%B0" target="_blank" rel="noopener noreferrer">var 的变量提升<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 来实现目的。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 这里改成 var ，不要用 const 或 let</span>
<span class="token keyword">var</span> unwatch <span class="token operator">=</span> <span class="token function">watch</span><span class="token punctuation">(</span>
  message<span class="token punctuation">,</span>
  <span class="token comment">// 监听回调</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里加一个判断，是函数才执行它</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> unwatch <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">unwatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 监听选项</span>
  <span class="token punctuation">{</span>
    immediate<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre><div class="highlight-lines"><br><div class="highlight-line"> </div><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>不过 <code>var</code> 已经属于过时的语句了，建议用方案二的 <code>let</code> 。</p><p>方案二：使用 <code>let</code> 并判断变量类型。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 如果不想用 any ，可以导入 TS 类型</span>
<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> WatchStopHandle <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token comment">// 这里改成 let ，但是要另起一行，先定义，再赋值</span>
<span class="token keyword">let</span> unwatch<span class="token operator">:</span> WatchStopHandle
unwatch <span class="token operator">=</span> <span class="token function">watch</span><span class="token punctuation">(</span>
  message<span class="token punctuation">,</span>
  <span class="token comment">// 监听回调</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里加一个判断，是函数才执行它</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> unwatch <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">unwatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 监听选项</span>
  <span class="token punctuation">{</span>
    immediate<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre><div class="highlight-lines"><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="监听效果清理" tabindex="-1"><a class="header-anchor" href="#监听效果清理" aria-hidden="true">#</a> 监听效果清理</h4><p>在 <a href="#%E7%9B%91%E5%90%AC%E5%90%8E%E7%9A%84%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0">监听后的回调函数</a> 部分提及到一个参数 <code>onCleanup</code> ，它可以帮你注册一个清理函数。</p><p>有时 watch 的回调会执行异步操作，当 watch 到数据变更的时候，需要取消这些操作，这个函数的作用就用于此，会在以下情况调用这个清理函数：</p><ul><li>watcher 即将重新运行的时候</li><li>watcher 被停止（组件被卸载或者被手动 <a href="#%E5%81%9C%E6%AD%A2%E7%9B%91%E5%90%AC">停止监听</a> ）</li></ul><p>TS 类型：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">declare</span> <span class="token keyword">type</span> <span class="token class-name">OnCleanup</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function-variable function">cleanupFn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>用法方面比较简单，传入一个回调函数运行即可，不过需要注意的是，需要在停止监听之前注册好清理行为，否则不会生效。</p><p>我们在 <a href="#%E5%81%9C%E6%AD%A2%E7%9B%91%E5%90%AC">停止监听</a> 里的最后一个 immediate 例子的基础上继续添加代码，请注意注册的时机：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">let</span> unwatch<span class="token operator">:</span> WatchStopHandle
unwatch <span class="token operator">=</span> <span class="token function">watch</span><span class="token punctuation">(</span>
  message<span class="token punctuation">,</span>
  <span class="token punctuation">(</span>newValue<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> onCleanup<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 需要在停止监听之前注册好清理行为</span>
    <span class="token function">onCleanup</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;监听清理ing&#39;</span><span class="token punctuation">)</span>
      <span class="token comment">// 根据实际的业务情况定义一些清理操作 ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 然后再停止监听</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> unwatch <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">unwatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    immediate<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="watcheffect" tabindex="-1"><a class="header-anchor" href="#watcheffect" aria-hidden="true">#</a> watchEffect</h3><p>如果一个函数里包含了多个需要监听的数据，一个一个数据去监听太麻烦了，在 Vue 3 ，你可以直接使用 watchEffect API 来简化你的操作。</p><h4 id="api-的-ts-类型-1" tabindex="-1"><a class="header-anchor" href="#api-的-ts-类型-1" aria-hidden="true">#</a> API 的 TS 类型</h4><p>这个 API 的类型如下，使用的时候需要传入一个副作用函数（相当于 watch 的 <a href="#%E7%9B%91%E5%90%AC%E5%90%8E%E7%9A%84%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0">监听后的回调函数</a> ），也可以根据你的实际情况传入一些可选的 <a href="#%E7%9B%91%E5%90%AC%E7%9A%84%E9%80%89%E9%A1%B9">监听选项</a> 。</p><p>和 watch API 一样，它也会返回一个用于 <a href="#%E5%81%9C%E6%AD%A2%E7%9B%91%E5%90%AC">停止监听</a> 的函数。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// watchEffect 部分的 TS 类型</span>
<span class="token comment">// ...</span>
<span class="token keyword">export</span> <span class="token keyword">declare</span> <span class="token keyword">type</span> <span class="token class-name">WatchEffect</span> <span class="token operator">=</span> <span class="token punctuation">(</span>onCleanup<span class="token operator">:</span> OnCleanup<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>

<span class="token keyword">export</span> <span class="token keyword">declare</span> <span class="token keyword">function</span> <span class="token function">watchEffect</span><span class="token punctuation">(</span>
  effect<span class="token operator">:</span> WatchEffect<span class="token punctuation">,</span>
  options<span class="token operator">?</span><span class="token operator">:</span> WatchOptionsBase
<span class="token punctuation">)</span><span class="token operator">:</span> WatchStopHandle
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>副作用函数也会传入一个清理回调作为参数，和 watch 的 <a href="#%E7%9B%91%E5%90%AC%E6%95%88%E6%9E%9C%E6%B8%85%E7%90%86">监听效果清理</a> 一样的用法。</p><p>你可以理解为它是一个简化版的 watch ，具体简化在哪里呢？请看下面的用法示例。</p><h4 id="用法示例" tabindex="-1"><a class="header-anchor" href="#用法示例" aria-hidden="true">#</a> 用法示例</h4><p>它立即执行传入的一个函数，同时响应式追踪其依赖，并在其依赖变更时重新运行该函数。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> watchEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 单独定义两个数据，后面用来分开改变数值</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&#39;Petter&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 定义一个调用这两个数据的函数</span>
    <span class="token keyword">const</span> getUserInfo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        name<span class="token operator">:</span> name<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
        age<span class="token operator">:</span> age<span class="token punctuation">.</span>value
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2s后改变第一个数据</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      name<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">&#39;Tom&#39;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4s后改变第二个数据</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      age<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 直接监听调用函数，在每个数据产生变化的时候，它都会自动执行</span>
    <span class="token function">watchEffect</span><span class="token punctuation">(</span>getUserInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h4 id="和-watch-的区别" tabindex="-1"><a class="header-anchor" href="#和-watch-的区别" aria-hidden="true">#</a> 和 watch 的区别</h4><p>虽然理论上 <code>watchEffect</code> 是 <code>watch</code> 的一个简化操作，可以用来代替 <a href="#%E6%89%B9%E9%87%8F%E7%9B%91%E5%90%AC">批量监听</a> ，但它们也有一定的区别：</p><ol><li><p><code>watch</code> 可以访问侦听状态变化前后的值，而 <code>watchEffect</code> 没有。</p></li><li><p><code>watch</code> 是在属性改变的时候才执行，而 <code>watchEffect</code> 则默认会执行一次，然后在属性改变的时候也会执行。</p></li></ol><p>第二点的意思，看下面这段代码可以有更直观的理解：</p><p>使用 watch ：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>

    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      foo<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">&#39;Hello World!&#39;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>

    <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 使用 watch 需要先手动执行一次</span>
    <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 然后当 foo 有变动时，才会通过 watch 来执行 bar()</span>
    <span class="token function">watch</span><span class="token punctuation">(</span>foo<span class="token punctuation">,</span> bar<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br></div><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>使用 watchEffect ：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>

    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      foo<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">&#39;Hello World!&#39;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>

    <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 可以通过 watchEffect 实现 bar() + watch(foo, bar) 的效果</span>
    <span class="token function">watchEffect</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br></div><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="可用的监听选项" tabindex="-1"><a class="header-anchor" href="#可用的监听选项" aria-hidden="true">#</a> 可用的监听选项</h4><p>虽然用法和 watch 类似，但也简化了一些选项，它的监听选项 TS 类型如下：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 只支持 base 类型</span>
<span class="token keyword">export</span> <span class="token keyword">declare</span> <span class="token keyword">interface</span> <span class="token class-name">WatchOptionsBase</span> <span class="token keyword">extends</span> <span class="token class-name">DebuggerOptions</span> <span class="token punctuation">{</span>
  flush<span class="token operator">?</span><span class="token operator">:</span> <span class="token string">&#39;pre&#39;</span> <span class="token operator">|</span> <span class="token string">&#39;post&#39;</span> <span class="token operator">|</span> <span class="token string">&#39;sync&#39;</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>

<span class="token comment">// 继承的 debugger 选项类型</span>
<span class="token keyword">export</span> <span class="token keyword">declare</span> <span class="token keyword">interface</span> <span class="token class-name">DebuggerOptions</span> <span class="token punctuation">{</span>
  onTrack<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>event<span class="token operator">:</span> DebuggerEvent<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
  onTrigger<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>event<span class="token operator">:</span> DebuggerEvent<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>对比 watch API ，它不支持 <a href="#%E7%9B%91%E5%90%AC%E9%80%89%E9%A1%B9%E4%B9%8B-deep">deep</a> 和 <a href="#%E7%9B%91%E5%90%AC%E9%80%89%E9%A1%B9%E4%B9%8B-immediate">immediate</a> ，请记住这一点，其他的用法是一样的。</p><p><code>flush</code> 选项的使用详见 <a href="#%E7%9B%91%E5%90%AC%E9%80%89%E9%A1%B9%E4%B9%8B-flush">监听选项之 flush</a> ，<code>onTrack</code> 和 <code>onTrigger</code> 详见 <a href="#%E7%9B%91%E5%90%AC%E7%9A%84%E9%80%89%E9%A1%B9">监听的选项</a> 部分内容。</p><h3 id="watchposteffect" tabindex="-1"><a class="header-anchor" href="#watchposteffect" aria-hidden="true">#</a> watchPostEffect</h3><p><a href="#watchEffect">watchEffect</a> API 使用 <code>flush: &#39;post&#39;</code> 选项时的别名，具体区别详见 <a href="#%E7%9B%91%E5%90%AC%E9%80%89%E9%A1%B9%E4%B9%8B-flush">监听选项之 flush</a> 部分。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>Vue v3.2.0 及以上版本才支持该 API 。</p></div><h3 id="watchsynceffect" tabindex="-1"><a class="header-anchor" href="#watchsynceffect" aria-hidden="true">#</a> watchSyncEffect</h3><p><a href="#watchEffect">watchEffect</a> API 使用 <code>flush: &#39;sync&#39;</code> 选项时的别名，具体区别详见 <a href="#%E7%9B%91%E5%90%AC%E9%80%89%E9%A1%B9%E4%B9%8B-flush">监听选项之 flush</a> 部分。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>Vue v3.2.0 及以上版本才支持该 API 。</p></div><h2 id="数据的计算-new" tabindex="-1"><a class="header-anchor" href="#数据的计算-new" aria-hidden="true">#</a> 数据的计算{new}</h2><p>和 Vue 2.0 一样，数据的计算也是使用 <code>computed</code> API ，它可以通过现有的响应式数据，去通过计算得到新的响应式变量，用过 Vue 2.0 的同学应该不会太陌生，但是在 Vue 3.0 ，在使用方式上也是变化非常大！</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>这里的响应式数据，可以简单理解为通过 <a href="#%E5%93%8D%E5%BA%94%E5%BC%8F-api-%E4%B9%8B-ref-new">ref</a> API 、 <a href="#%E5%93%8D%E5%BA%94%E5%BC%8F-api-%E4%B9%8B-reactive-new">reactive</a> API 定义出来的数据，当然 Vuex 、Vue Router 等 Vue 数据也都具备响应式，可以戳 <a href="#%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%E7%9A%84%E5%8F%98%E5%8C%96-new">响应式数据的变化</a> 了解。</p></div><h3 id="用法变化" tabindex="-1"><a class="header-anchor" href="#用法变化" aria-hidden="true">#</a> 用法变化</h3><p>我们先从一个简单的用例来看看在 Vue 新旧版本的用法区别：</p><p>假设你定义了两个分开的数据 <code>firstName</code> 名字和 <code>lastName</code> 姓氏，但是在 template 展示时，需要展示完整的姓名，那么你就可以通过 <code>computed</code> 来计算一个新的数据：</p><h4 id="回顾-vue-2-3" tabindex="-1"><a class="header-anchor" href="#回顾-vue-2-3" aria-hidden="true">#</a> 回顾 Vue 2</h4><p>在 Vue 2.0 ，<code>computed</code> 和 <code>data</code> 在同级配置，并且不可以和 <code>data</code> 里的数据同名重复定义：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 在 Vue 2 的写法：</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      firstName<span class="token operator">:</span> <span class="token string">&#39;Bill&#39;</span><span class="token punctuation">,</span>
      lastName<span class="token operator">:</span> <span class="token string">&#39;Gates&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 注意这里定义的变量，都要通过函数的形式来返回它的值</span>
  computed<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 普通函数可以直接通过熟悉的 this 来拿到 data 里的数据</span>
    <span class="token function">fullName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>firstName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 箭头函数则需要通过参数来拿到实例上的数据</span>
    <span class="token function-variable function">fullName2</span><span class="token operator">:</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>firstName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>lastName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>这样你在需要用到全名的地方，只需要通过 <code>this.fullName</code> 就可以得到 <code>Bill Gates</code> 。</p><h4 id="了解-vue-3-2" tabindex="-1"><a class="header-anchor" href="#了解-vue-3-2" aria-hidden="true">#</a> 了解 Vue 3</h4><p>在 Vue 3.0 ，跟其他 API 的用法一样，需要先导入 <code>computed</code> 才能使用：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 在 Vue 3 的写法：</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> computed <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 定义基本的数据</span>
    <span class="token keyword">const</span> firstName <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&#39;Bill&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> lastName <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&#39;Gates&#39;</span><span class="token punctuation">)</span>

    <span class="token comment">// 定义需要计算拼接结果的数据</span>
    <span class="token keyword">const</span> fullName <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>firstName<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lastName<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

    <span class="token comment">// 2s 后改变某个数据的值</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      firstName<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">&#39;Petter&#39;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>

    <span class="token comment">// template 那边在 2s 后也会显示为 Petter Gates</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      fullName<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>你可以把这个用法简单的理解为，传入一个回调函数，并 <code>return</code> 一个值，对，它需要有明确的返回值。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>需要注意的是：</p><ol><li><p>定义出来的 <code>computed</code> 变量，和 <code>ref</code> 变量的用法一样，也是需要通过 <code>.value</code> 才能拿到它的值</p></li><li><p>但是区别在于， <code>computed</code> 的 <code>value</code> 是只读的</p></li></ol><p>原因详见下方的 <a href="#%E7%B1%BB%E5%9E%8B%E5%AE%9A%E4%B9%89">类型定义</a> 。</p></div><h3 id="类型定义" tabindex="-1"><a class="header-anchor" href="#类型定义" aria-hidden="true">#</a> 类型定义</h3><p>我们之前说过，在 <a href="#%E4%BA%86%E8%A7%A3-definecomponent">defineComponent</a> 里，会自动帮我们推导 Vue API 的类型，所以一般情况下，你是不需要显式的去定义 <code>computed</code> 出来的变量类型的。</p><p>在确实需要手动指定的情况下，你也可以导入它的类型然后定义：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> computed <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>
<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> ComputedRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token comment">// 注意这里添加了类型定义</span>
<span class="token keyword">const</span> fullName<span class="token operator">:</span> ComputedRef<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>firstName<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lastName<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>你要返回一个字符串，你就写 <code>ComputedRef&lt;string&gt;</code> ；返回布尔值，就写 <code>ComputedRef&lt;boolean&gt;</code> ；返回一些复杂对象信息，你可以先定义好你的类型，再诸如 <code>ComputedRef&lt;UserInfo&gt;</code> 去写。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 这是 ComputedRef 的类型定义：</span>
<span class="token keyword">export</span> <span class="token keyword">declare</span> <span class="token keyword">interface</span> <span class="token class-name">ComputedRef<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">WritableComputedRef<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">readonly</span> value<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">;</span>
  <span class="token punctuation">[</span>ComoutedRefSymbol<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="优势对比和注意事项" tabindex="-1"><a class="header-anchor" href="#优势对比和注意事项" aria-hidden="true">#</a> 优势对比和注意事项</h3><p>在继续往下看之前，我们先来了解一下这个 API 的一些优势和注意事项（如果在 Vue 2 已经有接触过的话，可以跳过这一段，因为优势和需要注意的东西比较一致）。</p><h4 id="优势对比" tabindex="-1"><a class="header-anchor" href="#优势对比" aria-hidden="true">#</a> 优势对比</h4><p>看到这里，相信刚接触的同学可能会有疑问，既然 <code>computed</code> 也是通过一个函数来返回值，那么和普通的 <code>function</code> 有什么区别，或者说优势？</p><ol><li>性能优势</li></ol><p>这一点在 <a href="https://v3.cn.vuejs.org/guide/computed.html#%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7%E7%BC%93%E5%AD%98-vs-%E6%96%B9%E6%B3%95" target="_blank" rel="noopener noreferrer">官网文档<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 其实是有提到的：</p><blockquote><p>数据的计算是基于它们的响应依赖关系缓存的，只在相关响应式依赖发生改变时它们才会重新求值。</p></blockquote><p>也就是说，只要原始数据没有发生改变，多次访问 <code>computed</code> ，都是会立即返回之前的计算结果，而不是再次执行函数；而普通的 <code>function</code> 调用多少次就执行多少次，每调用一次就计算一次。</p><p>至于为何要如此设计，官网文档也给出了原因：</p><blockquote><p>我们为什么需要缓存？假设我们有一个性能开销比较大的计算数据 list，它需要遍历一个巨大的数组并做大量的计算。然后我们可能有其他的计算数据依赖于 list。如果没有缓存，我们将不可避免的多次执行 list 的 getter！如果你不希望有缓存，请用 function 来替代。</p></blockquote><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>在这部分内容里，我把官方文档的一些用词做了更换，比如把 method 都替换成了 function ，也把 “计算属性” 都换成了 “计算数据”，原因在于官网很多地方是基于 Options API 的写法去描述，而本文档是基于 Composition API 。</p><p>点击了解： <a href="https://www.zhihu.com/question/22602023/answer/21935867" target="_blank" rel="noopener noreferrer">如何理解 JavaScript 中方法（method）和函数（function）的区别？<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><ol start="2"><li>书写统一</li></ol><p>我们假定 foo1 是 <code>ref</code> 变量， foo2 是 <code>computed</code> 变量， foo3 是普通函数返回值</p><p>看到这里的同学应该都已经清楚 Vue 3 的 <code>ref</code> 变量是通过 <code>foo1.value</code> 来拿到值的，而 <code>computed</code> 也是通过 <code>foo2.value</code> ，并且在 template 里都可以省略 <code>.value</code> ，在读取方面，他们是有一致的风格和简洁性。</p><p>而 foo3 不管是在 script 还是 template ，都需要通过 <code>foo3()</code> 才能拿到结果，相对来说会有那么一丢丢别扭。</p><p>当然，关于这一点，如果涉及到的数据不是响应式数据，那么还是老老实实的用函数返回值吧，原因请见下面的 <a href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">注意事项</a> 。</p><h4 id="注意事项" tabindex="-1"><a class="header-anchor" href="#注意事项" aria-hidden="true">#</a> 注意事项</h4><p>有优势当然也就有一定的 “劣势” ，当然这也是 Vue 框架的有意为之，所以在使用上也需要注意一些问题：</p><ol><li>只会更新响应式数据的计算</li></ol><p>假设你要获取当前的时间信息，因为不是响应式数据，所以这种情况下你就需要用普通的函数去获取返回值，才能拿到最新的时间。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> nowTime <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nowTime<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token comment">// 输出 Sun Nov 14 2021 21:07:00 GMT+0800 (GMT+08:00)</span>

<span class="token comment">// 2s 后依然是跟上面一样的结果</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nowTime<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
  <span class="token comment">// 还是输出 Sun Nov 14 2021 21:07:00 GMT+0800 (GMT+08:00)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ol start="2"><li>数据是只读的</li></ol><p>通过 computed 定义的数据，它是只读的，这一点在 <a href="#%E7%B1%BB%E5%9E%8B%E5%AE%9A%E4%B9%89">类型定义</a> 已经有所了解。</p><p>如果你直接赋值，不仅无法变更数据，而且会收获一个报错。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>TS2540: Cannot assign to <span class="token string">&#39;value&#39;</span> because it is a read-only property.
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>虽然无法直接赋值，但是在必要的情况下，你依然可以通过 <code>computed</code> 的 <code>setter</code> 来更新数据。</p><p>点击了解：<a href="#setter-%E7%9A%84%E4%BD%BF%E7%94%A8">computed 的 setter 用法</a></p><h3 id="setter-的使用" tabindex="-1"><a class="header-anchor" href="#setter-的使用" aria-hidden="true">#</a> setter 的使用</h3><p>通过 computed 定义的变量默认都是只读的形式（只有一个 getter ），但是在必要的情况下，你也可以使用其 setter 属性来更新数据。</p><h4 id="基本格式" tabindex="-1"><a class="header-anchor" href="#基本格式" aria-hidden="true">#</a> 基本格式</h4><p>当你需要用到 setter 的时候， <code>computed</code> 就不再是一个传入 callback 的形式了，而是传入一个带有 2 个方法的对象。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 注意这里computed接收的入参已经不再是函数</span>
<span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 这里需要明确的返回一个值</span>
  <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 这里接收一个参数，代表修改 foo 时，赋值下来的新值</span>
  <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这里的 <code>get</code> 就是 <code>computed</code> 的 getter ，跟原来传入 callback 的形式一样，是用于 <code>foo.value</code> 的读取，所以这里你必须有明确的返回值。</p><p>这里的 <code>set</code> 就是 <code>computed</code> 的 setter ，它会接收一个参数，代表新的值，当你通过 <code>foo.value = xxx</code> 赋值的时候，赋入的这个值，就会通过这个入参来传递进来，你可以根据你的业务需要，把这个值，赋给相关的数据源。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>请注意，必须使用 <code>get</code> 和 <code>set</code> 这 2 个方法名，也只接受这 2 个方法。</p></div><p>在了解了基本格式后，可以查看下面的例子来了解具体的用法。</p><h4 id="使用示范" tabindex="-1"><a class="header-anchor" href="#使用示范" aria-hidden="true">#</a> 使用示范</h4><p>官网的 <a href="https://v3.cn.vuejs.org/guide/computed.html#%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7%E7%9A%84-setter" target="_blank" rel="noopener noreferrer">例子<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 是一个 Options API 的案例，这里我们改成 Composition API 的写法来演示：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 还是这2个数据源</span>
<span class="token keyword">const</span> firstName <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&#39;Bill&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> lastName <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&#39;Gates&#39;</span><span class="token punctuation">)</span>

<span class="token comment">// 这里我们配合setter的需要，改成了另外一种写法</span>
<span class="token keyword">const</span> fullName <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// getter我们还是返回一个拼接起来的全名</span>
  <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>firstName<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lastName<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// setter这里我们改成只更新firstName，注意参数也定义TS类型</span>
  <span class="token function">set</span><span class="token punctuation">(</span>newFirstName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    firstName<span class="token punctuation">.</span>value <span class="token operator">=</span> newFirstName
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fullName<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token comment">// 输出 Bill Gates</span>

<span class="token comment">// 2s后更新一下数据</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 对fullName的赋值，其实更新的是firstName</span>
  fullName<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">&#39;Petter&#39;</span>

  <span class="token comment">// 此时firstName已经得到了更新</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>firstName<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token comment">// 会输出 Petter</span>

  <span class="token comment">// 当然，由于firstName变化了，所以fullName的getter也会得到更新</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fullName<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token comment">// 会输出 Petter Gates</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="应用场景" tabindex="-1"><a class="header-anchor" href="#应用场景" aria-hidden="true">#</a> 应用场景</h3><p>计算 API 的作用，官网文档只举了一个非常简单的例子，那么在实际项目中，什么情况下用它会让我们更方便呢？</p><p>简单举几个比较常见的例子吧，加深一下对 <code>computed</code> 的理解。</p><h4 id="数据的拼接和计算" tabindex="-1"><a class="header-anchor" href="#数据的拼接和计算" aria-hidden="true">#</a> 数据的拼接和计算</h4><p>如上面的案例，与其每个用到的地方都要用到 <code>firstName + &#39; &#39; + lastName</code> 这样的多变量拼接，不如用一个 <code>fullName</code> 来的简单。</p><p>当然，不止是字符串拼接，数据的求和等操作更是合适，比如说你做一个购物车，购物车里有商品列表，同时还要显示购物车内的商品总金额，这种情况就非常适合用计算数据。</p><h4 id="复用组件的动态数据" tabindex="-1"><a class="header-anchor" href="#复用组件的动态数据" aria-hidden="true">#</a> 复用组件的动态数据</h4><p>在一个项目里，很多时候组件会涉及到复用，比如说：“首页的文章列表 vs 列表页的文章列表 vs 作者详情页的文章列表” ，特别常见于新闻网站等内容资讯站点，这种情况下，往往并不需要每次都重新写 UI 、数据渲染等代码，仅仅是接口 URL 的区别。</p><p>这种情况你就可以通过路由名称来动态获取你要调用哪个列表接口：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token function">useRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 定义一个根据路由名称来获取接口URL的计算数据</span>
<span class="token keyword">const</span> apiUrl <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 首页</span>
    <span class="token keyword">case</span> <span class="token string">&#39;home&#39;</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&#39;/api/list1&#39;</span>
    <span class="token comment">// 列表页</span>
    <span class="token keyword">case</span> <span class="token string">&#39;list&#39;</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&#39;/api/list2&#39;</span>
    <span class="token comment">// 作者页</span>
    <span class="token keyword">case</span> <span class="token string">&#39;author&#39;</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&#39;/api/list3&#39;</span>
    <span class="token comment">// 默认是随机列表</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&#39;/api/random&#39;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 请求列表</span>
<span class="token keyword">const</span> getArticleList <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  articleList<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    method<span class="token operator">:</span> <span class="token string">&#39;get&#39;</span><span class="token punctuation">,</span>
    url<span class="token operator">:</span> apiUrl<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>当然，这种情况你也可以在父组件通过 <code>props</code> 传递接口 URL ，如果你已经学到了 <a href="/communication.html" class="">组件通讯</a> 一章的话。</p><h4 id="获取多级对象的值" tabindex="-1"><a class="header-anchor" href="#获取多级对象的值" aria-hidden="true">#</a> 获取多级对象的值</h4><p>你应该很经常的遇到要在 template 显示一些多级对象的字段，但是有时候又可能存在某些字段不一定有，需要做一些判断的情况，虽然有 <code>v-if</code> ，但是嵌套层级一多，你的模板会难以维护。</p><p>如果你把这些工作量转移给计算数据，结合 <code>try / catch</code> ，这样就无需在 template 里处理很多判断了。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 例子比较极端，但在 Vuex 这种大型数据树上，也不是完全不可能存在</span>
<span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 正常情况下返回需要的数据</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>foo3<span class="token punctuation">.</span>foo2<span class="token punctuation">.</span>foo1<span class="token punctuation">.</span>foo
  <span class="token punctuation">}</span>
  <span class="token comment">// 处理失败则返回一个默认值</span>
  <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&#39;&#39;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这样你在 template 里要拿到 foo 的值，完全不需要关心中间一级又一级的字段是否存在，只需要区分是不是默认值。</p><h4 id="不同类型的数据转换" tabindex="-1"><a class="header-anchor" href="#不同类型的数据转换" aria-hidden="true">#</a> 不同类型的数据转换</h4><p>有时候你会遇到一些需求类似于，让用户在输入框里，按一定的格式填写文本，比如用英文逗号 <code>,</code> 隔开每个词，然后保存的时候，是用数组的格式提交给接口。</p><p>这个时候 <code>computed</code> 的 setter 就可以妙用了，只需要一个简单的 <code>computed</code> ，就可以代替 <code>input</code> 的 <code>change</code> 事件或者 <code>watch</code> 监听，可以减少很多业务代码的编写。</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
    <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tagsStr<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>请输入标签，多个标签用英文逗号隔开<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> computed<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这个是最终要用到的数组</span>
    <span class="token keyword">const</span> tags <span class="token operator">=</span> ref<span class="token operator">&lt;</span>string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment">// 因为input必须绑定一个字符串</span>
    <span class="token keyword">const</span> tagsStr <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// 所以通过getter来转成字符串</span>
      <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> tags<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;,&#39;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// 然后在用户输入的时候，切割字符串转换回数组</span>
      <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token operator">:</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tags<span class="token punctuation">.</span>value <span class="token operator">=</span> newValue<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;,&#39;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      tagsStr<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h2 id="指令" tabindex="-1"><a class="header-anchor" href="#指令" aria-hidden="true">#</a> 指令</h2><p>指令是 Vue 模板语法里的特殊标记，在使用上和 HTML 的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Global_attributes/data-*" target="_blank" rel="noopener noreferrer">data-*<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 属性十分相似，统一以 <code>v-</code> 开头（ e.g. <code>v-html</code> ）。</p><p>它以简单的方式实现了常用的 JavaScript 表达式功能，当表达式的值改变的时候，响应式地作用到 DOM 上。</p><h3 id="内置指令" tabindex="-1"><a class="header-anchor" href="#内置指令" aria-hidden="true">#</a> 内置指令</h3><p>Vue 提供了一些内置指令可以直接使用，例如：</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 渲染一段文本 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">v-text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>msg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 渲染一段文本 --&gt;</span>

  <span class="token comment">&lt;!-- 渲染一段 HTML --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-html</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>html<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 渲染一段 HTML --&gt;</span>

  <span class="token comment">&lt;!-- 循环创建一个列表 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>items.length<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>(item, index) in items<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>{{ item }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 循环创建一个列表 --&gt;</span>

  <span class="token comment">&lt;!-- 一些事件（ @ 等价于 v-on ） --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hello<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 一些事件（ @ 等价于 v-on ） --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> msg <span class="token operator">=</span> ref<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">&#39;Hello World!&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> html <span class="token operator">=</span> ref<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">&#39;&lt;p&gt;Hello World!&lt;/p&gt;&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> items <span class="token operator">=</span> ref<span class="token operator">&lt;</span>string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;a&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;b&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;c&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;d&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">function</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      msg<span class="token punctuation">,</span>
      html<span class="token punctuation">,</span>
      items<span class="token punctuation">,</span>
      hello<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>内置指令在使用上都非常的简单，可以在 <a href="https://v3.cn.vuejs.org/api/directives.html" target="_blank" rel="noopener noreferrer">指令 - API 参考<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 查询完整的指令列表和用法，在模板上使用时，请了解 <a href="https://v3.cn.vuejs.org/guide/template-syntax.html#%E6%8C%87%E4%BB%A4" target="_blank" rel="noopener noreferrer">指令的模板语法<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>其中有 2 个指令有别名：</p><ul><li><code>v-on</code> 的别名是 <code>@</code> ，使用 <code>@click</code> 等价于 <code>v-on:click</code></li><li><code>v-bind</code> 的别名是 <code>:</code> ，使用 <code>:src</code> 等价于 <code>v-bind:src</code></li></ul></div><h3 id="自定义指令-new" tabindex="-1"><a class="header-anchor" href="#自定义指令-new" aria-hidden="true">#</a> 自定义指令{new}</h3><p>如果 Vue 的内置指令不能满足业务需求，还可以开发自定义指令。</p><h4 id="相关的-ts-类型" tabindex="-1"><a class="header-anchor" href="#相关的-ts-类型" aria-hidden="true">#</a> 相关的 TS 类型</h4><p>在开始编写代码之前，先了解一下自定义指令相关的 TypeScript 类型。</p><p>自定义指令有两种实现形式，一种是作为一个对象，其中的写法比较接近于 Vue 组件，除了 <a href="https://vuejs.org/guide/scaling-up/ssr.html#custom-directives" target="_blank" rel="noopener noreferrer">getSSRProps<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 和 <a href="#deep-%E9%80%89%E9%A1%B9">deep 选项</a> 外，其他的每一个属性都是一个 <a href="#%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0">钩子函数</a> ，下一小节会介绍钩子函数的内容。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 对象式写法的 TS 类型</span>
<span class="token comment">// ...</span>
<span class="token keyword">export</span> <span class="token keyword">declare</span> <span class="token keyword">interface</span> <span class="token class-name">ObjectDirective<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token constant">V</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  created<span class="token operator">?</span><span class="token operator">:</span> DirectiveHook<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token constant">V</span><span class="token operator">&gt;</span>
  beforeMount<span class="token operator">?</span><span class="token operator">:</span> DirectiveHook<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token constant">V</span><span class="token operator">&gt;</span>
  mounted<span class="token operator">?</span><span class="token operator">:</span> DirectiveHook<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token constant">V</span><span class="token operator">&gt;</span>
  beforeUpdate<span class="token operator">?</span><span class="token operator">:</span> DirectiveHook<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> VNode<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token constant">V</span><span class="token operator">&gt;</span>
  updated<span class="token operator">?</span><span class="token operator">:</span> DirectiveHook<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> VNode<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token constant">V</span><span class="token operator">&gt;</span>
  beforeUnmount<span class="token operator">?</span><span class="token operator">:</span> DirectiveHook<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token constant">V</span><span class="token operator">&gt;</span>
  unmounted<span class="token operator">?</span><span class="token operator">:</span> DirectiveHook<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token constant">V</span><span class="token operator">&gt;</span>
  getSSRProps<span class="token operator">?</span><span class="token operator">:</span> SSRDirectiveHook
  deep<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>另外一种是函数式写法，只需要定义成一个函数，但这种写法只在 <code>mounted</code> 和 <code>updated</code> 这两个钩子生效，并且触发一样的行为。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 函数式写法的 TS 类型</span>
<span class="token comment">// ...</span>
<span class="token keyword">export</span> <span class="token keyword">declare</span> <span class="token keyword">type</span> <span class="token class-name">FunctionDirective<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token constant">V</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> DirectiveHook<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token constant">V</span><span class="token operator">&gt;</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这是每个钩子函数对应的类型，它有 4 个入参：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 钩子函数的 TS 类型</span>
<span class="token comment">// ...</span>
<span class="token keyword">export</span> <span class="token keyword">declare</span> <span class="token keyword">type</span> <span class="token class-name">DirectiveHook<span class="token operator">&lt;</span>
  <span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
  Prev <span class="token operator">=</span> VNode<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token constant">V</span> <span class="token operator">=</span> <span class="token builtin">any</span>
<span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  el<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span>
  binding<span class="token operator">:</span> DirectiveBinding<span class="token operator">&lt;</span><span class="token constant">V</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  vnode<span class="token operator">:</span> VNode<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  prevVNode<span class="token operator">:</span> Prev
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>钩子函数第二个参数的类型：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 钩子函数第二个参数的 TS 类型</span>
<span class="token comment">// ...</span>
<span class="token keyword">export</span> <span class="token keyword">declare</span> <span class="token keyword">interface</span> <span class="token class-name">DirectiveBinding<span class="token operator">&lt;</span><span class="token constant">V</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  instance<span class="token operator">:</span> ComponentPublicInstance <span class="token operator">|</span> <span class="token keyword">null</span>
  value<span class="token operator">:</span> <span class="token constant">V</span>
  oldValue<span class="token operator">:</span> <span class="token constant">V</span> <span class="token operator">|</span> <span class="token keyword">null</span>
  arg<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
  modifiers<span class="token operator">:</span> DirectiveModifiers
  dir<span class="token operator">:</span> ObjectDirective<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token constant">V</span><span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>可以看到自定义指令最核心的就是 “钩子函数” 了，接下来我们来了解这部分的知识点。</p><h4 id="钩子函数" tabindex="-1"><a class="header-anchor" href="#钩子函数" aria-hidden="true">#</a> 钩子函数</h4><p>和 <a href="#%E7%BB%84%E4%BB%B6%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F-new">组件的生命周期</a> 类似，自定义指令里的逻辑代码也有一些特殊的调用时机，在这里称之为钩子函数：</p><table><thead><tr><th style="text-align:center;">钩子函数</th><th style="text-align:left;">调用时机</th></tr></thead><tbody><tr><td style="text-align:center;">created</td><td style="text-align:left;">在绑定元素的 attribute 或事件监听器被应用之前调用</td></tr><tr><td style="text-align:center;">beforeMount</td><td style="text-align:left;">当指令第一次绑定到元素并且在挂载父组件之前调用</td></tr><tr><td style="text-align:center;">mounted</td><td style="text-align:left;">在绑定元素的父组件被挂载后调用</td></tr><tr><td style="text-align:center;">beforeUpdate</td><td style="text-align:left;">在更新包含组件的 VNode 之前调用</td></tr><tr><td style="text-align:center;">updated</td><td style="text-align:left;">在包含组件的 VNode 及其子组件的 VNode 更新后调用</td></tr><tr><td style="text-align:center;">beforeUnmount</td><td style="text-align:left;">在卸载绑定元素的父组件之前调用</td></tr><tr><td style="text-align:center;">unmounted</td><td style="text-align:left;">当指令与元素解除绑定且父组件已卸载时，只调用一次</td></tr></tbody></table><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>因为自定义指令的默认写法是一个对象，所以在代码风格上是遵循 Options API 的生命周期命名，而非 Vue 3 的 Composition API 风格。</p></div><p>钩子函数在用法上就是这样子：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> myDirective <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">created</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> prevVnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">mounted</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> prevVnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 其他钩子...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在 <a href="#%E7%9B%B8%E5%85%B3%E7%9A%84-ts-%E7%B1%BB%E5%9E%8B">相关的 TS 类型</a> 我们已了解，每个钩子函数都有 4 个入参：</p><table><thead><tr><th style="text-align:center;">参数</th><th style="text-align:left;">作用</th></tr></thead><tbody><tr><td style="text-align:center;">el</td><td style="text-align:left;">指令绑定的 DOM 元素，可以直接操作它</td></tr><tr><td style="text-align:center;">binding</td><td style="text-align:left;">一个对象数据，见下方的单独说明</td></tr><tr><td style="text-align:center;">vnode</td><td style="text-align:left;">el 对应在 Vue 里的虚拟节点信息</td></tr><tr><td style="text-align:center;">prevVNode</td><td style="text-align:left;">Update 时的上一个虚拟节点信息，仅在 <code>beforeUpdate</code> 和 <code>updated</code> 可用</td></tr></tbody></table><p>其中用的最多是 <code>el</code> 和 <code>binding</code> 了。</p><ul><li><p><code>el</code> 的值就是我们通过 <code>document.querySelector</code> 拿到的那个 DOM 元素。</p></li><li><p><code>binding</code> 是一个对象，里面包含了以下属性：</p></li></ul><table><thead><tr><th style="text-align:center;">属性</th><th style="text-align:left;">作用</th></tr></thead><tbody><tr><td style="text-align:center;">value</td><td style="text-align:left;">传递给指令的值，例如 <code>v-foo=&quot;bar&quot;</code> 里的 <code>bar</code> ，支持任意有效的 JS 表达式</td></tr><tr><td style="text-align:center;">oldValue</td><td style="text-align:left;">指令的上一个值，仅对 <code>beforeUpdate</code> 和 <code>updated</code> 可用</td></tr><tr><td style="text-align:center;">arg</td><td style="text-align:left;">传给指令的参数，例如 <code>v-foo:bar</code> 里的 <code>bar</code></td></tr><tr><td style="text-align:center;">modifiers</td><td style="text-align:left;">传给指令的修饰符，例如 <code>v-foo.bar</code> 里的 <code>bar</code></td></tr><tr><td style="text-align:center;">instance</td><td style="text-align:left;">使用指令的组件实例</td></tr><tr><td style="text-align:center;">dir</td><td style="text-align:left;">指令定义的对象（就是上面的 <code>const myDirective = { /* ... */ }</code> 这个对象）</td></tr></tbody></table><p>在了解了指令的写法和参数作用之后，我们来看看如何注册一个自定义指令。</p><h4 id="局部注册" tabindex="-1"><a class="header-anchor" href="#局部注册" aria-hidden="true">#</a> 局部注册</h4><p>自定义指令可以在单个组件内定义并使用，通过和 <a href="#%E5%85%A8%E6%96%B0%E7%9A%84-setup-%E5%87%BD%E6%95%B0-new">setup 函数</a> 同级别的 <code>directives</code> 选项进行定义，可以参考下面的例子和注释：</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 这个使用默认值 unset --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-highlight</span><span class="token punctuation">&gt;</span></span>{{ msg }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 这个使用默认值 unset --&gt;</span>

  <span class="token comment">&lt;!-- 这个使用传进去的黄色 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-highlight</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>`yellow`<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{ msg }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 这个使用传进去的黄色 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 自定义指令在这里编写，和 setup 同级别</span>
  <span class="token literal-property property">directives</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// directives 下的每个字段名就是指令名称</span>
    <span class="token literal-property property">highlight</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// 钩子函数</span>
      <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span>
          <span class="token keyword">typeof</span> binding<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">?</span> binding<span class="token punctuation">.</span>value <span class="token operator">:</span> <span class="token string">&#39;unset&#39;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> msg <span class="token operator">=</span> ref<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">&#39;Hello World!&#39;</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      msg<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>上面是对象式的写法，你也可以写成函数式：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  directives<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">highlight</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> binding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span>
        <span class="token keyword">typeof</span> binding<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">?</span> binding<span class="token punctuation">.</span>value <span class="token operator">:</span> <span class="token string">&#39;unset&#39;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="highlight-lines"><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br></div><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>局部注册的自定义指令，默认在子组件内生效，子组件内无需重新注册即可使用父组件的自定义指令。</p></div><h4 id="全局注册" tabindex="-1"><a class="header-anchor" href="#全局注册" aria-hidden="true">#</a> 全局注册</h4><p>自定义指令也可以注册成全局，这样就无需在每个组件里定义了，只要在入口文件 <code>main.ts</code> 里启用它，任意组件里都可以使用自定义指令。</p><p>请查看 <a href="/plugin.html#%E5%BC%80%E5%8F%91%E6%9C%AC%E5%9C%B0-vue-%E4%B8%93%E5%B1%9E%E6%8F%92%E4%BB%B6" class="">开发本地 Vue 专属插件</a> 一节的内容了解如何注册一个全局的自定义指令插件。</p><h4 id="deep-选项" tabindex="-1"><a class="header-anchor" href="#deep-选项" aria-hidden="true">#</a> deep 选项</h4><p>除了 <a href="#%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0">钩子函数</a> ，在 <a href="#%E7%9B%B8%E5%85%B3%E7%9A%84-ts-%E7%B1%BB%E5%9E%8B">相关的 TS 类型</a> 里还可以看到有一个 deep 选项，它是一个布尔值，作用是：</p><p>如果自定义指令用于一个有嵌套属性的对象，并且需要在嵌套属性更新的时候触发 <code>beforeUpdate</code> 和 <code>updated</code> 钩子，那么需要将这个选项设置为 <code>true</code> 才能够生效。</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-foo</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>foo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> reactive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">directives</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">beforeUpdate</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;beforeUpdate&#39;</span><span class="token punctuation">,</span> binding<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">updated</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;updated&#39;</span><span class="token punctuation">,</span> binding<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;mounted&#39;</span><span class="token punctuation">,</span> binding<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// 需要设置为 true ，如果是 false 则不会触发</span>
      <span class="token literal-property property">deep</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 定义一个有嵌套属性的对象</span>
    <span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">bar</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">baz</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 2s 后修改其中一个值，会触发 beforeUpdate 和 updated</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      foo<span class="token punctuation">.</span>bar<span class="token punctuation">.</span>baz <span class="token operator">=</span> <span class="token number">2</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      foo<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><h2 id="插槽" tabindex="-1"><a class="header-anchor" href="#插槽" aria-hidden="true">#</a> 插槽</h2><p>Vue 在使用子组件的时候，子组件在 template 里类似一个 HTML 标签，你可以在这个子组件标签里传入任意模板代码以及 HTML 代码，这个功能就叫做 “插槽” 。</p><h3 id="默认插槽" tabindex="-1"><a class="header-anchor" href="#默认插槽" aria-hidden="true">#</a> 默认插槽</h3><p>默认情况下，子组件使用 <code>&lt;slot /&gt;</code> 标签即可渲染父组件传下来的插槽内容，例如：</p><p>在父组件这边：</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 注意这里，子组件标签里面传入了 HTML 代码 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>这是插槽内容<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Child</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 注意这里，子组件标签里面传入了 HTML 代码 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>
<span class="token keyword">import</span> Child <span class="token keyword">from</span> <span class="token string">&#39;@cp/Child.vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">components</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    Child<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>在子组件这边：</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><div class="highlight-line"> </div><br></div><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>默认插槽非常简单，一个 <code>&lt;slot /&gt;</code> 就可以了。</p><h3 id="具名插槽" tabindex="-1"><a class="header-anchor" href="#具名插槽" aria-hidden="true">#</a> 具名插槽</h3><p>有时候你可能需要指定多个插槽，例如一个子组件里有 “标题” 、 “作者”、 “内容” 等预留区域可以显示对应的内容，这时候就需要用到具名插槽来指定不同的插槽位。</p><p>子组件通过 <code>name</code> 属性来指定插槽名称：</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 显示标题的插槽内容 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>title<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>title<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 显示标题的插槽内容 --&gt;</span>

  <span class="token comment">&lt;!-- 显示作者的插槽内容 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>author<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>author<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 显示作者的插槽内容 --&gt;</span>

  <span class="token comment">&lt;!-- 其他插槽内容放到这里 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>content<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 其他插槽内容放到这里 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><div class="highlight-line"> </div><br><br><br></div><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>父组件通过 <code>template</code> 标签绑定 <code>v-slot:name</code> 格式的属性，来指定传入哪个插槽里：</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 传给标题插槽 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name"><span class="token namespace">v-slot:</span>title</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>这是标题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 传给标题插槽 --&gt;</span>

    <span class="token comment">&lt;!-- 传给作者插槽 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name"><span class="token namespace">v-slot:</span>author</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>这是作者信息<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 传给作者插槽 --&gt;</span>

    <span class="token comment">&lt;!-- 传给默认插槽 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>这是插槽内容<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 传给默认插槽 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Child</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><code>v-slot:name</code> 有一个别名 <code>#name</code> 语法，上面父组件的代码也相当于：</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 传给标题插槽 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">#title</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>这是标题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 传给标题插槽 --&gt;</span>

    <span class="token comment">&lt;!-- 传给作者插槽 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">#author</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>这是作者信息<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 传给作者插槽 --&gt;</span>

    <span class="token comment">&lt;!-- 传给默认插槽 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>这是插槽内容<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 传给默认插槽 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Child</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>在使用具名插槽的时候，子组件如果不指定默认插槽，那么在具名插槽之外的内容将不会被渲染。</p></div><h3 id="默认内容" tabindex="-1"><a class="header-anchor" href="#默认内容" aria-hidden="true">#</a> 默认内容</h3><p>你可以给 <code>slot</code> 标签添加内容，例如 <code>&lt;slot&gt;默认内容&lt;/slot&gt;</code> ，当父组件没有传入插槽内容时，会使用默认内容来显示，默认插槽和具名插槽均支持该功能。</p><h3 id="注意事项-1" tabindex="-1"><a class="header-anchor" href="#注意事项-1" aria-hidden="true">#</a> 注意事项</h3><p>有一条规则需要记住：</p><ul><li>父组件里的所有内容都是在父级作用域中编译的</li><li>子组件里的所有内容都是在子作用域中编译的</li></ul><h2 id="css-样式与预处理器" tabindex="-1"><a class="header-anchor" href="#css-样式与预处理器" aria-hidden="true">#</a> CSS 样式与预处理器</h2><p>Vue 组件的 CSS 样式部分，3.x 保留着和 2.x 完全一样的写法。</p><h3 id="编写组件样式表" tabindex="-1"><a class="header-anchor" href="#编写组件样式表" aria-hidden="true">#</a> 编写组件样式表</h3><p>最基础的写法，就是在 Vue 文件里创建一个 <code>style</code> 标签，即可在里面写 CSS 代码了。</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.msg</span> <span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.msg p</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #333<span class="token punctuation">;</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="动态绑定-css" tabindex="-1"><a class="header-anchor" href="#动态绑定-css" aria-hidden="true">#</a> 动态绑定 CSS</h3><p>动态绑定 CSS ，在 Vue 2 就已经存在了，在此之前常用的是 <code>:class</code> 和 <code>:style</code> ，现在在 Vue 3 ，还可以通过 <code>v-bind</code> 来动态修改了。</p><p>其实这一部分主要是想说一下 3.x 新增的 <code>&lt;style&gt; v-bind</code> 功能，不过既然写到这里，就把另外两个动态绑定方式也一起提一下。</p><h4 id="使用-class-动态修改样式名" tabindex="-1"><a class="header-anchor" href="#使用-class-动态修改样式名" aria-hidden="true">#</a> 使用 :class 动态修改样式名</h4><p>它是绑定在 DOM 元素上面的一个属性，跟 <code>class</code> 同级别，它非常灵活！</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>使用 <code>:class</code> 是用来动态修改样式名，也就意味着你必须提前把样式名对应的样式表先写好！</p></div><p>假设我们已经提前定义好了这几个变量：</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> activeClass <span class="token operator">=</span> <span class="token string">&#39;active-class&#39;</span>
    <span class="token keyword">const</span> activeClass1 <span class="token operator">=</span> <span class="token string">&#39;active-class1&#39;</span>
    <span class="token keyword">const</span> activeClass2 <span class="token operator">=</span> <span class="token string">&#39;active-class2&#39;</span>
    <span class="token keyword">const</span> isActive <span class="token operator">=</span> <span class="token boolean">true</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      activeClass<span class="token punctuation">,</span>
      activeClass1<span class="token punctuation">,</span>
      activeClass2<span class="token punctuation">,</span>
      isActive<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>如果只想绑定一个单独的动态样式，你可以传入一个字符串：</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>activeClass<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Hello World!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果有多个动态样式，也可以传入一个数组：</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>[activeClass1, activeClass2]<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Hello World!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>你还可以对动态样式做一些判断，这个时候传入一个对象：</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{ <span class="token punctuation">&#39;</span>active-class<span class="token punctuation">&#39;</span>: isActive }<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Hello World!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>多个判断的情况下，记得也用数组套起来：</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span>
    <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>[
      { activeClass1: isActive },
      { activeClass2: !isActive }
    ]<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span>
    Hello World!
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>那么什么情况下会用到 <code>:class</code> 呢？</p><p>最常见的场景，应该就是导航、选项卡了，比如你要给一个当前选中的选项卡做一个突出高亮的状态，那么就可以使用 <code>:class</code> 来动态绑定一个样式。</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>list<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span>
      <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{ cur: index === curIndex }<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>(item, index) in 5<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>curIndex = index<span class="token punctuation">&quot;</span></span>
    <span class="token punctuation">&gt;</span></span>
      {{ item }}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> curIndex <span class="token operator">=</span> ref<span class="token operator">&lt;</span>number<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      curIndex<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">scoped</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.cur</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>这样就简单实现了一个点击切换选项卡高亮的功能。</p><h4 id="使用-style-动态修改内联样式" tabindex="-1"><a class="header-anchor" href="#使用-style-动态修改内联样式" aria-hidden="true">#</a> 使用 :style 动态修改内联样式</h4><p>如果你觉得使用 <code>:class</code> 需要提前先写样式，再去绑定样式名有点繁琐，有时候只想简简单单的修改几个样式，那么你可以通过 <code>:style</code> 来处理。</p><p>默认的情况下，我们都是传入一个对象去绑定：</p><ul><li><p><code>key</code> 是符合 CSS 属性名的 “小驼峰式” 写法，或者套上引号的短横线分隔写法（原写法），例如在 CSS 里，定义字号是 <code>font-size</code> ，那么你需要写成 <code>fontSize</code> 或者 <code>&#39;font-size&#39;</code> 作为它的键。</p></li><li><p><code>value</code> 是 CSS 属性对应的 “合法值”，比如你要修改字号大小，可以传入 <code>13px</code> 、<code>0.4rem</code> 这种带合法单位字符串值，但不可以是 <code>13</code> 这样的缺少单位的值，无效的 CSS 值会被过滤不渲染。</p></li></ul><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span>
    <span class="token attr-name">:style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{
      fontSize: <span class="token punctuation">&#39;</span>13px<span class="token punctuation">&#39;</span>,
      <span class="token punctuation">&#39;</span>line-height<span class="token punctuation">&#39;</span>: 2,
      color: <span class="token punctuation">&#39;</span>#ff0000<span class="token punctuation">&#39;</span>,
      textAlign: <span class="token punctuation">&#39;</span>center<span class="token punctuation">&#39;</span>
    }<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span>
    Hello World!
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>如果有些特殊场景需要绑定多套 <code>style</code>，你需要在 <code>script</code> 先定义好各自的样式变量（也是符合上面说到的那几个要求的对象），然后通过数组来传入：</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span>
    <span class="token attr-name">:style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>[style1, style2]<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span>
    Hello World!
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> style1 <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">fontSize</span><span class="token operator">:</span> <span class="token string">&#39;13px&#39;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&#39;line-height&#39;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> style2 <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">&#39;#ff0000&#39;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">textAlign</span><span class="token operator">:</span> <span class="token string">&#39;center&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      style1<span class="token punctuation">,</span>
      style2<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h4 id="使用-v-bind-动态修改-style-new" tabindex="-1"><a class="header-anchor" href="#使用-v-bind-动态修改-style-new" aria-hidden="true">#</a> 使用 v-bind 动态修改 style{new}</h4><p>当然，以上两种形式都是关于 <code>&lt;script /&gt;</code> 和 <code>&lt;template /&gt;</code> 部分的相爱相杀，如果你觉得会给你的模板带来一定的维护成本的话，不妨考虑这个新方案，将变量绑定到 <code>&lt;style /&gt;</code> 部分去。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>请注意这是一个在 <code>3.2.0</code> 版本之后才被归入正式队列的新功能！</p><p>如果需要使用它，请确保你的 <code>vue</code> 和 <code>@vue/compiler-sfc</code> 版本号在 <code>3.2.0</code> 以上，最好是保持最新的 <code>@next</code> 版本。</p></div><p>我们先来看看基本的用法：</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>msg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Hello World!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fontColor <span class="token operator">=</span> ref<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">&#39;#ff0000&#39;</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      fontColor<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">scoped</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.msg</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token function">v-bind</span><span class="token punctuation">(</span>fontColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>如上面的代码，你将渲染出一句红色文本的 <code>Hello World!</code></p><p>这其实是利用了现代浏览器支持的 CSS 变量来实现的一个功能（所以如果你打算用它的话，需要提前注意一下兼容性噢，点击查看：<a href="https://caniuse.com/css-variables" target="_blank" rel="noopener noreferrer">CSS Variables 兼容情况<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>）</p><p>它渲染到 DOM 上，其实也是通过绑定 <code>style</code> 来实现，我们可以看到渲染出来的样式是：</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span>
  <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>msg<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">data-v-7eb2bc79</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span>
  <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">--7eb2bc79-fontColor</span><span class="token punctuation">:</span>#ff0000<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span>
<span class="token punctuation">&gt;</span></span>
  Hello World!
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>对应的 CSS 变成了：</p><div class="language-css ext-css line-numbers-mode"><pre class="language-css"><code><span class="token selector">.msg[data-v-7eb2bc79]</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--7eb2bc79-fontColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>理论上 <code>v-bind</code> 函数可以在 Vue 内部支持任意的 JS 表达式，但由于可能包含在 CSS 标识符中无效的字符，因此官方是建议在大多数情况下，用引号括起来，如：</p><div class="language-css ext-css line-numbers-mode"><pre class="language-css"><code><span class="token selector">.text</span> <span class="token punctuation">{</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token function">v-bind</span><span class="token punctuation">(</span><span class="token string">&#39;theme.font.size&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>由于 CSS 变量的特性，因此对 CSS 响应式属性的更改不会触发模板的重新渲染（这也是和 <code>:class</code> 与 <code>:style</code> 的最大不同）。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>不管你有没有开启 <a href="#style-scoped">&lt;style scoped&gt;</a> ，使用 <code>v-bind</code> 渲染出来的 CSS 变量，都会带上 <code>scoped</code> 的随机 hash 前缀，避免样式污染（永远不会意外泄漏到子组件中），所以请放心使用！</p></div><p>如果你对 CSS 变量的使用还不是很了解的话，可以先阅读一下相关的基础知识点。</p><p>相关阅读：<a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Using_CSS_custom_properties" target="_blank" rel="noopener noreferrer">使用CSS自定义属性（变量） - MDN<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="样式表的组件作用域" tabindex="-1"><a class="header-anchor" href="#样式表的组件作用域" aria-hidden="true">#</a> 样式表的组件作用域</h3><p>CSS 不像 JS ，是没有作用域的概念的，一旦写了某个样式，直接就是全局污染。所以 <a href="https://www.bemcss.com/" target="_blank" rel="noopener noreferrer">BEM 命名法<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 等规范才应运而生。</p><p>但在 Vue 组件里，有两种方案可以避免出现这种污染问题。</p><p>一个是 Vue 2 就有的 <code>&lt;style scoped&gt;</code> ，一个是 Vue 3 新推出的 <code>&lt;style module&gt;</code> 。</p><h4 id="style-scoped" tabindex="-1"><a class="header-anchor" href="#style-scoped" aria-hidden="true">#</a> style scoped</h4><p>Vue 组件在设计的时候，就想到了一个很优秀的解决方案，通过 <code>scoped</code> 来支持创建一个 CSS 作用域，使这部分代码只运行在这个组件渲染出来的虚拟 DOM 上。</p><p>使用方式很简单，只需要在 <code>style</code> 后面带上 <code>scoped</code> 属性。</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">scoped</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.msg</span> <span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.msg p</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #333<span class="token punctuation">;</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>编译后，虚拟 DOM 都会带有一个 <code>data-v-xxxxx</code> 这样的属性，其中 <code>xxxxx</code> 是一个随机生成的 hash ，同一个组件的 hash 是相同并且唯一的：</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>msg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-v-7eb2bc79</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">data-v-7eb2bc79</span><span class="token punctuation">&gt;</span></span>Hello World!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>而 CSS 则也会带上与 HTML 相同的属性，从而达到样式作用域的目的。</p><div class="language-css ext-css line-numbers-mode"><pre class="language-css"><code><span class="token selector">.msg[data-v-7eb2bc79]</span> <span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.msg p[data-v-7eb2bc79]</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #333<span class="token punctuation">;</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>使用 <code>scoped</code> 可以有效的避免全局样式污染，你可以在不同的组件里面都使用相同的 className，而不必担心会相互覆盖，不必再定义很长很长的样式名来防止冲突了。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>添加 <code>scoped</code> 生成的样式，只作用于当前组件中的元素，并且权重高于全局 CSS ，可以覆盖全局样式</p></div><h4 id="style-module-new" tabindex="-1"><a class="header-anchor" href="#style-module-new" aria-hidden="true">#</a> style module{new}</h4><p>这是在 Vue 3 才推出的一个新方案，和 <code>&lt;style scoped&gt;</code> 不同，scoped 是通过给 DOM 元素添加自定义属性的方式来避免冲突，而 <code>&lt;style module&gt;</code> 则更为激进，将会编译成 <a href="https://github.com/css-modules/css-modules" target="_blank" rel="noopener noreferrer">CSS Modules<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 。</p><p>对于 CSS Modules 的处理方式，我们也可以通过一个小例子来更直观的了解它：</p><div class="language-css ext-css line-numbers-mode"><pre class="language-css"><code><span class="token comment">/* 编译前 */</span>
<span class="token selector">.title</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 编译后 */</span>
<span class="token selector">._3zyde4l1yATCOkgn-DBWEL</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>可以看出，是通过比较 “暴力” 的方式，把我们编写的 “好看的” 样式名，直接改写成一个随机 hash 样式名，来避免样式互相污染。</p><blockquote><p>上面的案例来自阮老师的博文 <a href="https://www.ruanyifeng.com/blog/2016/06/css_modules.html" target="_blank" rel="noopener noreferrer">CSS Modules 用法教程<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><p>所以我们回到 Vue 这边，看看 <code>&lt;style module&gt;</code> 是怎么操作的。</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>$style.msg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Hello World!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">module</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.msg</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #ff0000<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>于是，你将渲染出一句红色文本的 <code>Hello World!</code> 。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><ol><li><p>使用这个方案，需要了解如何 <a href="#%E4%BD%BF%E7%94%A8-class-%E5%8A%A8%E6%80%81%E4%BF%AE%E6%94%B9%E6%A0%B7%E5%BC%8F%E5%90%8D">使用 :class 动态修改样式名</a></p></li><li><p>如果单纯只使用 <code>&lt;style module&gt;</code> ，那么在绑定样式的时候，是默认使用 <code>$style</code> 对象来操作的</p></li><li><p>必须显示的指定绑定到某个样式，比如 <code>$style.msg</code> ，才能生效</p></li><li><p>如果单纯的绑定 <code>$style</code> ，并不能得到 “把全部样式名直接绑定” 的期望结果</p></li><li><p>如果你指定的 className 是短横杆命名，比如 <code>.user-name</code> ，那么需要通过 <code>$style[&#39;user-name&#39;]</code> 去绑定</p></li></ol></div><p>你也可以给 <code>module</code> 进行命名，然后就可以通过你命名的 “变量名” 来操作：</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>classes.msg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Hello World!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">module</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>classes<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.msg</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #ff0000<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>需要注意的一点是，一旦开启 <code>&lt;style module&gt;</code> ，那么在 <code>&lt;style module&gt;</code> 里所编写的样式，都必须手动绑定才能生效，没有被绑定的样式，会被编译，但不会主动生效到你的 DOM 上。</p><p>原因是编译出来的样式名已经变化，而你的 DOM 未指定对应的样式名，或者指定的是编译前的命名，所以并不能匹配到正确的样式。</p></div><h4 id="usecssmodule-new" tabindex="-1"><a class="header-anchor" href="#usecssmodule-new" aria-hidden="true">#</a> useCssModule{new}</h4><p>这是一个全新的 API ，面向在 script 部分操作 CSS Modules 。</p><p>在上面的 <a href="#style-module-new">CSS Modules</a> 部分可以知道，你可以在 <code>style</code> 定义好样式，然后在 <code>template</code> 部分通过变量名来绑定样式。</p><p>那么如果有一天有个需求，你需要通过 <code>v-html</code> 来渲染 HTML 代码，那这里的样式岂不是凉凉了？当然不会！</p><p>Vue 3 提供了一个 Composition API <code>useCssModule</code> 来帮助你在 <code>setup</code> 函数里操作你的 CSS Modules （对，只能在 <a href="#%E5%85%A8%E6%96%B0%E7%9A%84-setup-%E5%87%BD%E6%95%B0-new">setup</a> 或者 <a href="/efficient.html#script-setup-new" class="">script setup</a> 里使用）。</p><p><strong>基本用法：</strong></p><p>我们绑定多几个样式，再来操作：</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>$style.msg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>$style.text<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Hello World!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> useCssModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> style <span class="token operator">=</span> <span class="token function">useCssModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">module</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.msg</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #ff0000<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.text</span> <span class="token punctuation">{</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>可以看到打印出来的 <code>style</code> 是一个对象：</p><ul><li><p><code>key</code> 是你在 <code>&lt;style modules&gt;</code> 里定义的原始样式名</p></li><li><p><code>value</code> 则是编译后的新样式名</p></li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">&#39;home_msg_37Xmr&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">&#39;home_text_2woQJ&#39;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>所以我们来配合 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Template_literals" target="_blank" rel="noopener noreferrer">模板字符串<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 的使用，看看刚刚说的，要通过 <code>v-html</code> 渲染出来的内容应该如何绑定样式：</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-html</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>content<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> useCssModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取样式</span>
    <span class="token keyword">const</span> style <span class="token operator">=</span> <span class="token function">useCssModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 编写模板内容</span>
    <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p class=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>style<span class="token punctuation">.</span>msg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;
      &lt;span class=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>style<span class="token punctuation">.</span>text<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;Hello World! —— from v-html&lt;/span&gt;
    &lt;/p&gt;</span><span class="token template-punctuation string">`</span></span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      content<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">module</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.msg</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #ff0000<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.text</span> <span class="token punctuation">{</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>是不是也非常简单？可能刚开始不太习惯，但写多几次其实也蛮好玩的这个功能！</p><p><strong>另外，需要注意的是，如果你是指定了 modules 的名称，那么必须传入对应的名称作为入参才可以正确拿到这些样式：</strong></p><p>比如指定了一个 classes 作为名称：</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">module</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>classes<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token comment">/* ... */</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>那么需要通过传入 classes 这个名称才能拿到样式，否则会是一个空对象：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> style <span class="token operator">=</span> <span class="token function">useCssModule</span><span class="token punctuation">(</span><span class="token string">&#39;classes&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>在 <code>const style = useCssModule()</code> 的时候，命名是随意的，跟你在 <code>&lt;style module=&quot;classes&quot;&gt;</code> 这里指定的命名没有关系。</p></div><h3 id="深度操作符-new" tabindex="-1"><a class="header-anchor" href="#深度操作符-new" aria-hidden="true">#</a> 深度操作符{new}</h3><p>在 <a href="#%E6%A0%B7%E5%BC%8F%E8%A1%A8%E7%9A%84%E7%BB%84%E4%BB%B6%E4%BD%9C%E7%94%A8%E5%9F%9F">样式表的组件作用域</a> 部分我们了解到，使用 scoped 后，父组件的样式将不会渗透到子组件中，但也不能直接修改子组件的样式。</p><p>如果确实需要进行修改子组件的样式，必须通过 <code>::v-deep</code>（完整写法） 或者 <code>:deep</code>（快捷写法） 操作符来实现。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><ol><li><p>旧版的深度操作符是 <code>&gt;&gt;&gt;</code> 、 <code>/deep/</code> 和 <code>::v-deep</code>，现在 <code>&gt;&gt;&gt;</code> 和 <code>/deep/</code> 已进入弃用阶段（虽然暂时还没完全移除）</p></li><li><p>同时需要注意的是，旧版 <code>::v-deep</code> 的写法是作为组合器的方式，写在样式或者元素前面，如：<code>::v-deep .class-name { /* ... */ }</code>，现在这种写法也废弃了。</p></li></ol></div><p>现在不论是 <code>::v-deep</code> 还是 <code>:deep</code> ，使用方法非常统一，我们来假设 .b 是子组件的样式名：</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">scoped</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.a :deep(.b)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>编译后：</p><div class="language-css ext-css line-numbers-mode"><pre class="language-css"><code><span class="token selector">.a[data-v-f3f3eg9] .b</span> <span class="token punctuation">{</span>
  <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>可以看到，新的 deep 写法是作为一个类似 JS “函数” 那样去使用，需要深度操作的样式或者元素名，作为 “入参” 去传入。</p></div><p>同理，如果你使用 Less 或者 Stylus 这种支持嵌套写法的预处理器，也是可以这样去深度操作的：</p><div class="language-less ext-less line-numbers-mode"><pre class="language-less"><code><span class="token selector">.a</span> <span class="token punctuation">{</span>
  <span class="token selector">:deep(.b)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* ... */</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>另外，除了操作子组件的样式，那些通过 <code>v-html</code> 创建的 DOM 内容，也不受作用域内的样式影响，也可以通过深度操作符来实现样式修改。</p><h3 id="使用-css-预处理器" tabindex="-1"><a class="header-anchor" href="#使用-css-预处理器" aria-hidden="true">#</a> 使用 CSS 预处理器</h3><p>在工程化的现在，可以说前端都几乎不写 CSS 了，都是通过 <code>sass</code>、<code>less</code>、<code>stylus</code> 等 CSS 预处理器来完成样式的编写。</p><p>为什么要用 CSS 预处理器？放一篇关于三大预处理器的点评，新同学可以做个简单了解，具体的用法在对应的官网上有非常详细的说明。</p><p>可以查看了解：<a href="https://zhuanlan.zhihu.com/p/23382462" target="_blank" rel="noopener noreferrer">浅谈css预处理器，Sass、Less和Stylus<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>在 Vue 组件里使用预处理器非常简单，<code>Vue CLI</code>内置了 <code>stylus</code>，如果打算使用其他的预处理器，需要先安装。</p><p>这里以 <code>stylus</code> 为例，只需要通过 <code>lang=&quot;stylus&quot;</code> 属性来指定使用哪个预处理器，即可直接编写对应的代码：</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stylus<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
// 定义颜色变量
$color-black = #333
$color-red = #ff0000

// 编写样式
.msg
  width 100%
  p
    color $color-black
    font-size 14px
    span
      color $color-red
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>编译后的css代码：</p><div class="language-css ext-css line-numbers-mode"><pre class="language-css"><code><span class="token selector">.msg</span> <span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.msg p</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #333<span class="token punctuation">;</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.msg p span</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #ff0000<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>预处理器也支持 <code>scoped</code>，用法请查阅 <a href="#%E6%A0%B7%E5%BC%8F%E8%A1%A8%E7%9A%84%E7%BB%84%E4%BB%B6%E4%BD%9C%E7%94%A8%E5%9F%9F">样式表的组件作用域</a> 部分。</p><h2 id="本章结语" tabindex="-1"><a class="header-anchor" href="#本章结语" aria-hidden="true">#</a> 本章结语</h2><p>来到这里，关于组件的基础构成和写法风格，以及数据、函数的定义和使用，相信大家基本上有一定的了解了。</p><p>这一章内容不多，但非常重要，了解组件的基础写法关系着你后续在开发过程中，能否合理的掌握数据获取和呈现之间的关系，以及什么功能应该放在哪个生命周期调用等等，所谓磨刀不误砍柴工。</p><!----><!----><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/chengpeiquan/learning-vue3/edit/main/docs/component.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page"><!--[--><!--]--> Edit this page <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: chengpeiquan@chengpeiquan.com">chengpeiquan</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/update.html" class="" aria-label="升级与配置"><!--[--><!--]--> 升级与配置 <!--[--><!--]--></a></span><span class="next"><a href="/router.html" class="" aria-label="路由的使用"><!--[--><!--]--> 路由的使用 <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.0c7b3152.js" defer></script>
  </body>
</html>
